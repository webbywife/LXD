<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
<title>Admin Panel - SKOOLED-AI</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&family=Open+Sans:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root{--c1:#00bbd6;--c1d:#009bb3;--c2:#237194;--c2d:#1a5670;--accent:#faa32b;--accent-lt:#fff8ed;--white:#ffffff;--text:#2d3436;--text-s:#636e72;--border:#dfe6e9;--bg:#f1f1f2;--success:#00b894;--danger:#e74c3c;--warning:#fdcb6e;}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Open Sans',sans-serif;background:var(--bg);color:var(--text);line-height:1.6;}
h1,h2,h3{font-family:'Poppins',sans-serif;}

.hdr{background:linear-gradient(135deg,var(--c2) 0%,var(--c1) 100%);color:#fff;padding:18px 30px;display:flex;align-items:center;justify-content:space-between;}
.hdr h1{font-size:18px;font-weight:800;}
.hdr-links{display:flex;gap:10px;}
.hdr-links a{color:#fff;font-size:13px;opacity:0.85;text-decoration:none;padding:5px 12px;border-radius:6px;transition:.2s;}
.hdr-links a:hover{opacity:1;background:rgba(255,255,255,0.15);}

.cnt{max-width:960px;margin:0 auto;padding:24px 16px;}

.flash{padding:10px 14px;border-radius:8px;font-size:13px;margin-bottom:16px;}
.flash-error{background:#ffeaea;color:var(--danger);border:1px solid #f5c6c6;}
.flash-success{background:#e8f8f5;color:var(--success);border:1px solid #b8e6d8;}

/* Stats */
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:24px;}
@media(max-width:600px){.stats{grid-template-columns:1fr 1fr;}}
.stat{background:var(--white);border-radius:12px;padding:20px;text-align:center;border:1px solid var(--border);box-shadow:0 2px 8px rgba(0,0,0,0.04);}
.stat-n{font-size:28px;font-weight:800;font-family:'Poppins',sans-serif;}
.stat-l{font-size:12px;color:var(--text-s);font-weight:600;margin-top:2px;}
.stat-total .stat-n{color:var(--c2);}
.stat-pending .stat-n{color:var(--accent);}
.stat-approved .stat-n{color:var(--success);}
.stat-admin .stat-n{color:var(--c1);}

/* Table */
.crd{background:var(--white);border-radius:12px;padding:24px;box-shadow:0 2px 8px rgba(0,0,0,0.04);border:1px solid var(--border);}
.crd-t{font-size:18px;font-weight:700;margin-bottom:16px;color:var(--c2);}
table{width:100%;border-collapse:collapse;font-size:13px;}
th{background:var(--c2);color:#fff;padding:10px 14px;text-align:left;font-family:'Poppins',sans-serif;font-weight:600;font-size:12px;}
td{padding:10px 14px;border-bottom:1px solid var(--border);}
tr:hover td{background:#f8fbfc;}
.badge{display:inline-block;padding:2px 10px;border-radius:12px;font-size:11px;font-weight:700;}
.badge-pending{background:#fef3cd;color:#856404;}
.badge-approved{background:#d4edda;color:#155724;}
.badge-rejected{background:#f8d7da;color:#721c24;}
.badge-admin{background:#d1ecf1;color:#0c5460;}
.badge-user{background:#e2e3e5;color:#383d41;}
.act-btn{padding:4px 10px;border-radius:6px;font-size:11px;font-weight:600;border:1px solid var(--border);background:#fff;cursor:pointer;transition:.2s;font-family:'Poppins',sans-serif;}
.act-btn:hover{border-color:var(--c1);}
.act-btn-approve{color:var(--success);border-color:var(--success);}
.act-btn-approve:hover{background:var(--success);color:#fff;}
.act-btn-reject{color:var(--danger);border-color:var(--danger);}
.act-btn-reject:hover{background:var(--danger);color:#fff;}
.act-btn-role{color:var(--c1);border-color:var(--c1);}
.act-btn-role:hover{background:var(--c1);color:#fff;}
.actions{display:flex;gap:4px;flex-wrap:wrap;}

.ft{text-align:center;padding:18px;font-size:11px;color:var(--text-s);border-top:1px solid var(--border);margin-top:30px;}
.stat-ratings .stat-n{color:var(--accent);}
.stat-avg .stat-n{color:var(--success);}
.stars{color:var(--accent);font-size:14px;letter-spacing:1px;}

@media(max-width:768px){
    table{font-size:12px;}
    th,td{padding:7px 8px;}
    .cnt{padding:16px 10px;}
}
</style>
</head>
<body>

<div class="hdr">
    <h1>Admin Panel</h1>
    <div class="hdr-links">
        <a href="{{ url_for('landing') }}">Home</a>
        <a href="{{ turl('generator') }}">Generator</a>
        <a href="{{ url_for('auth.logout') }}">Logout</a>
    </div>
</div>

<div class="cnt">
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="flash flash-{{ category }}">{{ message }}</div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    <!-- Stats -->
    <div class="stats">
        <div class="stat stat-total">
            <div class="stat-n">{{ stats.total }}</div>
            <div class="stat-l">Total Users</div>
        </div>
        <div class="stat stat-pending">
            <div class="stat-n">{{ stats.pending }}</div>
            <div class="stat-l">Pending Approval</div>
        </div>
        <div class="stat stat-approved">
            <div class="stat-n">{{ stats.approved }}</div>
            <div class="stat-l">Approved</div>
        </div>
        <div class="stat stat-admin">
            <div class="stat-n">{{ stats.admins }}</div>
            <div class="stat-l">Admins</div>
        </div>
    </div>

    <!-- Rating Stats -->
    <div class="stats" style="grid-template-columns:1fr 1fr;max-width:400px;margin-bottom:16px;">
        <div class="stat stat-ratings">
            <div class="stat-n">{{ rating_stats.total_ratings if rating_stats is defined else 0 }}</div>
            <div class="stat-l">Total Ratings</div>
        </div>
        <div class="stat stat-avg">
            <div class="stat-n">{{ rating_stats.avg_rating if rating_stats is defined else 0 }}</div>
            <div class="stat-l">Avg Rating / 5</div>
        </div>
    </div>

    <!-- Users Table -->
    <div class="crd">
        <div class="crd-t">User Management</div>
        <div style="overflow-x:auto;">
        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Status</th>
                    <th>Joined</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td><strong>{{ user.name }}</strong></td>
                    <td>{{ user.email }}</td>
                    <td><span class="badge badge-{{ user.role }}">{{ user.role }}</span></td>
                    <td><span class="badge badge-{{ user.status }}">{{ user.status }}</span></td>
                    <td>{{ user.created_at.strftime('%b %d, %Y') if user.created_at else '-' }}</td>
                    <td>
                        <div class="actions">
                        {% if user.status == 'pending' %}
                            <form method="POST" action="{{ turl('auth.admin_approve', user_id=user.id) }}" style="display:inline;">
                                <button type="submit" class="act-btn act-btn-approve">Approve</button>
                            </form>
                            <form method="POST" action="{{ turl('auth.admin_reject', user_id=user.id) }}" style="display:inline;">
                                <button type="submit" class="act-btn act-btn-reject">Reject</button>
                            </form>
                        {% endif %}
                        {% if user.id != session.get('user_id') and user.status == 'approved' %}
                            <form method="POST" action="{{ turl('auth.admin_toggle_role', user_id=user.id) }}" style="display:inline;">
                                <button type="submit" class="act-btn act-btn-role">
                                    {% if user.role == 'user' %}Make Admin{% else %}Make User{% endif %}
                                </button>
                            </form>
                        {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        </div>
    </div>
</div>

    <!-- Ratings Table -->
    {% if ratings is defined and ratings %}
    <div class="crd" style="margin-top:20px;">
        <div class="crd-t">Lesson Plan Ratings &amp; Feedback</div>
        <div style="overflow-x:auto;">
        <table>
            <thead>
                <tr>
                    <th>Teacher</th>
                    <th>Rating</th>
                    <th>Comment</th>
                    <th>Subject</th>
                    <th>Grade</th>
                    <th>Mode</th>
                    <th>Date</th>
                </tr>
            </thead>
            <tbody>
                {% for r in ratings %}
                <tr>
                    <td><strong>{{ r.user_name }}</strong></td>
                    <td><span class="stars">{% for i in range(r.rating) %}&#9733;{% endfor %}{% for i in range(5 - r.rating) %}&#9734;{% endfor %}</span></td>
                    <td>{{ r.comment or '-' }}</td>
                    <td>{{ r.subject or '-' }}</td>
                    <td>{{ r.grade or '-' }}</td>
                    <td><span class="badge {{ 'badge-approved' if r.gen_mode == 'topic' else 'badge-user' }}">{{ r.gen_mode }}</span></td>
                    <td>{{ r.created_at.strftime('%b %d, %Y') if r.created_at else '-' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        </div>
    </div>
    {% endif %}
</div>

<div class="ft">SKOOLED-AI Admin Panel &bull; Logged in as {{ session.get('user_name', 'Admin') }}</div>
</body>
</html>
