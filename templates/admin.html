<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
<title>Admin Panel — SKOOLED-AI</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root{
    --accent:#00bbd6;--accent-d:#009bb3;
    --accent-dim:rgba(0,187,214,0.14);--accent-border:rgba(0,187,214,0.35);
    --navy:#0d1f2d;--navy-d:#081520;
    --bg:#f0f9fb;--text:#0d1f2d;--text-s:rgba(13,31,45,0.56);
    --glass:rgba(255,255,255,0.72);--glass-b:rgba(0,187,214,0.2);
    --border:#c8e8ee;
    --success:#00b894;--danger:#e74c3c;--warning:#fdcb6e;--warm:#faa32b;
    --rad:18px;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{
    font-family:'Plus Jakarta Sans',sans-serif;
    background:var(--bg);color:var(--text);line-height:1.65;
    background-image:radial-gradient(ellipse 90% 45% at 50% -8%,rgba(0,187,214,0.1) 0%,transparent 65%);
    background-attachment:fixed;
}
h1,h2,h3,.grotesk{font-family:'Space Grotesk',sans-serif;}
a{text-decoration:none;color:inherit;}

/* Header */
.hdr{
    background:linear-gradient(135deg,var(--navy) 0%,#1b4a6e 55%,var(--accent) 100%);
    color:#fff;padding:16px 30px;
    display:flex;align-items:center;justify-content:space-between;
}
.hdr-brand{display:flex;align-items:center;gap:10px;}
.hdr-icon{
    width:32px;height:32px;border-radius:10px;background:rgba(255,255,255,0.15);
    display:flex;align-items:center;justify-content:center;font-size:16px;
    border:1px solid rgba(255,255,255,0.2);
}
.hdr h1{font-family:'Space Grotesk',sans-serif;font-size:17px;font-weight:800;letter-spacing:-0.03em;}
.hdr-links{display:flex;gap:6px;}
.hdr-links a{
    color:#fff;font-size:12px;font-weight:600;opacity:0.8;
    padding:6px 14px;border-radius:30px;transition:.2s;
    border:1px solid transparent;
}
.hdr-links a:hover{opacity:1;background:rgba(255,255,255,0.12);border-color:rgba(255,255,255,0.2);}

.cnt{max-width:1000px;margin:0 auto;padding:24px 16px 48px;}

/* Flash */
.flash{padding:10px 14px;border-radius:10px;font-size:13px;margin-bottom:16px;}
.flash-error{background:rgba(231,76,60,0.09);color:var(--danger);border:1px solid rgba(231,76,60,0.25);}
.flash-success{background:rgba(0,184,148,0.09);color:var(--success);border:1px solid rgba(0,184,148,0.25);}

/* Section label */
.sec-label{
    font-size:10px;font-weight:700;letter-spacing:.42em;text-transform:uppercase;
    color:var(--accent);margin-bottom:12px;display:block;
}

/* Stats grid */
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px;}
@media(max-width:640px){.stats{grid-template-columns:1fr 1fr;}}
.stat{
    background:var(--glass);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);
    border:1px solid var(--glass-b);border-radius:var(--rad);
    padding:20px 18px;text-align:center;
    box-shadow:0 2px 16px rgba(0,187,214,0.06);
    transition:border-color .2s,transform .2s;
}
.stat:hover{border-color:var(--accent-border);transform:translateY(-2px);}
.stat-n{font-family:'Space Grotesk',sans-serif;font-size:30px;font-weight:800;line-height:1;margin-bottom:5px;}
.stat-l{font-size:11px;font-weight:600;color:var(--text-s);letter-spacing:.03em;}
.stat-total .stat-n{color:var(--navy);}
.stat-pending .stat-n{color:var(--warm);}
.stat-approved .stat-n{color:var(--success);}
.stat-admin .stat-n{color:var(--accent);}
.stat-ratings .stat-n{color:var(--warm);}
.stat-avg .stat-n{color:var(--success);}
.stat-gen .stat-n{color:#9b59b6;}
.stat-dl .stat-n{color:#3498db;}
.action-chip{display:inline-block;padding:2px 8px;border-radius:12px;font-size:10px;font-weight:700;letter-spacing:.03em;}
.chip-lesson{background:rgba(0,187,214,0.12);color:#005f72;}
.chip-topic{background:rgba(155,89,182,0.12);color:#6c3483;}
.chip-assessment{background:rgba(250,163,43,0.13);color:#7a5200;}
.chip-quiz{background:rgba(0,184,148,0.12);color:#006b54;}
.chip-download{background:rgba(52,152,219,0.12);color:#1a5276;}

/* Card */
.crd{
    background:var(--glass);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);
    border:1px solid var(--glass-b);border-radius:var(--rad);
    padding:24px;
    box-shadow:0 2px 20px rgba(0,187,214,0.06);
    margin-bottom:16px;
}
.crd-t{
    font-family:'Space Grotesk',sans-serif;font-size:17px;font-weight:700;
    margin-bottom:16px;color:var(--navy);letter-spacing:-0.02em;
}

/* Table */
table{width:100%;border-collapse:collapse;font-size:13px;}
th{
    background:var(--navy);color:#fff;
    padding:10px 14px;text-align:left;
    font-family:'Space Grotesk',sans-serif;font-weight:600;font-size:11px;
    letter-spacing:.05em;text-transform:uppercase;
}
th:first-child{border-radius:8px 0 0 0;}
th:last-child{border-radius:0 8px 0 0;}
td{padding:10px 14px;border-bottom:1px solid rgba(0,187,214,0.08);vertical-align:middle;}
tr:last-child td{border-bottom:none;}
tr:hover td{background:rgba(0,187,214,0.04);}

/* Badges */
.badge{display:inline-block;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:700;letter-spacing:.03em;}
.badge-pending{background:rgba(250,163,43,0.13);color:#7a5200;border:1px solid rgba(250,163,43,0.3);}
.badge-approved{background:rgba(0,184,148,0.12);color:#006b54;border:1px solid rgba(0,184,148,0.3);}
.badge-rejected{background:rgba(231,76,60,0.1);color:#8b1a0f;border:1px solid rgba(231,76,60,0.25);}
.badge-admin{background:rgba(0,187,214,0.12);color:#005f72;border:1px solid rgba(0,187,214,0.3);}
.badge-user{background:rgba(13,31,45,0.07);color:var(--navy);border:1px solid rgba(13,31,45,0.12);}
.badge-curriculum{background:rgba(13,31,45,0.07);color:var(--navy);border:1px solid rgba(13,31,45,0.12);}
.badge-topic{background:rgba(0,187,214,0.12);color:#005f72;border:1px solid rgba(0,187,214,0.3);}

/* Action buttons */
.actions{display:flex;gap:4px;flex-wrap:wrap;}
.act-btn{
    padding:4px 12px;border-radius:20px;font-size:11px;font-weight:600;
    border:1.5px solid var(--glass-b);background:rgba(255,255,255,0.7);
    cursor:pointer;transition:.2s;font-family:'Space Grotesk',sans-serif;
    color:var(--navy);
}
.act-btn:hover{border-color:var(--accent-border);}
.act-btn-approve{color:var(--success);border-color:rgba(0,184,148,0.35);}
.act-btn-approve:hover{background:var(--success);color:#fff;border-color:var(--success);}
.act-btn-reject{color:var(--danger);border-color:rgba(231,76,60,0.3);}
.act-btn-reject:hover{background:var(--danger);color:#fff;border-color:var(--danger);}
.act-btn-role{color:var(--accent);border-color:rgba(0,187,214,0.35);}
.act-btn-role:hover{background:var(--accent);color:var(--navy);border-color:var(--accent);}

/* Stars */
.stars{color:var(--warm);font-size:13px;letter-spacing:1px;}

.ft{text-align:center;padding:18px;font-size:11px;color:var(--text-s);border-top:1px solid var(--glass-b);margin-top:12px;letter-spacing:.04em;font-weight:500;}

@media(max-width:768px){table{font-size:12px;}th,td{padding:8px 10px;}.cnt{padding:16px 10px;}}
</style>
</head>
<body>

<div class="hdr">
    <div class="hdr-brand">
        <div class="hdr-icon">&#129302;</div>
        <h1>Admin Panel</h1>
    </div>
    <div class="hdr-links">
        <a href="{{ url_for('landing') }}">Home</a>
        <a href="{{ turl('generator') }}">Generator</a>
        <a href="{{ url_for('auth.logout') }}">Logout</a>
    </div>
</div>

<div class="cnt">
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="flash flash-{{ category }}">{{ message }}</div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    <!-- User Stats -->
    <span class="sec-label">Overview</span>
    <div class="stats">
        <div class="stat stat-total">
            <div class="stat-n">{{ stats.total }}</div>
            <div class="stat-l">Total Users</div>
        </div>
        <div class="stat stat-pending">
            <div class="stat-n">{{ stats.pending }}</div>
            <div class="stat-l">Pending Approval</div>
        </div>
        <div class="stat stat-approved">
            <div class="stat-n">{{ stats.approved }}</div>
            <div class="stat-l">Approved</div>
        </div>
        <div class="stat stat-admin">
            <div class="stat-n">{{ stats.admins }}</div>
            <div class="stat-l">Admins</div>
        </div>
    </div>

    <!-- Activity Stats -->
    <span class="sec-label" style="margin-top:8px;display:block;">Activity</span>
    <div class="stats" style="grid-template-columns:repeat(4,1fr);margin-bottom:12px;">
        <div class="stat stat-gen">
            <div class="stat-n">{{ activity_stats.generations if activity_stats is defined else 0 }}</div>
            <div class="stat-l">Lessons Generated</div>
        </div>
        <div class="stat stat-dl">
            <div class="stat-n">{{ activity_stats.downloads if activity_stats is defined else 0 }}</div>
            <div class="stat-l">Downloads</div>
        </div>
        <div class="stat stat-ratings">
            <div class="stat-n">{{ rating_stats.total_ratings if rating_stats is defined else 0 }}</div>
            <div class="stat-l">Ratings Submitted</div>
        </div>
        <div class="stat stat-avg">
            <div class="stat-n">{{ rating_stats.avg_rating if rating_stats is defined else 0 }}</div>
            <div class="stat-l">Avg Rating / 5</div>
        </div>
    </div>
    {% if activity_stats is defined and activity_stats.by_type %}
    <div class="crd" style="margin-bottom:16px;">
        <div class="crd-t">Breakdown by Action</div>
        <div style="display:flex;flex-wrap:wrap;gap:10px;">
        {% for action, count in activity_stats.by_type.items() %}
            {% set chip_class = 'chip-download' if 'download' in action else ('chip-quiz' if 'quiz' in action else ('chip-assessment' if 'assessment' in action else ('chip-topic' if 'topic' in action else 'chip-lesson'))) %}
            <div style="background:var(--glass);border:1px solid var(--glass-b);border-radius:10px;padding:10px 16px;text-align:center;min-width:120px;">
                <div style="font-family:'Space Grotesk',sans-serif;font-size:22px;font-weight:800;color:var(--navy);">{{ count }}</div>
                <div style="margin-top:4px;"><span class="action-chip {{ chip_class }}">{{ action.replace('_',' ').title() }}</span></div>
            </div>
        {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Users Table -->
    <span class="sec-label">User Management</span>
    <div class="crd">
        <div class="crd-t">Registered Users</div>
        <div style="overflow-x:auto;">
        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Role</th>
                    <th>Status</th>
                    <th>Joined</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td><strong>{{ user.name }}</strong></td>
                    <td style="color:var(--text-s);">{{ user.email }}</td>
                    <td><span class="badge badge-{{ user.role }}">{{ user.role }}</span></td>
                    <td><span class="badge badge-{{ user.status }}">{{ user.status }}</span></td>
                    <td style="color:var(--text-s);font-size:12px;">{{ user.created_at.strftime('%b %d, %Y') if user.created_at else '—' }}</td>
                    <td>
                        <div class="actions">
                        {% if user.status == 'pending' %}
                            <form method="POST" action="{{ turl('auth.admin_approve', user_id=user.id) }}" style="display:inline;">
                                <button type="submit" class="act-btn act-btn-approve">Approve</button>
                            </form>
                            <form method="POST" action="{{ turl('auth.admin_reject', user_id=user.id) }}" style="display:inline;">
                                <button type="submit" class="act-btn act-btn-reject">Reject</button>
                            </form>
                        {% endif %}
                        {% if user.id != session.get('user_id') and user.status == 'approved' %}
                            <form method="POST" action="{{ turl('auth.admin_toggle_role', user_id=user.id) }}" style="display:inline;">
                                <button type="submit" class="act-btn act-btn-role">
                                    {% if user.role == 'user' %}Make Admin{% else %}Make User{% endif %}
                                </button>
                            </form>
                        {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        </div>
    </div>

    <!-- Ratings Table -->
    <!-- Per-User Activity Summary -->
    {% if user_activity is defined and user_activity %}
    <span class="sec-label" style="margin-top:24px;display:block;">Activity per Teacher</span>
    <div class="crd">
        <div class="crd-t">Usage by Teacher</div>
        <div style="overflow-x:auto;">
        <table>
            <thead>
                <tr>
                    <th>Teacher</th>
                    <th>Lessons Generated</th>
                    <th>Downloads</th>
                    <th>Total Actions</th>
                    <th>Last Active</th>
                </tr>
            </thead>
            <tbody>
                {% for u in user_activity %}
                <tr>
                    <td><strong>{{ u.user_name }}</strong></td>
                    <td>{{ u.generations or 0 }}</td>
                    <td>{{ u.downloads or 0 }}</td>
                    <td><strong>{{ u.total }}</strong></td>
                    <td style="color:var(--text-s);font-size:12px;">{{ u.last_active.strftime('%b %d, %Y %H:%M') if u.last_active else '—' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        </div>
    </div>
    {% endif %}

    <!-- Recent Activity Log -->
    {% if activity_log is defined and activity_log %}
    <span class="sec-label" style="margin-top:24px;display:block;">Recent Activity Log</span>
    <div class="crd">
        <div class="crd-t">Last 100 Actions</div>
        <div style="overflow-x:auto;">
        <table>
            <thead>
                <tr>
                    <th>Teacher</th>
                    <th>Action</th>
                    <th>Detail / Topic</th>
                    <th>Subject</th>
                    <th>Grade</th>
                    <th>Date &amp; Time</th>
                </tr>
            </thead>
            <tbody>
                {% for a in activity_log %}
                <tr>
                    <td><strong>{{ a.user_name }}</strong></td>
                    <td>
                        {% set chip_class = 'chip-download' if 'download' in a.action_type else ('chip-quiz' if 'quiz' in a.action_type else ('chip-assessment' if 'assessment' in a.action_type else ('chip-topic' if 'topic' in a.action_type else 'chip-lesson'))) %}
                        <span class="action-chip {{ chip_class }}">{{ a.action_type.replace('_',' ').title() }}</span>
                    </td>
                    <td style="font-size:12px;max-width:200px;color:var(--text-s);">{{ a.detail or '—' }}</td>
                    <td style="font-size:12px;">{{ a.subject or '—' }}</td>
                    <td style="font-size:12px;">{{ a.grade or '—' }}</td>
                    <td style="color:var(--text-s);font-size:12px;">{{ a.created_at.strftime('%b %d %H:%M') if a.created_at else '—' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        </div>
    </div>
    {% endif %}

    {% if ratings is defined and ratings %}
    <span class="sec-label" style="margin-top:24px;display:block;">Lesson Feedback</span>
    <div class="crd">
        <div class="crd-t">Lesson Plan Ratings &amp; Feedback</div>
        <div style="overflow-x:auto;">
        <table>
            <thead>
                <tr>
                    <th>Teacher</th>
                    <th>Rating</th>
                    <th>Comment</th>
                    <th>Subject</th>
                    <th>Grade</th>
                    <th>Mode</th>
                    <th>Date</th>
                </tr>
            </thead>
            <tbody>
                {% for r in ratings %}
                <tr>
                    <td><strong>{{ r.user_name }}</strong></td>
                    <td><span class="stars">{% for i in range(r.rating) %}&#9733;{% endfor %}{% for i in range(5 - r.rating) %}&#9734;{% endfor %}</span></td>
                    <td style="color:var(--text-s);font-size:12px;max-width:220px;">{{ r.comment or '—' }}</td>
                    <td style="font-size:12px;">{{ r.subject or '—' }}</td>
                    <td style="font-size:12px;">{{ r.grade or '—' }}</td>
                    <td><span class="badge badge-{{ r.gen_mode }}">{{ r.gen_mode }}</span></td>
                    <td style="color:var(--text-s);font-size:12px;">{{ r.created_at.strftime('%b %d, %Y') if r.created_at else '—' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        </div>
    </div>
    {% endif %}
</div>

<div class="ft">SKOOLED-AI Admin Panel &bull; Logged in as {{ session.get('user_name', 'Admin') }}</div>
</body>
</html>
