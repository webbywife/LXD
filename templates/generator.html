<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="auth-token" content="{{ auth_token }}">
<link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
<title>SKOOLED-AI Lesson Plan Generator</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&family=Lora:wght@400;500;600;700&family=Open+Sans:wght@400;500;600&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
:root {
    --bg: #f1f1f2;
    --c1: #00bbd6;
    --c1d: #009bb3;
    --c2: #237194;
    --c2d: #1a5670;
    --accent: #faa32b;
    --accent-lt: #fff8ed;
    --white: #ffffff;
    --text: #2d3436;
    --text-s: #636e72;
    --border: #dfe6e9;
    --success: #00b894;
    --danger: #e74c3c;
    --rad: 12px;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Open Sans','Roboto',sans-serif;background:var(--bg);color:var(--text);line-height:1.7;}
h1,h2,h3,h4,.poppins{font-family:'Poppins',sans-serif;}

/* Header */
.hdr{background:linear-gradient(135deg,var(--c2) 0%,var(--c1) 100%);color:#fff;padding:22px 30px;text-align:center;position:relative;overflow:hidden;}
.hdr::before{content:'';position:absolute;top:-60px;right:-60px;width:200px;height:200px;background:rgba(255,255,255,0.06);border-radius:50%;}
.hdr::after{content:'';position:absolute;bottom:-40px;left:-40px;width:150px;height:150px;background:rgba(255,255,255,0.04);border-radius:50%;}
.hdr h1{font-size:22px;font-weight:800;letter-spacing:-0.5px;}
.hdr p{font-size:12px;opacity:0.85;margin-top:3px;}
.hdr .stats{display:flex;justify-content:center;gap:12px;margin-top:10px;font-size:11px;flex-wrap:wrap;}
.hdr .st{background:rgba(255,255,255,0.15);padding:3px 12px;border-radius:16px;}

/* Steps */
.steps{display:flex;justify-content:center;gap:0;padding:18px 20px 0;max-width:800px;margin:0 auto;}
.stp{flex:1;text-align:center;position:relative;padding-bottom:10px;}
.stp-n{width:34px;height:34px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;background:#dfe6e9;color:var(--text-s);margin-bottom:4px;transition:.3s;}
.stp.a .stp-n{background:var(--c1);color:#fff;}
.stp.d .stp-n{background:var(--success);color:#fff;}
.stp-l{font-size:11px;font-weight:600;color:var(--text-s);}
.stp.a .stp-l{color:var(--c2);}
.stp.d .stp-l{color:var(--success);}
.stp-ln{position:absolute;top:17px;left:50%;width:100%;height:3px;background:#dfe6e9;z-index:0;}
.stp:last-child .stp-ln{display:none;}
.stp.d .stp-ln{background:var(--success);}

/* Container */
.cnt{max-width:860px;margin:0 auto;padding:18px 16px 40px;}

/* Card */
.crd{background:var(--white);border-radius:var(--rad);padding:26px;box-shadow:0 2px 8px rgba(0,0,0,0.05);border:1px solid var(--border);margin-bottom:16px;}
.crd-t{font-size:18px;font-weight:700;margin-bottom:3px;}
.crd-s{font-size:12px;color:var(--text-s);margin-bottom:18px;}

/* Tip */
.tip{display:flex;gap:10px;background:var(--accent-lt);border-left:4px solid var(--accent);border-radius:0 8px 8px 0;padding:10px 14px;margin:12px 0;font-size:12px;align-items:flex-start;line-height:1.5;}
.tip .ti{font-size:18px;flex-shrink:0;}
.tip .tt{color:#5a4310;}

/* Step Panels */
.sp{display:none;}.sp.a{display:block;}

/* Form */
.fr{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px;}
@media(max-width:600px){.fr{grid-template-columns:1fr;}}
.fg{margin-bottom:14px;}
.fg label{display:block;font-size:12px;font-weight:600;margin-bottom:4px;font-family:'Poppins',sans-serif;color:var(--c2);}
.fg .hn{font-size:11px;color:var(--text-s);margin-top:2px;}
select,input[type="text"],input[type="password"],textarea{width:100%;padding:10px 14px;font-size:13px;font-family:inherit;border:2px solid var(--border);border-radius:8px;background:#fff;transition:border-color .2s;}
select:focus,input:focus,textarea:focus{outline:none;border-color:var(--c1);}
select:disabled{background:#f5f6fa;opacity:.6;}
textarea{resize:vertical;min-height:60px;}

/* Buttons */
.btn{padding:10px 22px;border-radius:8px;font-size:13px;font-weight:600;border:2px solid var(--border);background:#fff;cursor:pointer;transition:.2s;font-family:'Poppins',sans-serif;}
.btn:hover{border-color:var(--c1);}
.btn-p{background:var(--c1);color:#fff;border-color:var(--c1);}
.btn-p:hover{background:var(--c1d);}
.btn-p:disabled{opacity:.5;cursor:not-allowed;}
.btn-g{background:var(--accent);color:#fff;border-color:var(--accent);padding:14px 32px;font-size:15px;font-weight:700;}
.btn-g:hover{background:#e8922a;}
.btn-g:disabled{opacity:.5;cursor:not-allowed;}
.btn-s2{background:var(--c2);color:#fff;border-color:var(--c2);}
.btn-s2:hover{background:var(--c2d);}
.btn-sm{padding:5px 12px;font-size:11px;}
.br{display:flex;justify-content:space-between;margin-top:22px;gap:10px;}

/* Competencies */
.cg{max-height:380px;overflow-y:auto;border:1px solid var(--border);border-radius:10px;}
.cc{display:flex;gap:10px;padding:10px 14px;border-bottom:1px solid #f5f6fa;cursor:pointer;transition:background .15s;align-items:flex-start;}
.cc:hover{background:#f0fcfe;}.cc.sel{background:#e0f7fa;}
.cc:last-child{border-bottom:none;}
.cc input{margin-top:3px;transform:scale(1.15);accent-color:var(--c1);}
.cc-c{font-size:10px;font-weight:700;color:var(--c1);}
.cc-d{font-size:12px;line-height:1.5;}
.cc-m{font-size:10px;color:var(--text-s);margin-top:2px;}
.sb{display:flex;justify-content:space-between;align-items:center;padding:6px 0;margin-bottom:6px;}
.sc{font-size:13px;font-weight:700;color:var(--c2);}

/* Toggles */
.tc{display:flex;align-items:center;gap:12px;padding:12px 16px;border:2px solid var(--border);border-radius:10px;margin-bottom:8px;cursor:pointer;transition:.2s;}
.tc:hover{border-color:var(--c1);}
.tc.on{border-color:var(--c1);background:#f0fcfe;}
.tc-i{font-size:20px;flex-shrink:0;width:32px;text-align:center;}
.tc-n{font-size:13px;font-weight:600;flex:1;}
.tc-ck{width:20px;height:20px;border-radius:5px;border:2px solid #b2bec3;display:flex;align-items:center;justify-content:center;font-size:13px;color:#fff;transition:.2s;flex-shrink:0;}
.tc.on .tc-ck{background:var(--c1);border-color:var(--c1);}
.tc-x{background:none;border:none;cursor:pointer;font-size:16px;color:var(--text-s);padding:2px 6px;transition:transform .2s;flex-shrink:0;}
.tc-x.op{transform:rotate(180deg);}
.to{display:none;padding:14px 16px;margin:-8px 0 8px;border:2px solid var(--border);border-top:none;border-radius:0 0 10px 10px;background:#fafbfc;}
.to.op{display:block;}

/* Model Cards */
.mg{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
@media(max-width:600px){.mg{grid-template-columns:1fr;}}
.mc{padding:12px;border:2px solid var(--border);border-radius:10px;cursor:pointer;transition:.2s;text-align:center;}
.mc:hover{border-color:var(--c1);}
.mc.sel{border-color:var(--c1);background:#e0f7fa;}
.mc-n{font-size:12px;font-weight:700;font-family:'Poppins',sans-serif;}
.mc-d{font-size:10px;color:var(--text-s);margin-top:2px;}

/* Assessment Types */
.at-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
@media(max-width:600px){.at-grid{grid-template-columns:1fr;}}
.at{padding:10px 14px;border:2px solid var(--border);border-radius:10px;cursor:pointer;transition:.2s;display:flex;align-items:center;gap:10px;}
.at:hover{border-color:var(--accent);}
.at.on{border-color:var(--accent);background:var(--accent-lt);}
.at-i{font-size:20px;flex-shrink:0;}
.at-n{font-size:12px;font-weight:600;}
.at-d{font-size:10px;color:var(--text-s);}

/* Switch */
.sw{position:relative;width:42px;height:22px;flex-shrink:0;}
.sw input{opacity:0;width:0;height:0;}
.sl{position:absolute;top:0;left:0;right:0;bottom:0;background:#b2bec3;border-radius:22px;cursor:pointer;transition:.3s;}
.sl:before{content:"";position:absolute;height:16px;width:16px;left:3px;bottom:3px;background:#fff;border-radius:50%;transition:.3s;}
.sw input:checked+.sl{background:var(--c1);}
.sw input:checked+.sl:before{transform:translateX(20px);}

/* Progress */
.po{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(29,78,120,0.85);z-index:1000;justify-content:center;align-items:center;}
.po.a{display:flex;}
.pb{background:#fff;border-radius:20px;padding:40px 44px;text-align:center;max-width:420px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,.3);}
.pb-t{font-size:18px;font-weight:700;font-family:'Poppins',sans-serif;margin-bottom:6px;}
.pb-s{font-size:12px;color:var(--text-s);margin-bottom:22px;}
.pb-p{font-size:36px;font-weight:800;color:var(--c1);margin-bottom:4px;font-family:'Poppins',sans-serif;}
.pb-bg{width:100%;height:10px;background:#ecf0f1;border-radius:5px;overflow:hidden;margin-bottom:10px;}
.pb-fl{height:100%;background:linear-gradient(90deg,var(--c1),var(--accent));border-radius:5px;transition:width .4s;width:0%;}
.pb-st{font-size:11px;color:var(--text-s);min-height:16px;}

/* Output */
.ob{background:#fff;border:1px solid var(--border);border-radius:12px;padding:28px;max-height:70vh;overflow-y:auto;line-height:1.8;font-size:14px;}
.ob h1{font-family:'Poppins',sans-serif;font-size:24px;font-weight:800;color:var(--c2);margin:24px 0 14px;padding-bottom:8px;border-bottom:3px solid var(--c1);text-align:center;background:linear-gradient(90deg,var(--c1),var(--c2));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;}
.ob h2{font-family:'Poppins',sans-serif;font-size:18px;font-weight:700;color:var(--c2);margin:22px 0 10px;padding:10px 16px;border-left:4px solid var(--c1);background:#f0fcfe;border-radius:0 8px 8px 0;}
.ob h3{font-family:'Poppins',sans-serif;font-size:15px;font-weight:600;color:var(--c2d);margin:16px 0 8px;padding-left:8px;border-left:3px solid var(--accent);}
.ob h4{font-family:'Poppins',sans-serif;font-size:14px;font-weight:600;color:var(--c2);margin:12px 0 6px;}
.ob table{width:100%;border-collapse:collapse;margin:10px 0;font-size:12px;border-radius:8px;overflow:hidden;}
.ob th{background:var(--c2);color:#fff;padding:10px 14px;font-family:'Poppins',sans-serif;font-weight:600;text-align:left;}
.ob td{padding:8px 14px;border:1px solid var(--border);}
.ob tr:nth-child(even) td{background:#f8fffe;}
.ob td:first-child{font-weight:600;color:var(--c2);}
.ob ul,.ob ol{padding-left:22px;margin:8px 0;}
.ob li{margin-bottom:5px;font-size:13px;line-height:1.6;}
.ob blockquote{border-left:4px solid var(--accent);background:var(--accent-lt);padding:12px 18px;border-radius:0 8px 8px 0;margin:12px 0;font-size:12px;}
.ob hr{border:none;height:3px;background:linear-gradient(90deg,var(--c1),var(--accent),var(--c2));border-radius:2px;margin:24px 0;}
.ob em{color:var(--text-s);}
.ob p{margin:6px 0;}

/* Section Tabs (within output) */
.section-tabs{display:flex;gap:4px;padding:8px 0 14px;overflow-x:auto;flex-wrap:wrap;}
.section-tab{padding:7px 16px;border-radius:8px;font-size:12px;font-weight:600;border:2px solid var(--border);background:#fff;cursor:pointer;font-family:'Poppins',sans-serif;transition:.2s;white-space:nowrap;}
.section-tab:hover{border-color:var(--c1);background:#f0fcfe;}
.section-tab.active{background:var(--c1);color:#fff;border-color:var(--c1);}
.section-pane{display:none;}
.section-pane.active{display:block;}

/* Quiz Type Grid */
.qt-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
@media(max-width:600px){.qt-grid{grid-template-columns:1fr;}}
.qt{padding:10px 14px;border:2px solid var(--border);border-radius:10px;cursor:pointer;transition:.2s;display:flex;align-items:center;gap:10px;}
.qt:hover{border-color:var(--c1);}
.qt.on{border-color:var(--c1);background:#e0f7fa;}
.qt-n{font-size:12px;font-weight:600;}
.qt-d{font-size:10px;color:var(--text-s);}

.oa{display:flex;gap:8px;margin-top:16px;justify-content:center;flex-wrap:wrap;}
.tabs{display:none;margin-bottom:14px;gap:4px;}
.tabs.on{display:flex;}
.tab{padding:7px 18px;border-radius:8px;font-size:12px;font-weight:600;border:2px solid var(--border);background:#fff;cursor:pointer;font-family:'Poppins',sans-serif;transition:.2s;}
.tab.a{background:var(--c2);color:#fff;border-color:var(--c2);}
.mode-tab{padding:9px 18px;border-radius:8px;font-size:13px;font-weight:600;border:2px solid var(--border);background:#fff;cursor:pointer;font-family:'Poppins',sans-serif;transition:.2s;flex:1;text-align:center;}
.mode-tab:hover{border-color:var(--c1);}
.mode-tab.a{background:var(--c1);color:#fff;border-color:var(--c1);}
.star{cursor:pointer;color:#dfe6e9;font-size:28px;transition:color .15s;}

.ft{text-align:center;padding:18px;font-size:11px;color:var(--text-s);border-top:1px solid var(--border);margin-top:20px;}

@media print{.hdr,.steps,.br,.oa,.tabs,.ft,.sp:not(#step4),.section-tabs{display:none!important;}.ob{max-height:none;overflow:visible;box-shadow:none;border:none;}.section-pane{display:block!important;}}

/* Scrollbar */
::-webkit-scrollbar{width:5px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:#b2bec3;border-radius:3px;}
</style>
</head>
<body>

<div style="background:var(--c2d);color:#fff;padding:6px 20px;display:flex;justify-content:space-between;align-items:center;font-size:12px;">
    <span>Welcome, <strong>{{ session.get('user_name', 'User') }}</strong></span>
    <div style="display:flex;gap:12px;">
        <a href="{{ url_for('landing') }}" style="color:#fff;opacity:0.8;text-decoration:none;">Home</a>
        {% if session.get('user_role') == 'admin' %}
        <a href="{{ turl('auth.admin_panel') }}" style="color:#fff;opacity:0.8;text-decoration:none;">Admin</a>
        {% endif %}
        <a href="{{ url_for('auth.logout') }}" style="color:#fff;opacity:0.8;text-decoration:none;">Logout</a>
    </div>
</div>
<div class="hdr">
    <h1>SKOOLED-AI Lesson Plan Generator</h1>
    <p>DepEd-Aligned Curriculum Content Development System</p>
    <div class="stats">
        <span class="st">&#128218; 3,400+ Competencies</span>
        <span class="st">&#128214; 13 Subjects</span>
        <span class="st">&#127891; Grades K-10</span>
        <span class="st">&#128230; SCORM 1.2 Ready</span>
    </div>
</div>

<div class="steps">
    <div class="stp a" id="si1"><div class="stp-ln"></div><div class="stp-n">1</div><div class="stp-l">Curriculum</div></div>
    <div class="stp" id="si2"><div class="stp-ln"></div><div class="stp-n">2</div><div class="stp-l">Competencies</div></div>
    <div class="stp" id="si3"><div class="stp-ln"></div><div class="stp-n">3</div><div class="stp-l">Customize</div></div>
    <div class="stp" id="si4"><div class="stp-n">4</div><div class="stp-l">Output</div></div>
</div>

<div class="cnt">

<!-- STEP 1 -->
<div class="sp a" id="step1">
<div class="crd">
    <div class="crd-t">&#128204; Step 1: Choose Your Approach</div>
    <div class="crd-s">Select from the MATATAG curriculum or enter a custom topic.</div>

    <!-- Mode Tabs -->
    <div style="display:flex;gap:8px;margin-bottom:18px;">
        <button class="mode-tab a" data-mode="curriculum" id="mtab-c">&#128218; Select from Curriculum</button>
        <button class="mode-tab" data-mode="topic" id="mtab-t">&#9998;&#65039; Enter Custom Topic</button>
    </div>

    <!-- Curriculum Mode -->
    <div id="mode-curriculum">
        <div class="tip"><span class="ti">&#128161;</span><span class="tt"><strong>Tip:</strong> Start by selecting the subject area. The grade levels and quarters will automatically load based on available MATATAG curriculum data.</span></div>
        <div class="fg"><label>Subject / Learning Area</label><select id="sel-s"><option value="">-- Choose a Subject --</option>{% for s in subjects %}<option value="{{ s.id }}">{{ s.display_name }}</option>{% endfor %}</select></div>
        <div class="fr">
            <div class="fg"><label>Grade Level</label><select id="sel-g" disabled><option value="">-- Choose Grade --</option></select></div>
            <div class="fg"><label>Quarter</label><select id="sel-q" disabled><option value="">-- Choose Quarter --</option></select></div>
        </div>
    </div>

    <!-- Topic Mode -->
    <div id="mode-topic" style="display:none;">
        <div class="tip"><span class="ti">&#128161;</span><span class="tt"><strong>Tip:</strong> Enter any topic and subject to generate a lesson plan without selecting from the curriculum. Great for custom or supplementary lessons.</span></div>
        <div class="fg"><label>Topic / Lesson Title *</label><input type="text" id="t-topic" placeholder="e.g., The Water Cycle, Fractions, Philippine Independence"></div>
        <div class="fr">
            <div class="fg"><label>Subject / Learning Area *</label><select id="sel-ts"><option value="">-- Choose a Subject --</option>{% for s in subjects %}<option value="{{ s.display_name }}">{{ s.display_name }}</option>{% endfor %}</select></div>
            <div class="fg"><label>Grade Level *</label><input type="text" id="t-grade" placeholder="e.g., Grade 5, Grade 8"></div>
        </div>
        <div class="fg"><label>Learning Competencies / Objectives (optional)</label><textarea id="t-comps" rows="3" placeholder="e.g., Students will identify the stages of the water cycle&#10;Students will explain how evaporation works"></textarea></div>
    </div>

    <div class="br"><div></div><button class="btn btn-p" id="bn1" disabled>Next: Choose Competencies &#8594;</button></div>
</div>
</div>

<!-- STEP 2 -->
<div class="sp" id="step2">
<div class="crd">
    <div class="crd-t">&#127919; Choose Learning Competencies</div>
    <div class="crd-s" id="s2sub">Select which competencies to include in your lesson plan.</div>
    <div class="tip"><span class="ti">&#128161;</span><span class="tt"><strong>Tip:</strong> You can select multiple competencies. Each one will be mapped to learning objectives in your lesson plan. Performance tasks in assessments will align to these.</span></div>
    <div class="sb"><span class="sc" id="scnt">0 selected</span><div><button class="btn btn-sm" id="bsa">Select All</button> <button class="btn btn-sm" id="bda">Deselect All</button></div></div>
    <div class="cg" id="cl"></div>
    <div class="br"><button class="btn" id="bb2">&#8592; Back</button><button class="btn btn-p" id="bn2" disabled>Next: Customize &#8594;</button></div>
</div>
</div>

<!-- STEP 3 -->
<div class="sp" id="step3">
<div class="crd">
    <div class="crd-t">&#9881;&#65039; Customize Your Lesson Plan</div>
    <div class="crd-s">Toggle sections on/off and click &#9660; to customize each one.</div>

    <div id="ttoggles">
    <div class="tc on" data-s="title_info"><span class="tc-i">&#128196;</span><span class="tc-n">Lesson Plan Header</span><span class="tc-ck">&#10003;</span><button class="tc-x" data-s="title_info">&#9660;</button></div>
    <div class="to" id="o-title_info"><div class="fg"><label>Custom Title</label><input type="text" id="f-title" placeholder="Leave blank for auto-generated title"></div><div class="fg"><label>Time Allotment</label><select id="f-time"><option value="30 minutes">30 min</option><option value="45 minutes">45 min</option><option value="60 minutes" selected>60 min</option><option value="90 minutes">90 min</option><option value="120 minutes">120 min</option></select></div><div class="tip"><span class="ti">&#128161;</span><span class="tt">The header includes subject, grade, quarter, domain, and standards automatically from the curriculum data.</span></div></div>

    <div class="tc on" data-s="twenty_first_century_skills"><span class="tc-i">&#127775;</span><span class="tc-n">21st Century Skills</span><span class="tc-ck">&#10003;</span><button class="tc-x" data-s="twenty_first_century_skills">&#9660;</button></div>
    <div class="to" id="o-twenty_first_century_skills"><div class="fg"><label>Focus Skills</label><div id="sk-cb"></div></div><div class="tip"><span class="ti">&#128161;</span><span class="tt">Skills are loaded from the MATATAG curriculum data for your selected subject. Check the most relevant ones for this lesson.</span></div></div>

    <div class="tc on" data-s="learning_objectives"><span class="tc-i">&#127919;</span><span class="tc-n">Learning Objectives (SWBAT)</span><span class="tc-ck">&#10003;</span><button class="tc-x" data-s="learning_objectives">&#9660;</button></div>
    <div class="to" id="o-learning_objectives"><div class="fr"><div class="fg"><label>Number of Objectives</label><select id="f-nobj"><option>2</option><option selected>3</option><option>4</option><option>5</option></select></div></div><div class="fg"><label>Custom Objectives (one per line)</label><textarea id="f-cobj" rows="3" placeholder="SWBAT identify the parts of...&#10;SWBAT explain the relationship..."></textarea></div><div class="tip"><span class="ti">&#128161;</span><span class="tt">If left blank, objectives are auto-generated from the selected learning competencies using Bloom's taxonomy verbs.</span></div></div>

    <div class="tc on" data-s="materials_technology"><span class="tc-i">&#128221;</span><span class="tc-n">Materials / Technology</span><span class="tc-ck">&#10003;</span><button class="tc-x" data-s="materials_technology">&#9660;</button></div>
    <div class="to" id="o-materials_technology"><label style="font-size:12px;display:flex;gap:6px;margin-bottom:4px;cursor:pointer"><input type="checkbox" id="f-digi" checked> Include digital tools</label><label style="font-size:12px;display:flex;gap:6px;margin-bottom:8px;cursor:pointer"><input type="checkbox" id="f-trad" checked> Include traditional materials</label><div class="fg"><label>Custom Materials (one per line)</label><textarea id="f-mats" rows="2" placeholder="Science kit&#10;Magnifying glass"></textarea></div></div>

    <div class="tc on" data-s="prior_knowledge"><span class="tc-i">&#128218;</span><span class="tc-n">Prior Knowledge / Prerequisites</span><span class="tc-ck">&#10003;</span><button class="tc-x" data-s="prior_knowledge">&#9660;</button></div>
    <div class="to" id="o-prior_knowledge"><div class="fg"><label>Custom Prerequisites (one per line)</label><textarea id="f-prereq" rows="2" placeholder="Students can count to 100"></textarea></div><div class="tip"><span class="ti">&#128161;</span><span class="tt">Listing prerequisites helps teachers identify if students need review before the lesson begins.</span></div></div>

    <div class="tc on" data-s="lesson_procedure"><span class="tc-i">&#128203;</span><span class="tc-n">Lesson Procedure</span><span class="tc-ck">&#10003;</span><button class="tc-x" data-s="lesson_procedure">&#9660;</button></div>
    <div class="to" id="o-lesson_procedure"><div class="fg"><label>Instructional Design Model</label></div><div class="mg"><div class="mc sel" data-m="5e"><div class="mc-n">5E Model</div><div class="mc-d">Engage, Explore, Explain, Elaborate, Evaluate</div></div><div class="mc" data-m="4as"><div class="mc-n">4A's Model</div><div class="mc-d">Activity, Analysis, Abstraction, Application</div></div><div class="mc" data-m="deped_dlp"><div class="mc-n">DepEd DLP</div><div class="mc-d">Review, Motivation, Activity, Analysis, Application, Assessment</div></div><div class="mc" data-m="design_thinking"><div class="mc-n">Design Thinking</div><div class="mc-d">Empathize, Define, Ideate, Prototype, Test</div></div></div><label style="font-size:12px;display:flex;gap:6px;margin-top:10px;cursor:pointer"><input type="checkbox" id="f-timing" checked> Include time allocation per phase</label><div class="tip"><span class="ti">&#128161;</span><span class="tt">The <strong>DepEd DLP</strong> format follows the official Daily Lesson Plan structure. The <strong>5E</strong> model is great for inquiry-based science and math lessons.</span></div></div>

    <div class="tc on" data-s="differentiation"><span class="tc-i">&#129309;</span><span class="tc-n">Differentiation / Scaffolding</span><span class="tc-ck">&#10003;</span><button class="tc-x" data-s="differentiation">&#9660;</button></div>
    <div class="to" id="o-differentiation"><label style="font-size:12px;display:flex;gap:6px;margin-bottom:4px;cursor:pointer"><input type="checkbox" id="f-ds" checked> Struggling Learners</label><label style="font-size:12px;display:flex;gap:6px;margin-bottom:4px;cursor:pointer"><input type="checkbox" id="f-da" checked> Advanced Learners</label><label style="font-size:12px;display:flex;gap:6px;margin-bottom:8px;cursor:pointer"><input type="checkbox" id="f-de" checked> English Language Learners</label><div class="fg"><label>Additional Strategies</label><textarea id="f-diff" rows="2" placeholder="Use manipulatives for kinesthetic learners"></textarea></div><div class="tip"><span class="ti">&#128161;</span><span class="tt">Differentiation ensures every student can access the lesson regardless of their current skill level.</span></div></div>

    <div class="tc on" data-s="assessment"><span class="tc-i">&#128202;</span><span class="tc-n">Assessment</span><span class="tc-ck">&#10003;</span><button class="tc-x" data-s="assessment">&#9660;</button></div>
    <div class="to" id="o-assessment"><label style="font-size:12px;display:flex;gap:6px;margin-bottom:4px;cursor:pointer"><input type="checkbox" id="f-af" checked> Formative Assessment</label><label style="font-size:12px;display:flex;gap:6px;margin-bottom:8px;cursor:pointer"><input type="checkbox" id="f-as" checked> Summative Assessment</label><div class="fg"><label>Custom Assessments</label><textarea id="f-cass" rows="2" placeholder="Group presentation rubric"></textarea></div></div>

    <div class="tc on" data-s="reflection"><span class="tc-i">&#129300;</span><span class="tc-n">Teacher Reflection</span><span class="tc-ck">&#10003;</span><button class="tc-x" data-s="reflection">&#9660;</button></div>
    <div class="to" id="o-reflection"><div class="fg"><label>Number of Prompts</label><select id="f-nref"><option>2</option><option selected>3</option><option>4</option><option>5</option></select></div><div class="fg"><label>Custom Prompts</label><textarea id="f-cref" rows="2" placeholder="Did students engage with the activity?"></textarea></div><div class="tip"><span class="ti">&#128161;</span><span class="tt">Reflection prompts help teachers continuously improve their practice through self-evaluation after each lesson.</span></div></div>
    </div>

    <!-- Assessment Package -->
    <div id="assess-wrap" style="margin-top:20px;padding-top:16px;border-top:3px solid var(--c1);">
        <div class="crd-t">&#128203; Authentic Assessment Package</div>
        <div class="crd-s">Generate professional assessment tools aligned to the selected competencies.</div>
        <div class="fg"><label>Assessment Output Mode</label><select id="a-mode"><option value="none">No assessment (Lesson Plan only)</option><option value="incorporate">Include IN the lesson plan</option><option value="separate">Generate as SEPARATE document</option><option value="both">Generate BOTH (combined + separate download)</option></select></div>
        <div id="a-sec" style="display:none;">
            <div class="tip"><span class="ti">&#128161;</span><span class="tt"><strong>Tip:</strong> Performance Task + Rubric is the most common combination. Add Portfolio for long-term tracking, or Self & Peer Assessment for collaborative learning.</span></div>
            <div class="at-grid">
                <div class="at on" data-a="performance_task"><span class="at-i">&#127919;</span><div><div class="at-n">Performance Task</div><div class="at-d">Real-world GRASPS scenario</div></div></div>
                <div class="at on" data-a="rubric"><span class="at-i">&#128200;</span><div><div class="at-n">Scoring Rubric</div><div class="at-d">4-point criteria-based scale</div></div></div>
                <div class="at" data-a="portfolio"><span class="at-i">&#128194;</span><div><div class="at-n">Portfolio</div><div class="at-d">Student work collection</div></div></div>
                <div class="at" data-a="project_based"><span class="at-i">&#128736;</span><div><div class="at-n">Project-Based</div><div class="at-d">Multi-day real-world project</div></div></div>
                <div class="at" data-a="product_based"><span class="at-i">&#127912;</span><div><div class="at-n">Product-Based</div><div class="at-d">Poster, model, presentation</div></div></div>
                <div class="at" data-a="self_peer"><span class="at-i">&#128101;</span><div><div class="at-n">Self & Peer Assessment</div><div class="at-d">Evaluation forms & reflection</div></div></div>
            </div>
            <div class="fg" style="margin-top:10px;"><label>Assessment Context (optional)</label><textarea id="a-ctx" rows="2" placeholder="e.g., Students apply learning to a community garden project..."></textarea></div>
        </div>
    </div>

    <!-- Quiz Generation -->
    <div id="quiz-wrap" style="margin-top:20px;padding-top:16px;border-top:3px solid var(--c1);">
        <div class="crd-t">&#128221; Quiz Generation</div>
        <div class="crd-s">Generate a downloadable quiz based on the selected competencies.</div>
        <div style="display:flex;align-items:center;gap:12px;padding:14px;border:2px solid var(--border);border-radius:10px;margin-bottom:10px;" id="quiz-box">
            <label class="sw"><input type="checkbox" id="f-quiz"><span class="sl"></span></label>
            <div><div style="font-size:13px;font-weight:700;font-family:'Poppins',sans-serif;">Enable Quiz Generation</div><div style="font-size:11px;color:var(--text-s);">Creates a standalone quiz with answer key. Download separately for LMS upload (not in SCORM).</div></div>
        </div>
        <div id="quiz-opts" style="display:none;">
            <div class="fr">
                <div class="fg"><label>Number of Questions (per type)</label><select id="f-qnum"><option value="5" selected>5 questions</option><option value="10">10 questions</option><option value="15">15 questions</option><option value="20">20 questions</option></select></div>
            </div>
            <label style="font-size:12px;font-weight:600;display:block;margin-bottom:6px;font-family:'Poppins',sans-serif;color:var(--c2);">Question Types</label>
            <div class="qt-grid">
                <div class="qt on" data-qt="multiple_choice"><span style="font-size:18px;">&#9898;</span><div><div class="qt-n">Multiple Choice</div><div class="qt-d">4-option questions (A-D)</div></div></div>
                <div class="qt on" data-qt="true_false"><span style="font-size:18px;">&#9989;</span><div><div class="qt-n">True or False</div><div class="qt-d">Statement-based questions</div></div></div>
                <div class="qt" data-qt="identification"><span style="font-size:18px;">&#9999;&#65039;</span><div><div class="qt-n">Identification</div><div class="qt-d">Fill-in-the-blank</div></div></div>
                <div class="qt" data-qt="matching"><span style="font-size:18px;">&#128279;</span><div><div class="qt-n">Matching Type</div><div class="qt-d">Two-column matching</div></div></div>
            </div>
            <div class="tip" style="margin-top:10px;"><span class="ti">&#128161;</span><span class="tt"><strong>Tip:</strong> The quiz is a SEPARATE downloadable activity — not included in the SCORM package. Use the "Download Quiz (LMS)" button to save it, then upload to Moodle, Canvas, or Brightspace as a Quiz activity.</span></div>
        </div>
    </div>

    <!-- AI Status (always on) -->
    <div style="margin-top:20px;padding-top:16px;border-top:3px solid var(--c1);">
        <div style="display:flex;align-items:center;gap:12px;padding:14px;border:2px solid var(--c1);border-radius:10px;background:#f0fcfe;" id="ai-box">
            <div style="width:36px;height:36px;border-radius:50%;background:var(--c1);display:flex;align-items:center;justify-content:center;flex-shrink:0;"><span style="color:#fff;font-size:18px;">&#129302;</span></div>
            <div style="flex:1;"><div style="font-size:13px;font-weight:700;font-family:'Poppins',sans-serif;">AI-Powered Generation (Claude)</div><div style="font-size:11px;color:var(--text-s);">All content is generated by AI for detailed, classroom-ready lesson plans, assessments, and quizzes.</div></div>
            <span style="background:var(--success);color:#fff;padding:3px 12px;border-radius:16px;font-size:11px;font-weight:700;font-family:'Poppins',sans-serif;flex-shrink:0;">ACTIVE</span>
        </div>
        <input type="hidden" id="f-ai" value="on">
        <input type="hidden" id="f-aip" value="anthropic">
        <input type="hidden" id="f-aik" value="">
    </div>

    <div class="br"><button class="btn" id="bb3">&#8592; Back</button><button class="btn btn-g" id="bgen">&#9889; Generate Lesson Plan</button></div>
</div>
</div>

<!-- STEP 4 -->
<div class="sp" id="step4">
<div class="crd">
    <div class="crd-t" id="out-t">&#128196; Your Generated Lesson Plan</div>
    <div class="crd-s" id="out-s"></div>
    <div class="tabs" id="out-tabs"><button class="tab a" id="t-lp">&#128196; Lesson Plan</button><button class="tab" id="t-as">&#128203; Assessment</button><button class="tab" id="t-qz" style="display:none">&#128221; Quiz</button></div>
    <div class="ob" id="out-b"></div>
    <div class="oa">
        <button class="btn" id="b-copy">&#128203; Copy</button>
        <button class="btn" id="b-dl">&#128229; Download .md</button>
        <button class="btn btn-s2" id="b-scorm">&#128230; Download SCORM</button>
        <button class="btn" id="b-dla" style="display:none">&#128229; Assessment .md</button>
        <span id="quiz-dl-grp" style="display:none;gap:4px;align-items:center;flex-wrap:wrap;">
            <span style="font-size:11px;font-weight:600;color:var(--text-s);padding:2px 2px;font-family:'Poppins',sans-serif;">Quiz&#x25BE;</span>
            <button class="btn btn-sm" id="b-dlq-md" title="Human-readable reference">&#128221; .md</button>
            <button class="btn btn-sm" id="b-dlq-gift" title="Import into Moodle">&#128171; Moodle GIFT</button>
            <button class="btn btn-sm" id="b-dlq-qti" title="Import into Canvas or Brightspace">&#128230; QTI (Canvas/D2L)</button>
        </span>
        <button class="btn" id="b-pr">&#128424; Print</button>
        <button class="btn btn-p" id="b-new">&#43; Create Another</button>
    </div>
    <div class="tip"><span class="ti">&#128161;</span><span class="tt"><strong>SCORM Package:</strong> The .zip contains the lesson plan and assessment (if generated). Upload via Add Activity &gt; SCORM Package in Moodle, Canvas, or Brightspace. <strong>Note:</strong> The quiz is a separate LMS activity — use "Download Quiz (LMS)" to save it independently.</span></div>

    <!-- Rating Widget -->
    <div id="rating-section" style="margin-top:20px;padding-top:16px;border-top:3px solid var(--c1);">
        <div class="crd-t">&#11088; Rate This Lesson Plan</div>
        <div class="crd-s">Help us improve by sharing your feedback.</div>
        <div id="star-row" style="display:flex;gap:6px;margin:10px 0;">
            <span class="star" data-v="1">&#9733;</span>
            <span class="star" data-v="2">&#9733;</span>
            <span class="star" data-v="3">&#9733;</span>
            <span class="star" data-v="4">&#9733;</span>
            <span class="star" data-v="5">&#9733;</span>
        </div>
        <div class="fg"><label>Comment (optional)</label><textarea id="r-comment" rows="2" placeholder="What did you like? What could be improved?"></textarea></div>
        <button class="btn btn-p" id="r-submit" disabled>Submit Feedback</button>
        <div id="r-msg" style="display:none;color:var(--success);font-size:13px;margin-top:8px;font-weight:600;">&#10003; Thank you for your feedback!</div>
    </div>
</div>
</div>

</div>

<!-- Progress -->
<div class="po" id="po"><div class="pb"><div class="pb-t">&#9889; Generating Lesson Plan</div><div class="pb-s" id="ps">Please wait...</div><div class="pb-p" id="pp">0%</div><div class="pb-bg"><div class="pb-fl" id="pf"></div></div><div class="pb-st" id="pt">Preparing curriculum data...</div></div></div>

<div class="ft">SKOOLED-AI Lesson Plan Generator &bull; Philippine DepEd Curriculum &bull; SCORM 1.2 Compliant</div>

<script>
document.addEventListener("DOMContentLoaded",function(){
const $=s=>document.querySelector(s),$$=s=>document.querySelectorAll(s);
const _T=document.querySelector('meta[name="auth-token"]')?.content||'';
function aurl(u){if(!_T)return u;return u+(u.includes('?')?'&':'?')+'_t='+encodeURIComponent(_T);}
let step=1,selC=new Set(),cData=[],skData=[],rawLP="",rawAS="",rawQZ="",activeTab="lp",genMode="curriculum";

function go(n){$$(".sp").forEach(p=>p.classList.remove("a"));$(`#step${n}`).classList.add("a");$$(".stp").forEach((s,i)=>{s.classList.remove("a","d");if(i+1<n)s.classList.add("d");if(i+1===n)s.classList.add("a");});step=n;window.scrollTo({top:0,behavior:"smooth"});}

function switchMode(m){
    genMode=m;
    $("#mode-curriculum").style.display=m==="curriculum"?"block":"none";
    $("#mode-topic").style.display=m==="topic"?"block":"none";
    $$(".mode-tab").forEach(t=>t.classList.toggle("a",t.dataset.mode===m));
    if(m==="curriculum"){
        const hasQ=Q.options.length>1;
        $("#bn1").disabled=!(S.value&&G.value&&(Q.value||!hasQ));
        $("#bn1").textContent="Next: Choose Competencies \u2192";
    }else{
        $("#bn1").textContent="Next: Customize \u2192";
        updateTopicNextBtn();
    }
}
function updateTopicNextBtn(){
    const t=($("#t-topic")?.value||"").trim();
    const ts=($("#sel-ts")?.value||"");
    const tg=($("#t-grade")?.value||"").trim();
    $("#bn1").disabled=!(t&&ts&&tg);
}
function updateStep3ForMode(){}

$$(".mode-tab").forEach(t=>{t.addEventListener("click",function(){switchMode(this.dataset.mode);});});
["t-topic","t-grade"].forEach(id=>{const el=$("#"+id);if(el)el.addEventListener("input",()=>{if(genMode==="topic")updateTopicNextBtn();});});
const TS=$("#sel-ts");if(TS)TS.addEventListener("change",()=>{if(genMode==="topic")updateTopicNextBtn();});

const S=$("#sel-s"),G=$("#sel-g"),Q=$("#sel-q");

S.addEventListener("change",function(){G.innerHTML='<option value="">-- Choose Grade --</option>';G.disabled=true;Q.innerHTML='<option value="">-- Choose Quarter --</option>';Q.disabled=true;$("#bn1").disabled=true;if(!this.value)return;fetch(aurl(`/api/grades/${this.value}`)).then(r=>r.json()).then(g=>{g.forEach(v=>{const o=document.createElement("option");o.value=v;o.textContent=v.match(/^[0-9]/)?`Grade ${v}`:v;G.appendChild(o);});G.disabled=false;});fetch(aurl(`/api/curriculum-context/${this.value}`)).then(r=>r.json()).then(c=>{skData=c.skills||[];const b=$("#sk-cb");b.innerHTML="";skData.forEach(s=>{const l=document.createElement("label");l.style.cssText="font-size:12px;display:flex;gap:6px;margin-bottom:3px;cursor:pointer;";l.innerHTML=`<input type="checkbox" class="skc" value="${s.skill_name}"> ${s.skill_name}`;b.appendChild(l);});});});

G.addEventListener("change",function(){Q.innerHTML='<option value="">-- Choose Quarter --</option>';Q.disabled=true;$("#bn1").disabled=true;if(!this.value)return;fetch(aurl(`/api/quarters/${S.value}/${this.value}`)).then(r=>r.json()).then(q=>{if(!q.length){$("#bn1").disabled=false;return;}q.forEach(v=>{const o=document.createElement("option");o.value=v;o.textContent=`Quarter ${v}`;Q.appendChild(o);});Q.disabled=false;});});

Q.addEventListener("change",function(){$("#bn1").disabled=!this.value;});

$("#bn1").addEventListener("click",function(){
    if(genMode==="topic"){
        const topic=($("#t-topic")?.value||"").trim();
        const tsubj=($("#sel-ts")?.value||"");
        const tgrade=($("#t-grade")?.value||"").trim();
        const tcomps=($("#t-comps")?.value||"").trim();
        if(!topic||!tsubj)return;
        window._topicCtx={topic,subject_name:tsubj,grade:tgrade,competencies_text:tcomps};
        updateStep3ForMode();
        go(3);
        return;
    }
    const s=S.value,g=G.value,q=Q.value;if(!s||!g)return;let u=`/api/competencies/${s}?grade=${encodeURIComponent(g)}`;if(q)u+=`&quarter=${encodeURIComponent(q)}`;this.disabled=true;this.textContent="Loading...";fetch(aurl(u)).then(r=>r.json()).then(c=>{cData=c;selC.clear();renderC();const sn=S.options[S.selectedIndex].text,gn=G.options[G.selectedIndex].text,qn=q?` - Quarter ${q}`:"";$("#s2sub").textContent=`${sn} - ${gn}${qn} (${c.length} competencies)`;go(2);this.disabled=false;this.textContent="Next: Choose Competencies \u2192";});
});

function renderC(){const l=$("#cl");l.innerHTML="";if(!cData.length){l.innerHTML='<div style="padding:20px;text-align:center;color:var(--text-s)">No competencies found.</div>';return;}cData.forEach(c=>{const d=document.createElement("div");d.className="cc";d.dataset.id=c.id;const cb=document.createElement("input");cb.type="checkbox";const info=document.createElement("div");info.innerHTML=`<div class="cc-c">${c.lc_id||"LC-"+c.id}</div><div class="cc-d">${c.learning_competency}</div><div class="cc-m">${[c.domain,c.blooms_level?"Bloom's: "+c.blooms_level:""].filter(Boolean).join(" | ")}</div>`;d.appendChild(cb);d.appendChild(info);d.addEventListener("click",e=>{if(e.target!==cb)cb.checked=!cb.checked;if(cb.checked){selC.add(c.id);d.classList.add("sel");}else{selC.delete(c.id);d.classList.remove("sel");}upC();});l.appendChild(d);});upC();}
function upC(){$("#scnt").textContent=`${selC.size} of ${cData.length} selected`;$("#bn2").disabled=selC.size===0;}

$("#bsa").addEventListener("click",()=>{$$(".cc").forEach(d=>{d.querySelector("input").checked=true;d.classList.add("sel");selC.add(parseInt(d.dataset.id));});upC();});
$("#bda").addEventListener("click",()=>{$$(".cc").forEach(d=>{d.querySelector("input").checked=false;d.classList.remove("sel");});selC.clear();upC();});
$("#bb2").addEventListener("click",()=>go(1));
$("#bn2").addEventListener("click",()=>go(3));
$("#bb3").addEventListener("click",()=>go(genMode==="topic"?1:2));

// Toggle sections
$$("#ttoggles .tc").forEach(c=>{c.addEventListener("click",function(e){if(e.target.closest(".tc-x"))return;this.classList.toggle("on");});});
$$(".tc-x").forEach(b=>{b.addEventListener("click",function(e){e.stopPropagation();const o=$(`#o-${this.dataset.s}`);o.classList.toggle("op");this.classList.toggle("op");});});

// Model cards
$$(".mc").forEach(c=>{c.addEventListener("click",function(){$$(".mc").forEach(x=>x.classList.remove("sel"));this.classList.add("sel");});});

// Assessment types
$$(".at").forEach(c=>{c.addEventListener("click",function(){this.classList.toggle("on");});});
$("#a-mode").addEventListener("change",function(){$("#a-sec").style.display=this.value!=="none"?"block":"none";});

// Quiz toggle & types
$("#f-quiz").addEventListener("change",function(){$("#quiz-opts").style.display=this.checked?"block":"none";$("#quiz-box").style.borderColor=this.checked?"var(--c1)":"var(--border)";});
$$(".qt").forEach(c=>{c.addEventListener("click",function(){this.classList.toggle("on");});});

// AI is always on (server key pre-configured)

// Progress - adapts speed based on AI vs template mode
const pStepsFast=[{p:20,t:"Loading curriculum data..."},{p:50,t:"Building lesson plan..."},{p:80,t:"Formatting output..."},{p:95,t:"Almost done..."}];
const pStepsAI=[{p:3,t:"Loading curriculum data..."},{p:8,t:"Reading learning competencies..."},{p:12,t:"Gathering content standards..."},{p:16,t:"Building AI prompt..."},{p:20,t:"Sending to AI (Claude)..."},{p:25,t:"AI is writing your lesson plan..."},{p:30,t:"Generating lesson header..."},{p:38,t:"Writing learning objectives..."},{p:46,t:"Creating lesson procedure..."},{p:54,t:"Detailing teacher & student activities..."},{p:62,t:"Adding differentiation strategies..."},{p:70,t:"Building assessment section..."},{p:78,t:"Writing teacher reflection..."},{p:85,t:"AI is finalizing content..."},{p:90,t:"Formatting output..."},{p:93,t:"Almost done..."}];
function showP(isAI){
    const steps=isAI?pStepsAI:pStepsFast;
    const interval=isAI?1800:200;
    const est=isAI?"Estimated time: 15-30 seconds":"Estimated time: under 2 seconds";
    $("#po").classList.add("a");
    $("#pp").textContent="0%";$("#pf").style.width="0%";
    $("#ps").textContent=est;
    let i=0,curP=0;
    const waitMsgs=["AI is still writing...","Almost there, please wait...","Finalizing your content...","Reviewing and polishing..."];
    let wm=0;
    const iv=setInterval(()=>{if(i<steps.length){curP=steps[i].p;$("#pp").textContent=curP+"%";$("#pf").style.width=curP+"%";$("#pt").textContent=steps[i].t;i++;}else if(curP<99){curP=Math.min(99,parseFloat((curP+0.3).toFixed(1)));$("#pp").textContent=Math.floor(curP)+"%";$("#pf").style.width=curP+"%";$("#pt").textContent=waitMsgs[wm++%waitMsgs.length];}},interval);
    return function(){clearInterval(iv);$("#pp").textContent="100%";$("#pf").style.width="100%";$("#pt").textContent="Done! Loading your lesson plan...";setTimeout(()=>$("#po").classList.remove("a"),500);};
}

// Render tabbed sections within output box
function renderTabbed(html,container){
    const parts=html.split(/<h2>/i);
    if(parts.length<3){container.innerHTML=html;return;}
    const intro=parts[0];
    const sections=[];
    for(let i=1;i<parts.length;i++){
        const closeIdx=parts[i].indexOf('</h2>');
        if(closeIdx===-1){sections.push({title:'Section '+i,content:'<h2>'+parts[i]});}
        else{
            const title=parts[i].substring(0,closeIdx).replace(/<[^>]*>/g,'').trim();
            const content=parts[i].substring(closeIdx+5);
            sections.push({title:title,content:content});
        }
    }
    let tabBar='<div class="section-tabs">';
    tabBar+='<div class="section-tab active" data-idx="all">View All</div>';
    for(let i=0;i<sections.length;i++){tabBar+='<div class="section-tab" data-idx="'+i+'">'+sections[i].title+'</div>';}
    tabBar+='</div>';
    let panes='<div class="section-pane active" data-pane="all">'+intro;
    for(let i=0;i<sections.length;i++){panes+='<h2>'+sections[i].title+'</h2>'+sections[i].content;}
    panes+='</div>';
    for(let i=0;i<sections.length;i++){panes+='<div class="section-pane" data-pane="'+i+'"><h2>'+sections[i].title+'</h2>'+sections[i].content+'</div>';}
    container.innerHTML=tabBar+panes;
    const tabs=container.querySelectorAll('.section-tab');
    tabs.forEach(function(tab){
        tab.addEventListener('click',function(){
            tabs.forEach(function(t){t.classList.remove('active');});
            tab.classList.add('active');
            const idx=tab.getAttribute('data-idx');
            container.querySelectorAll('.section-pane').forEach(function(p){
                p.classList.remove('active');
                if(p.getAttribute('data-pane')===idx)p.classList.add('active');
            });
        });
    });
}

// GENERATE
$("#bgen").addEventListener("click",function(){
if(genMode==="curriculum"&&!selC.size)return;
const gm=()=>{const s=$(".mc.sel");return s?s.dataset.m:"5e";};
const ln=id=>($(id)?.value||"").split("\n").map(s=>s.trim()).filter(Boolean);
const on=s=>$(`#ttoggles .tc[data-s="${s}"]`)?.classList.contains("on");
const am=$("#a-mode").value;
const at=Array.from($$(".at.on")).map(c=>c.dataset.a);
const wantQuiz=$("#f-quiz").checked;
const quizTypes=Array.from($$(".qt.on")).map(c=>c.dataset.qt);

const cfg={
title_info:{enabled:on("title_info"),customizable_fields:{custom_title:$("#f-title")?.value||"",time_allotment:$("#f-time")?.value||"60 minutes"}},
twenty_first_century_skills:{enabled:on("twenty_first_century_skills"),customizable_fields:{focus_skills:Array.from($$(".skc:checked")).map(c=>c.value)}},
learning_objectives:{enabled:on("learning_objectives"),customizable_fields:{num_objectives:parseInt($("#f-nobj")?.value||"3"),custom_objectives:ln("#f-cobj")}},
materials_technology:{enabled:on("materials_technology"),customizable_fields:{include_digital_tools:$("#f-digi")?.checked!==false,include_traditional:$("#f-trad")?.checked!==false,custom_materials:ln("#f-mats")}},
prior_knowledge:{enabled:on("prior_knowledge"),customizable_fields:{custom_prerequisites:ln("#f-prereq")}},
lesson_procedure:{enabled:on("lesson_procedure"),customizable_fields:{model:gm(),include_timing:$("#f-timing")?.checked!==false,custom_activities:{}}},
differentiation:{enabled:on("differentiation"),customizable_fields:{include_struggling:$("#f-ds")?.checked!==false,include_advanced:$("#f-da")?.checked!==false,include_ell:$("#f-de")?.checked!==false,custom_strategies:ln("#f-diff")}},
assessment:{enabled:on("assessment"),customizable_fields:{include_formative:$("#f-af")?.checked!==false,include_summative:$("#f-as")?.checked!==false,custom_assessments:ln("#f-cass")}},
reflection:{enabled:on("reflection"),customizable_fields:{num_prompts:parseInt($("#f-nref")?.value||"3"),custom_prompts:ln("#f-cref")}},
};

const ai=true,ak=$("#f-aik")?.value||"",ap=$("#f-aip")?.value||"anthropic";

// ── Topic Mode ───────────────────────────────────────────────
if(genMode==="topic"){
    const ctx=window._topicCtx||{};
    if(!ctx.topic||!ctx.subject_name)return;
    const done=showP(true);
    const tps=[fetch(aurl("/api/generate-topic"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({topic:ctx.topic,subject_name:ctx.subject_name,grade:ctx.grade||"",competencies_text:ctx.competencies_text||"",template_config:cfg,use_ai:ai,api_key:ak,ai_provider:ap})}).then(r=>r.json())];
    const tNeedA=am!=="none"&&at.length>0;
    if(tNeedA)tps.push(fetch(aurl("/api/generate-assessment-topic"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({topic:ctx.topic,subject_name:ctx.subject_name,grade:ctx.grade||"",competencies_text:ctx.competencies_text||"",assessment_config:{types:at,custom_context:$("#a-ctx")?.value||""},use_ai:ai,api_key:ak,ai_provider:ap})}).then(r=>r.json()));
    if(wantQuiz&&quizTypes.length>0)tps.push(fetch(aurl("/api/generate-quiz-topic"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({topic:ctx.topic,subject_name:ctx.subject_name,grade:ctx.grade||"",competencies_text:ctx.competencies_text||"",quiz_config:{types:quizTypes,num_questions:parseInt($("#f-qnum")?.value||"5")},use_ai:ai,api_key:ak,ai_provider:ap})}).then(r=>r.json()));
    Promise.all(tps).then(trs=>{done();
    const tlp=trs[0];const tas=tNeedA?trs[1]:null;const tqzIdx=tNeedA?2:1;const tqz=(wantQuiz&&quizTypes.length>0)?trs[tqzIdx]:null;
    setTimeout(()=>{rawLP=tlp.content||"";rawAS=tas?.content||"";rawQZ=tqz?.content||"";
    $("#out-s").textContent=`Topic: ${ctx.topic} | ${ctx.subject_name}${ctx.grade?" Grade "+ctx.grade:""} | ${new Date().toLocaleString()}`;
    if(tlp.error){$("#out-b").innerHTML=`<div style="color:var(--danger);padding:20px"><strong>Error:</strong> ${tlp.error}</div>`;go(4);return;}
    const tHasAS=!!rawAS;const tHasQZ=!!rawQZ;
    if(am==="incorporate"&&tHasAS){rawLP+="\n\n---\n\n# AUTHENTIC ASSESSMENT PACKAGE\n\n"+rawAS;rawAS="";}
    if(tHasAS||tHasQZ){$("#out-tabs").classList.add("on");$("#t-as").style.display=tHasAS?"inline-flex":"none";$("#t-qz").style.display=tHasQZ?"inline-flex":"none";}else{$("#out-tabs").classList.remove("on");}
    $("#b-dla").style.display=(tHasAS&&am!=="incorporate")?"inline-flex":"none";$("#quiz-dl-grp").style.display=tHasQZ?"inline-flex":"none";
    if(am==="both"&&tHasAS){rawLP=rawLP+"\n\n---\n\n# AUTHENTIC ASSESSMENT PACKAGE\n\n"+rawAS;rawAS="";}
    let tParts=["Lesson Plan"];if(rawAS)tParts.push("Assessment");if(tHasQZ)tParts.push("Quiz");
    $("#out-t").textContent="\u{1F4C4} "+tParts.join(" + ");
    setTab("lp");go(4);},700);
    }).catch(e=>{done();setTimeout(()=>{$("#out-b").innerHTML=`<div style="color:var(--danger);padding:20px"><strong>Error:</strong> ${e.message}</div>`;go(4);},700);});
    return;
}

// ── Curriculum Mode ──────────────────────────────────────────
const ids=Array.from(selC);
const done=showP(true);
const ps=[fetch(aurl("/api/generate"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({subject_id:S.value,competency_ids:ids,template_config:cfg,use_ai:ai,api_key:ak,ai_provider:ap})}).then(r=>r.json())];
const needA=am!=="none"&&at.length>0;
if(needA)ps.push(fetch(aurl("/api/generate-assessment"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({subject_id:S.value,competency_ids:ids,assessment_config:{types:at,custom_context:$("#a-ctx")?.value||""},use_ai:ai,api_key:ak,ai_provider:ap})}).then(r=>r.json()));
if(wantQuiz&&quizTypes.length>0)ps.push(fetch(aurl("/api/generate-quiz"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({subject_id:S.value,competency_ids:ids,quiz_config:{types:quizTypes,num_questions:parseInt($("#f-qnum")?.value||"5")},use_ai:ai,api_key:ak,ai_provider:ap})}).then(r=>r.json()));

Promise.all(ps).then(rs=>{done();
const lp=rs[0];
const as=needA?rs[1]:null;
const qzIdx=needA?2:1;
const qz=(wantQuiz&&quizTypes.length>0)?rs[qzIdx]:null;

setTimeout(()=>{rawLP=lp.content||"";rawAS=as?.content||"";rawQZ=qz?.content||"";
const sn=S.options[S.selectedIndex].text,gn=G.options[G.selectedIndex].text;
$("#out-s").textContent=`${sn} - ${gn} | ${selC.size} competencies | ${new Date().toLocaleString()}`;
if(lp.error){$("#out-b").innerHTML=`<div style="color:var(--danger);padding:20px"><strong>Error:</strong> ${lp.error}</div>`;go(4);return;}

// Determine tabs visibility
const hasAS=!!rawAS;
const hasQZ=!!rawQZ;
const showTabs=hasAS||hasQZ;

if(am==="incorporate"&&hasAS){rawLP+="\n\n---\n\n# AUTHENTIC ASSESSMENT PACKAGE\n\n"+rawAS;rawAS="";}

// Show/hide tabs
if(showTabs||(am==="separate"&&hasAS)){
    $("#out-tabs").classList.add("on");
    $("#t-as").style.display=hasAS?"inline-flex":"none";
    $("#t-qz").style.display=hasQZ?"inline-flex":"none";
}else{
    $("#out-tabs").classList.remove("on");
}

// Show/hide download buttons
$("#b-dla").style.display=(hasAS&&am!=="incorporate")?"inline-flex":"none";
$("#quiz-dl-grp").style.display=hasQZ?"inline-flex":"none";

if(am==="both"&&hasAS){
    const c=rawLP+"\n\n---\n\n# AUTHENTIC ASSESSMENT PACKAGE\n\n"+rawAS;
    rawLP=c;
}

// Set title
let titleParts=["Lesson Plan"];
if(rawAS)titleParts.push("Assessment");
if(hasQZ)titleParts.push("Quiz");
$("#out-t").textContent="\u{1F4C4} "+titleParts.join(" + ");

// Render with section tabs
setTab("lp");
go(4);},700);
}).catch(e=>{done();setTimeout(()=>{$("#out-b").innerHTML=`<div style="color:var(--danger);padding:20px"><strong>Error:</strong> ${e.message}</div>`;go(4);},700);});
});

function setTab(t){
    activeTab=t;
    $$(".tabs .tab").forEach(b=>b.classList.remove("a"));
    if(t==="lp"){
        $("#t-lp").classList.add("a");
        renderTabbed(md2h(rawLP),$("#out-b"));
    }else if(t==="assess"){
        $("#t-as").classList.add("a");
        renderTabbed(md2h(rawAS),$("#out-b"));
    }else if(t==="quiz"){
        $("#t-qz").classList.add("a");
        renderTabbed(md2h(rawQZ),$("#out-b"));
    }
}
$("#t-lp").addEventListener("click",()=>setTab("lp"));
$("#t-as").addEventListener("click",()=>setTab("assess"));
$("#t-qz").addEventListener("click",()=>setTab("quiz"));

function md2h(m){if(!m)return"";let h=m.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
h=h.replace(/^&gt; (.+)$/gm,"<blockquote>$1</blockquote>");h=h.replace(/<\/blockquote>\n<blockquote>/g,"<br>");
h=h.replace(/^---$/gm,"<hr>");
h=h.replace(/- \[ \]/g,"\u2610");h=h.replace(/- \[x\]/g,"\u2611");
h=h.replace(/^#### (.+)$/gm,"<h4>$1</h4>");
h=h.replace(/^### (.+)$/gm,"<h3>$1</h3>");h=h.replace(/^## (.+)$/gm,"<h2>$1</h2>");h=h.replace(/^# (.+)$/gm,"<h1>$1</h1>");
h=h.replace(/\*\*\*(.+?)\*\*\*/g,"<strong><em>$1</em></strong>");h=h.replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>");h=h.replace(/\*(.+?)\*/g,"<em>$1</em>");
h=h.replace(/^\|(.+)\|$/gm,function(m){const c=m.split("|").filter(c=>c.trim());if(c.every(c=>/^[\s\-:]+$/.test(c)))return"<!--s-->";return"<tr>"+c.map(c=>`<td>${c.trim()}</td>`).join("")+"</tr>";});
h=h.replace(/((<tr>.*?<\/tr>\n?)+)/g,"<table>$1</table>");h=h.replace(/<!--s-->\n?/g,"");
h=h.replace(/^[-*] (.+)$/gm,"<li>$1</li>");h=h.replace(/^\d+\.\s+(.+)$/gm,"<li>$1</li>");h=h.replace(/((<li>.*?<\/li>\n?)+)/g,"<ul>$1</ul>");
h=h.replace(/^(?!<[a-z\/])((?!<).+)$/gm,"<p>$1</p>");h=h.replace(/<p>\s*<\/p>/g,"");return h;}

// Actions
$("#b-copy").addEventListener("click",function(){
    const txt=activeTab==="assess"?rawAS:activeTab==="quiz"?rawQZ:rawLP;
    navigator.clipboard.writeText(txt).then(()=>{this.textContent="\u2705 Copied!";setTimeout(()=>this.textContent="\u{1F4CB} Copy",2000);});
});
$("#b-pr").addEventListener("click",()=>window.print());
$("#b-dl").addEventListener("click",()=>{
    if(genMode==="topic"){const t=(window._topicCtx?.topic||"Topic").replace(/\s+/g,"_");dl(rawLP,`Lesson_Plan_${t}.md`);}
    else dl(rawLP,`Lesson_Plan_${S.value}_G${G.value}_Q${Q.value}.md`);
});
$("#b-dla").addEventListener("click",()=>{if(genMode==="topic"){const t=(window._topicCtx?.topic||"Topic").replace(/\s+/g,"_");dl(rawAS,`Assessment_${t}.md`);}else dl(rawAS,`Assessment_${S.value}_G${G.value}_Q${Q.value}.md`);});

function quizTitle(){if(genMode==="topic")return(window._topicCtx?.topic||"Quiz");return`${S.options[S.selectedIndex]?.text||"Quiz"}_G${G.value}_Q${Q.value}`;}
function quizFn(){return quizTitle().replace(/\s+/g,"_");}

// .md download (reference copy)
$("#b-dlq-md").addEventListener("click",()=>{dl(rawQZ,`Quiz_${quizFn()}.md`);});

// Moodle GIFT download
function exportQuizFormat(fmt){
    const url=fmt==="gift"?"/api/export-quiz-gift":"/api/export-quiz-qti";
    const btnId=fmt==="gift"?"#b-dlq-gift":"#b-dlq-qti";
    const btn=$(btnId),orig=btn.textContent;
    btn.textContent="Converting...";btn.disabled=true;
    const ak=$("#f-aik")?.value||"",ap=$("#f-aip")?.value||"anthropic";
    fetch(aurl(url),{method:"POST",headers:{"Content-Type":"application/json"},
        body:JSON.stringify({quiz_md:rawQZ,title:quizTitle(),api_key:ak,ai_provider:ap})
    }).then(r=>{if(!r.ok)return r.json().then(e=>{throw new Error(e.error||"Failed");});return r.blob();})
    .then(b=>{const a=document.createElement("a");a.href=URL.createObjectURL(b);a.download=`Quiz_${quizFn()}${fmt==="gift"?"_GIFT.txt":"_QTI.zip"}`;a.click();btn.textContent=orig;btn.disabled=false;})
    .catch(e=>{btn.textContent=orig;btn.disabled=false;alert("Export failed: "+e.message);});
}
$("#b-dlq-gift").addEventListener("click",()=>exportQuizFormat("gift"));
$("#b-dlq-qti").addEventListener("click",()=>exportQuizFormat("qti"));

function dl(txt,fn){const b=new Blob([txt],{type:"text/markdown"});const a=document.createElement("a");a.href=URL.createObjectURL(b);a.download=fn.replace(/\s+/g,"_");a.click();}

// SCORM Download
$("#b-scorm").addEventListener("click",function(){
    let title;
    if(genMode==="topic"){const ctx=window._topicCtx||{};title=`${ctx.topic||"Lesson"} ${ctx.grade||""}`.trim();}
    else{const sn=S.options[S.selectedIndex]?.text||"Lesson";const gn=G.value||"";title=`${sn} Grade ${gn} Q${Q.value||""}`;}
    this.textContent="Building SCORM...";this.disabled=true;
    fetch(aurl("/api/download-scorm"),{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({title:title,lesson_plan:rawLP,assessment:rawAS||""})
    }).then(r=>{if(!r.ok)throw new Error("Failed");return r.blob();}).then(b=>{
        const a=document.createElement("a");
        a.href=URL.createObjectURL(b);
        a.download=`SCORM_${title.replace(/\s+/g,"_")}.zip`;
        a.click();
        this.textContent="\u{1F4E6} Download SCORM";this.disabled=false;
    }).catch(e=>{this.textContent="\u{1F4E6} Download SCORM";this.disabled=false;alert("SCORM build failed: "+e.message);});
});

$("#b-new").addEventListener("click",()=>{rawLP="";rawAS="";rawQZ="";ratingVal=0;$$(".star").forEach(s=>s.style.color="#dfe6e9");$("#r-submit").disabled=true;if($("#r-comment"))$("#r-comment").value="";$("#r-msg").style.display="none";$("#quiz-dl-grp").style.display="none";$("#b-dla").style.display="none";go(1);});

// Rating widget
let ratingVal=0;
const stars=$$(".star");
stars.forEach(s=>{s.style.color="#dfe6e9";});
stars.forEach(s=>{
    s.addEventListener("mouseenter",function(){const v=parseInt(this.dataset.v);stars.forEach((x,i)=>x.style.color=i<v?"var(--accent)":"#dfe6e9");});
    s.addEventListener("mouseleave",()=>{stars.forEach((x,i)=>x.style.color=i<ratingVal?"var(--accent)":"#dfe6e9");});
    s.addEventListener("click",function(){ratingVal=parseInt(this.dataset.v);stars.forEach((x,i)=>x.style.color=i<ratingVal?"var(--accent)":"#dfe6e9");$("#r-submit").disabled=false;});
});
$("#r-submit").addEventListener("click",function(){
    if(!ratingVal)return;
    this.disabled=true;
    const sn=genMode==="topic"?(window._topicCtx?.subject_name||""):(S.options[S.selectedIndex]?.text||"");
    const gn=genMode==="topic"?(window._topicCtx?.grade||""):(G.value||"");
    const qn=genMode==="topic"?"":(Q.value||"");
    const lt=genMode==="topic"?(window._topicCtx?.topic||""):"";
    fetch(aurl("/api/rate-lesson"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({rating:ratingVal,comment:$("#r-comment")?.value||"",subject:sn,grade:gn,quarter:qn,lesson_title:lt,gen_mode:genMode})}).then(()=>{$("#r-msg").style.display="block";}).catch(()=>{$("#r-msg").style.display="block";});
});
});
</script>
</body>
</html>
