<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="auth-token" content="{{ auth_token }}">
<link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
<title>SKOOLED-AI Lesson Plan Generator</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
/* ── Variables (Landing page light-mode palette) ── */
:root {
    --bg: #f0f9fb;
    --c1: #00bbd6;
    --c1d: #009bb3;
    --c2: #0d1f2d;
    --c2d: #081520;
    --accent: #faa32b;
    --accent-lt: #fff8ed;
    --glass: rgba(255,255,255,0.72);
    --glass-b: rgba(0,187,214,0.2);
    --text: #0d1f2d;
    --text-s: rgba(13,31,45,0.56);
    --border: #c8e8ee;
    --success: #00b894;
    --danger: #e74c3c;
    --rad: 18px;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{
    font-family:'Plus Jakarta Sans',sans-serif;
    background:var(--bg);
    color:var(--text);
    line-height:1.7;
    background-image:radial-gradient(ellipse 90% 45% at 50% -8%,rgba(0,187,214,0.11) 0%,transparent 65%);
    background-attachment:fixed;
}
h1,h2,h3,h4,.grotesk{font-family:'Space Grotesk',sans-serif;}

/* Header */
.hdr{background:linear-gradient(135deg,var(--c2) 0%,#1b4a6e 55%,var(--c1) 100%);color:#fff;padding:22px 30px;text-align:center;position:relative;overflow:hidden;}
.hdr::before{content:'';position:absolute;top:-60px;right:-60px;width:200px;height:200px;background:rgba(0,187,214,0.14);border-radius:50%;}
.hdr::after{content:'';position:absolute;bottom:-40px;left:-40px;width:150px;height:150px;background:rgba(255,255,255,0.05);border-radius:50%;}
.hdr h1{font-family:'Space Grotesk',sans-serif;font-size:22px;font-weight:800;letter-spacing:-0.04em;}
.hdr p{font-size:12px;opacity:0.72;margin-top:3px;font-weight:300;}
.hdr .stats{display:flex;justify-content:center;gap:10px;margin-top:10px;font-size:11px;flex-wrap:wrap;}
.hdr .st{background:rgba(255,255,255,0.12);border:1px solid rgba(255,255,255,0.16);padding:3px 12px;border-radius:20px;font-weight:500;}

/* Steps */
.steps{display:flex;justify-content:center;gap:0;padding:18px 20px 0;max-width:800px;margin:0 auto;}
.stp{flex:1;text-align:center;position:relative;padding-bottom:10px;}
.stp-n{width:34px;height:34px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;background:rgba(13,31,45,0.1);color:var(--text-s);margin-bottom:4px;transition:.3s;}
.stp.a .stp-n{background:var(--c1);color:#fff;box-shadow:0 4px 14px rgba(0,187,214,.3);}
.stp.d .stp-n{background:var(--success);color:#fff;}
.stp-l{font-size:11px;font-weight:600;color:var(--text-s);}
.stp.a .stp-l{color:var(--c2);}
.stp.d .stp-l{color:var(--success);}
.stp-ln{position:absolute;top:17px;left:50%;width:100%;height:2px;background:rgba(13,31,45,0.1);z-index:0;}
.stp:last-child .stp-ln{display:none;}
.stp.d .stp-ln{background:var(--success);}

/* Container */
.cnt{max-width:860px;margin:0 auto;padding:18px 16px 40px;}

/* Card */
.crd{
    background:var(--glass);
    backdrop-filter:blur(18px);-webkit-backdrop-filter:blur(18px);
    border-radius:var(--rad);padding:26px;
    box-shadow:0 2px 20px rgba(0,187,214,0.07),0 1px 4px rgba(0,0,0,0.04);
    border:1px solid var(--glass-b);
    margin-bottom:16px;
}
.crd-t{font-family:'Space Grotesk',sans-serif;font-size:18px;font-weight:700;margin-bottom:3px;letter-spacing:-0.025em;color:var(--c2);}
.crd-s{font-size:12px;color:var(--text-s);margin-bottom:18px;font-weight:400;}

/* Tip */
.tip{display:flex;gap:10px;background:var(--accent-lt);border-left:4px solid var(--accent);border-radius:0 10px 10px 0;padding:10px 14px;margin:12px 0;font-size:12px;align-items:flex-start;line-height:1.5;}
.tip .ti{font-size:18px;flex-shrink:0;}
.tip .tt{color:#5a4310;}

/* Step Panels */
.sp{display:none;}.sp.a{display:block;}

/* Form */
.fr{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:14px;}
@media(max-width:600px){.fr{grid-template-columns:1fr;}}
.fg{margin-bottom:14px;}
.fg label{display:block;font-size:12px;font-weight:600;margin-bottom:4px;font-family:'Space Grotesk',sans-serif;color:var(--c2);}
.fg .hn{font-size:11px;color:var(--text-s);margin-top:2px;}
select,input[type="text"],input[type="password"],textarea{
    width:100%;padding:10px 14px;font-size:13px;font-family:inherit;
    border:1.5px solid var(--border);border-radius:10px;
    background:rgba(255,255,255,0.8);color:var(--text);
    transition:border-color .2s;
}
select:focus,input:focus,textarea:focus{outline:none;border-color:var(--c1);}
select:disabled{background:rgba(240,245,247,0.6);opacity:.6;}
textarea{resize:vertical;min-height:60px;}

/* Buttons */
.btn{
    padding:10px 22px;border-radius:10px;font-size:13px;font-weight:600;
    border:1.5px solid var(--glass-b);background:var(--glass);
    backdrop-filter:blur(10px);cursor:pointer;transition:.2s;
    font-family:'Space Grotesk',sans-serif;color:var(--c2);
}
.btn:hover{border-color:var(--c1);color:var(--c1);}
.btn-p{background:var(--c1);color:#fff;border-color:var(--c1);}
.btn-p:hover{background:var(--c1d);border-color:var(--c1d);color:#fff;}
.btn-p:disabled{opacity:.5;cursor:not-allowed;}
.btn-g{
    background:var(--c1);color:var(--c2);border-color:var(--c1);
    padding:14px 32px;font-size:15px;font-weight:800;
    box-shadow:0 8px 28px rgba(0,187,214,0.28);letter-spacing:-0.02em;
}
.btn-g:hover{background:#00d4f0;border-color:#00d4f0;color:var(--c2);box-shadow:0 12px 36px rgba(0,187,214,.36);transform:translateY(-1px);}
.btn-g:disabled{opacity:.5;cursor:not-allowed;transform:none;}
.btn-s2{background:var(--c2);color:#fff;border-color:var(--c2);}
.btn-s2:hover{background:var(--c2d);border-color:var(--c2d);color:#fff;}
.btn-sm{padding:5px 12px;font-size:11px;}
.btn-save-lp{background:linear-gradient(135deg,#0d6efd,#0b5ed7);color:#fff;border-color:#0d6efd;font-weight:700;}
.btn-save-lp:hover{background:linear-gradient(135deg,#0b5ed7,#0a58ca);border-color:#0b5ed7;color:#fff;}
.lp-list-item{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 0;border-bottom:1px solid rgba(0,187,214,0.1);}
.lp-list-item:last-child{border-bottom:none;}
.lp-list-title{font-size:13px;font-weight:700;color:#e8f4f8;}
.lp-list-sub{font-size:11px;color:#6b8fa3;margin-top:2px;}
.lp-list-actions{display:flex;gap:6px;flex-shrink:0;}
.btn-lp-load{padding:5px 14px;font-size:11px;font-weight:700;background:rgba(0,187,214,0.15);color:#00bbd6;border:1.5px solid rgba(0,187,214,0.35);border-radius:8px;cursor:pointer;}
.btn-lp-load:hover{background:rgba(0,187,214,0.25);}
.btn-lp-del{padding:5px 10px;font-size:11px;background:rgba(231,76,60,0.1);color:#e74c3c;border:1.5px solid rgba(231,76,60,0.3);border-radius:8px;cursor:pointer;}
.btn-lp-del:hover{background:rgba(231,76,60,0.2);}
.br{display:flex;justify-content:space-between;margin-top:22px;gap:10px;}

/* Competencies */
.cg{max-height:380px;overflow-y:auto;border:1px solid var(--glass-b);border-radius:12px;background:rgba(255,255,255,0.45);}
.cc{display:flex;gap:10px;padding:10px 14px;border-bottom:1px solid rgba(0,187,214,0.08);cursor:pointer;transition:background .15s;align-items:flex-start;}
.cc:hover{background:rgba(0,187,214,0.07);}
.cc.sel{background:rgba(0,187,214,0.12);}
.cc:last-child{border-bottom:none;}
.cc input{margin-top:3px;transform:scale(1.15);accent-color:var(--c1);}
.cc-c{font-size:10px;font-weight:700;color:var(--c1);}
.cc-d{font-size:12px;line-height:1.5;}
.cc-m{font-size:10px;color:var(--text-s);margin-top:2px;}
.sb{display:flex;justify-content:space-between;align-items:center;padding:6px 0;margin-bottom:6px;}
.sc{font-size:13px;font-weight:700;color:var(--c2);font-family:'Space Grotesk',sans-serif;}

/* Toggles */
.tc{display:flex;align-items:center;gap:12px;padding:12px 16px;border:1.5px solid var(--glass-b);border-radius:12px;margin-bottom:8px;cursor:pointer;transition:.2s;background:rgba(255,255,255,0.5);}
.tc:hover{border-color:rgba(0,187,214,0.4);}
.tc.on{border-color:rgba(0,187,214,0.4);background:rgba(0,187,214,0.07);}
.tc-i{font-size:20px;flex-shrink:0;width:32px;text-align:center;}
.tc-n{font-size:13px;font-weight:600;flex:1;}
.tc-ck{width:20px;height:20px;border-radius:5px;border:1.5px solid rgba(13,31,45,0.2);display:flex;align-items:center;justify-content:center;font-size:13px;color:#fff;transition:.2s;flex-shrink:0;}
.tc.on .tc-ck{background:var(--c1);border-color:var(--c1);}
.tc-x{background:none;border:none;cursor:pointer;font-size:16px;color:var(--text-s);padding:2px 6px;transition:transform .2s;flex-shrink:0;}
.tc-x.op{transform:rotate(180deg);}
.to{display:none;padding:14px 16px;margin:-8px 0 8px;border:1.5px solid var(--glass-b);border-top:none;border-radius:0 0 12px 12px;background:rgba(255,255,255,0.4);}
.to.op{display:block;}

/* Model Cards */
.mg{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
@media(max-width:600px){.mg{grid-template-columns:1fr;}}
.mc{padding:12px;border:1.5px solid var(--glass-b);border-radius:12px;cursor:pointer;transition:.2s;text-align:center;background:rgba(255,255,255,0.5);}
.mc:hover{border-color:rgba(0,187,214,0.45);}
.mc.sel{border-color:var(--c1);background:rgba(0,187,214,0.1);}
.mc-n{font-size:12px;font-weight:700;font-family:'Space Grotesk',sans-serif;}
.mc-d{font-size:10px;color:var(--text-s);margin-top:2px;}

/* Assessment Types */
.at-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
@media(max-width:600px){.at-grid{grid-template-columns:1fr;}}
.at{padding:10px 14px;border:1.5px solid var(--glass-b);border-radius:12px;cursor:pointer;transition:.2s;display:flex;align-items:center;gap:10px;background:rgba(255,255,255,0.5);}
.at:hover{border-color:var(--accent);}
.at.on{border-color:var(--accent);background:var(--accent-lt);}
.at-i{font-size:20px;flex-shrink:0;}
.at-n{font-size:12px;font-weight:600;}
.at-d{font-size:10px;color:var(--text-s);}

/* Switch */
.sw{position:relative;width:42px;height:22px;flex-shrink:0;}
.sw input{opacity:0;width:0;height:0;}
.sl{position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(13,31,45,0.15);border-radius:22px;cursor:pointer;transition:.3s;}
.sl:before{content:"";position:absolute;height:16px;width:16px;left:3px;bottom:3px;background:#fff;border-radius:50%;transition:.3s;}
.sw input:checked+.sl{background:var(--c1);}
.sw input:checked+.sl:before{transform:translateX(20px);}

/* Progress */
.po{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(13,31,45,0.82);backdrop-filter:blur(10px);z-index:1000;justify-content:center;align-items:center;}
.po.a{display:flex;}
.pb{background:var(--glass);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);border:1px solid var(--glass-b);border-radius:24px;padding:40px 44px;text-align:center;max-width:420px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,.12);}
.pb-t{font-size:18px;font-weight:700;font-family:'Space Grotesk',sans-serif;margin-bottom:6px;color:var(--c2);letter-spacing:-0.02em;}
.pb-s{font-size:12px;color:var(--text-s);margin-bottom:22px;}
.pb-p{font-size:36px;font-weight:800;color:var(--c1);margin-bottom:4px;font-family:'Space Grotesk',sans-serif;}
.pb-bg{width:100%;height:8px;background:rgba(0,187,214,0.12);border-radius:5px;overflow:hidden;margin-bottom:10px;}
.pb-fl{height:100%;background:linear-gradient(90deg,var(--c1),var(--accent));border-radius:5px;transition:width .4s;width:0%;}
.pb-st{font-size:11px;color:var(--text-s);min-height:16px;}

/* Output */
.ob{background:rgba(255,255,255,0.65);backdrop-filter:blur(8px);border:1px solid var(--glass-b);border-radius:14px;padding:28px;max-height:70vh;overflow-y:auto;line-height:1.8;font-size:14px;}
.ob h1{font-family:'Space Grotesk',sans-serif;font-size:24px;font-weight:800;color:var(--c2);margin:24px 0 14px;padding-bottom:8px;border-bottom:3px solid var(--c1);text-align:center;background:linear-gradient(90deg,var(--c1),var(--c2));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;}
.ob h2{font-family:'Space Grotesk',sans-serif;font-size:18px;font-weight:700;color:var(--c2);margin:22px 0 10px;padding:10px 16px;border-left:4px solid var(--c1);background:rgba(0,187,214,0.07);border-radius:0 10px 10px 0;}
.ob h3{font-family:'Space Grotesk',sans-serif;font-size:15px;font-weight:600;color:var(--c2);margin:16px 0 8px;padding-left:8px;border-left:3px solid var(--accent);}
.ob h4{font-family:'Space Grotesk',sans-serif;font-size:14px;font-weight:600;color:var(--c2);margin:12px 0 6px;}
.ob table{width:100%;border-collapse:collapse;margin:10px 0;font-size:12px;border-radius:10px;overflow:hidden;}
.ob th{background:var(--c2);color:#fff;padding:10px 14px;font-family:'Space Grotesk',sans-serif;font-weight:600;text-align:left;}
.ob td{padding:8px 14px;border:1px solid rgba(0,187,214,0.12);}
.ob tr:nth-child(even) td{background:rgba(0,187,214,0.04);}
.ob td:first-child{font-weight:600;color:var(--c2);}
.ob ul,.ob ol{padding-left:22px;margin:8px 0;}
.ob li{margin-bottom:5px;font-size:13px;line-height:1.6;}
.ob blockquote{border-left:4px solid var(--accent);background:var(--accent-lt);padding:12px 18px;border-radius:0 10px 10px 0;margin:12px 0;font-size:12px;}
.ob hr{border:none;height:2px;background:linear-gradient(90deg,var(--c1),var(--accent),var(--c2));border-radius:2px;margin:24px 0;opacity:.35;}
.ob em{color:var(--text-s);}
.ob p{margin:6px 0;}

/* Section Tabs (within output) */
.section-tabs{display:flex;gap:4px;padding:8px 0 14px;overflow-x:auto;flex-wrap:wrap;}
.section-tab{padding:7px 16px;border-radius:8px;font-size:12px;font-weight:600;border:1.5px solid var(--glass-b);background:rgba(255,255,255,0.65);cursor:pointer;font-family:'Space Grotesk',sans-serif;transition:.2s;white-space:nowrap;color:var(--c2);}
.section-tab:hover{border-color:var(--c1);background:rgba(0,187,214,0.07);}
.section-tab.active{background:var(--c1);color:#fff;border-color:var(--c1);}
.section-pane{display:none;}
.section-pane.active{display:block;}

/* Quiz Type Grid */
.qt-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
@media(max-width:600px){.qt-grid{grid-template-columns:1fr;}}
.qt{padding:10px 14px;border:1.5px solid var(--glass-b);border-radius:12px;cursor:pointer;transition:.2s;display:flex;align-items:center;gap:10px;background:rgba(255,255,255,0.5);}
.qt:hover{border-color:rgba(0,187,214,0.45);}
.qt.on{border-color:var(--c1);background:rgba(0,187,214,0.09);}
.qt-n{font-size:12px;font-weight:600;}
.qt-d{font-size:10px;color:var(--text-s);}

/* Activities & PPTX quick-action strip */
.qa-strip{display:flex;gap:10px;margin:0 0 16px;flex-wrap:wrap;}
.qa-btn{flex:1;min-width:160px;display:flex;align-items:center;gap:12px;padding:14px 18px;border-radius:14px;cursor:pointer;font-family:'Space Grotesk',sans-serif;font-weight:700;font-size:14px;border:2px solid transparent;transition:.2s;}
.qa-btn-act{background:linear-gradient(135deg,var(--c2) 0%,#1b4a6e 100%);color:#fff;border-color:var(--c1);box-shadow:0 4px 18px rgba(0,187,214,.18);}
.qa-btn-act:hover{box-shadow:0 8px 28px rgba(0,187,214,.32);transform:translateY(-1px);}
.qa-btn-pptx{background:linear-gradient(135deg,#fff8ed 0%,#fff3d6 100%);color:var(--c2);border-color:var(--accent);}
.qa-btn-pptx:hover{box-shadow:0 8px 28px rgba(250,163,43,.22);transform:translateY(-1px);}
.qa-btn .qi{font-size:26px;flex-shrink:0;}
.qa-btn .qt-wrap .ql{font-size:14px;font-weight:800;}
.qa-btn .qt-wrap .qs{font-size:11px;opacity:.72;font-weight:400;font-family:'Plus Jakarta Sans',sans-serif;}
/* Step 3 activities preview banner */
.act-banner{display:flex;align-items:center;gap:14px;padding:14px 18px;border-radius:14px;background:linear-gradient(135deg,rgba(0,187,214,.08) 0%,rgba(13,31,45,.06) 100%);border:1.5px solid rgba(0,187,214,.25);margin-top:20px;}
.act-banner-icons{display:flex;gap:4px;flex-wrap:wrap;font-size:20px;}
.act-banner-txt .abt{font-size:13px;font-weight:700;color:var(--c2);}
.act-banner-txt .abs{font-size:11px;color:var(--text-s);margin-top:2px;}
.oa{display:flex;gap:8px;margin-top:16px;justify-content:center;flex-wrap:wrap;}
.tabs{display:none;margin-bottom:14px;gap:4px;}
.tabs.on{display:flex;}
.tab{padding:7px 18px;border-radius:10px;font-size:12px;font-weight:600;border:1.5px solid var(--glass-b);background:rgba(255,255,255,0.65);cursor:pointer;font-family:'Space Grotesk',sans-serif;transition:.2s;color:var(--c2);}
.tab:hover{border-color:var(--c1);}
.tab.a{background:var(--c2);color:#fff;border-color:var(--c2);}
.mode-tab{padding:9px 18px;border-radius:10px;font-size:13px;font-weight:600;border:1.5px solid var(--glass-b);background:rgba(255,255,255,0.65);cursor:pointer;font-family:'Space Grotesk',sans-serif;transition:.2s;flex:1;text-align:center;color:var(--c2);}
.mode-tab:hover{border-color:var(--c1);}
.mode-tab.a{background:var(--c1);color:#fff;border-color:var(--c1);}
.star{cursor:pointer;color:rgba(13,31,45,0.15);font-size:28px;transition:color .15s;}

.ft{text-align:center;padding:18px;font-size:11px;color:var(--text-s);border-top:1px solid var(--glass-b);margin-top:20px;letter-spacing:.04em;font-weight:500;}

@media print{.hdr,.steps,.br,.oa,.tabs,.ft,.sp:not(#step4),.section-tabs{display:none!important;}.ob{max-height:none;overflow:visible;box-shadow:none;border:none;}.section-pane{display:block!important;}}

/* Scrollbar */
::-webkit-scrollbar{width:5px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:rgba(0,187,214,0.3);border-radius:3px;}

/* Section Regen */
.rp-chip{padding:5px 12px;border-radius:20px;border:1.5px solid var(--glass-b);background:rgba(255,255,255,0.7);font-size:11px;font-weight:600;cursor:pointer;transition:.15s;color:var(--c2);}
.rp-chip.sel,.rp-chip:hover{border-color:var(--c1);background:var(--c1);color:#fff;}
.sec-regen-btn{padding:3px 10px;font-size:11px;font-weight:600;border:1px solid var(--glass-b);border-radius:6px;background:rgba(255,255,255,0.7);cursor:pointer;color:var(--c2);transition:.15s;flex-shrink:0;}
.sec-regen-btn:hover{border-color:var(--c1);color:var(--c1);}
.sec-hdr{display:flex;justify-content:space-between;align-items:center;gap:8px;}
.sec-hdr h2{margin:0;}

/* Resume Banner */
.resume-banner{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:11px 18px;border-radius:12px;background:rgba(0,187,214,0.1);border:1.5px solid rgba(0,187,214,0.35);margin:0 0 14px;flex-wrap:wrap;}
.resume-banner-text{font-size:12px;color:var(--c2);font-weight:500;}
.resume-banner-text strong{color:var(--c1);}
.resume-banner-actions{display:flex;gap:8px;flex-shrink:0;}
.rbtn-cont{padding:6px 16px;border-radius:8px;border:none;background:var(--c1);color:#fff;font-size:12px;font-weight:700;cursor:pointer;font-family:'Space Grotesk',sans-serif;transition:.2s;}
.rbtn-cont:hover{background:var(--c1d);}
.rbtn-dismiss{padding:6px 14px;border-radius:8px;border:1.5px solid var(--border);background:transparent;color:var(--text-s);font-size:12px;font-weight:600;cursor:pointer;font-family:'Space Grotesk',sans-serif;transition:.2s;}
.rbtn-dismiss:hover{border-color:var(--c1);color:var(--c2);}
</style>
</head>
<body>

<div style="background:var(--c2);color:#fff;padding:6px 20px;display:flex;justify-content:space-between;align-items:center;font-size:12px;font-family:'Space Grotesk',sans-serif;font-weight:500;">
    <span>Welcome, <strong>{{ session.get('user_name', 'User') }}</strong></span>
    <div style="display:flex;gap:12px;">
        <a href="{{ url_for('landing') }}" style="color:#fff;opacity:0.8;text-decoration:none;">Home</a>
        <a href="{{ turl('activities') }}" style="color:#fff;opacity:0.8;text-decoration:none;">Activities</a>
        <a href="{{ turl('syllabus') }}" style="color:#fff;opacity:0.8;text-decoration:none;">Syllabus</a>
        <a href="#" id="nav-my-lps" style="color:#fff;opacity:0.8;text-decoration:none;">My Lesson Plans</a>
        {% if session.get('user_role') == 'admin' %}
        <a href="{{ turl('auth.admin_panel') }}" style="color:#fff;opacity:0.8;text-decoration:none;">Admin</a>
        {% endif %}
        <a href="{{ url_for('auth.logout') }}" style="color:#fff;opacity:0.8;text-decoration:none;">Logout</a>
    </div>
</div>
<div class="hdr">
    <h1>SKOOLED-AI Lesson Plan Generator</h1>
    <p>AI-Generated Lesson Plans for K-12 &amp; SHS</p>
    <div class="stats">
        <span class="st">3,400+ Competencies</span>
        <span class="st">13 Subjects</span>
        <span class="st">Grades K-10</span>
        <span class="st">SCORM 1.2 Ready</span>
    </div>
</div>

<div class="steps">
    <div class="stp a" id="si1"><div class="stp-ln"></div><div class="stp-n">1</div><div class="stp-l">Curriculum</div></div>
    <div class="stp" id="si2"><div class="stp-ln"></div><div class="stp-n">2</div><div class="stp-l">Competencies</div></div>
    <div class="stp" id="si3"><div class="stp-ln"></div><div class="stp-n">3</div><div class="stp-l">Customize</div></div>
    <div class="stp" id="si4"><div class="stp-n">4</div><div class="stp-l">Output</div></div>
</div>

<div class="cnt">

<!-- Resume Banner (shown when saved content < 24h exists) -->
<div class="resume-banner" id="resume-banner" style="display:none;">
  <div class="resume-banner-text"><strong id="rb-label">Previous session</strong> &nbsp;·&nbsp; <span id="rb-time"></span> &mdash; Continue from last session?</div>
  <div class="resume-banner-actions">
    <button class="rbtn-cont" id="rb-continue">Continue</button>
    <button class="rbtn-dismiss" id="rb-dismiss">Dismiss</button>
  </div>
</div>


<!-- STEP 1 -->
<div class="sp a" id="step1">
<div class="crd">
    <div class="crd-t">Step 1: Choose Your Approach</div>
    <div class="crd-s">Select from the curriculum database or enter a custom topic.</div>

    <!-- Mode Tabs -->
    <div style="display:flex;gap:8px;margin-bottom:18px;">
        <button class="mode-tab a" data-mode="curriculum" id="mtab-c">Select from Curriculum</button>
        <button class="mode-tab" data-mode="topic" id="mtab-t">&#9998;&#65039; Enter Custom Topic</button>
    </div>

    <!-- Curriculum Mode -->
    <div id="mode-curriculum">
        <div class="tip"><span class="tt"><strong>Tip:</strong> Start by selecting the subject area. The grade levels and quarters will automatically load based on available MATATAG curriculum data.</span></div>
        <div class="fg"><label>Subject / Learning Area</label><select id="sel-s"><option value="">-- Choose a Subject --</option>{% for s in subjects %}<option value="{{ s.id }}">{{ s.display_name }}</option>{% endfor %}</select></div>
        <div class="fr">
            <div class="fg"><label>Grade Level</label><select id="sel-g" disabled><option value="">-- Choose Grade --</option></select></div>
            <div class="fg"><label>Quarter</label><select id="sel-q" disabled><option value="">-- Choose Quarter --</option></select></div>
        </div>
    </div>

    <!-- Topic Mode -->
    <div id="mode-topic" style="display:none;">
        <div class="tip"><span class="tt"><strong>Tip:</strong> Enter any topic and subject to generate a lesson plan without selecting from the curriculum. Great for custom or supplementary lessons.</span></div>
        <div class="fg"><label>Topic / Lesson Title *</label><input type="text" id="t-topic" placeholder="e.g., The Water Cycle, Fractions, Philippine Independence"></div>
        <div class="fr">
            <div class="fg"><label>Subject / Learning Area *</label><select id="sel-ts"><option value="">-- Choose a Subject --</option>{% for s in subjects %}<option value="{{ s.display_name }}">{{ s.display_name }}</option>{% endfor %}</select></div>
            <div class="fg"><label>Grade Level *</label><input type="text" id="t-grade" placeholder="e.g., Grade 5, Grade 8"></div>
        </div>
        <div class="fg"><label>Learning Competencies / Objectives (optional)</label><textarea id="t-comps" rows="3" placeholder="e.g., Students will identify the stages of the water cycle&#10;Students will explain how evaporation works"></textarea></div>
    </div>

    <div class="br"><div></div><button class="btn btn-p" id="bn1" disabled>Next: Choose Competencies &#8594;</button></div>
</div>
</div>

<!-- STEP 2 -->
<div class="sp" id="step2">
<div class="crd">
    <div class="crd-t">Choose Learning Competencies</div>
    <div class="crd-s" id="s2sub">Select which competencies to include in your lesson plan.</div>
    <div class="tip"><span class="tt"><strong>Tip:</strong> You can select multiple competencies. Each one will be mapped to learning objectives in your lesson plan. Performance tasks in assessments will align to these.</span></div>
    <div class="sb"><span class="sc" id="scnt">0 selected</span><div><button class="btn btn-sm" id="bsa">Select All</button> <button class="btn btn-sm" id="bda">Deselect All</button></div></div>
    <div class="cg" id="cl"></div>
    <div class="br"><button class="btn" id="bb2">&#8592; Back</button><button class="btn btn-p" id="bn2" disabled>Next: Customize &#8594;</button></div>
</div>
</div>

<!-- STEP 3 -->
<div class="sp" id="step3">
<div class="crd">
    <div class="crd-t">&#9881;&#65039; Customize Your Lesson Plan</div>
    <div class="crd-s">Toggle sections on/off and click &#9660; to customize each one.</div>

    <div id="ttoggles">
    <div class="tc on" data-s="title_info"><span class="tc-n">Lesson Plan Header</span><span class="tc-ck">&#10003;</span><button class="tc-x" data-s="title_info">&#9660;</button></div>
    <div class="to" id="o-title_info"><div class="fg"><label>Custom Title</label><input type="text" id="f-title" placeholder="Leave blank for auto-generated title"></div><div class="fg"><label>Time Allotment</label><select id="f-time"><option value="30 minutes">30 min</option><option value="45 minutes">45 min</option><option value="60 minutes" selected>60 min</option><option value="90 minutes">90 min</option><option value="120 minutes">120 min</option></select></div><div class="tip"><span class="tt">The header includes subject, grade, quarter, domain, and standards automatically from the curriculum data.</span></div></div>

    <div class="tc on" data-s="twenty_first_century_skills"><span class="tc-n">21st Century Skills</span><span class="tc-ck">&#10003;</span><button class="tc-x" data-s="twenty_first_century_skills">&#9660;</button></div>
    <div class="to" id="o-twenty_first_century_skills"><div class="fg"><label>Focus Skills</label><div id="sk-cb"></div></div><div class="tip"><span class="tt">Skills are loaded from the MATATAG curriculum data for your selected subject. Check the most relevant ones for this lesson.</span></div></div>

    <div class="tc on" data-s="learning_objectives"><span class="tc-n">Learning Objectives (SWBAT)</span><span class="tc-ck">&#10003;</span><button class="tc-x" data-s="learning_objectives">&#9660;</button></div>
    <div class="to" id="o-learning_objectives"><div class="fr"><div class="fg"><label>Number of Objectives</label><select id="f-nobj"><option>2</option><option selected>3</option><option>4</option><option>5</option></select></div></div><div class="fg"><label>Custom Objectives (one per line)</label><textarea id="f-cobj" rows="3" placeholder="SWBAT identify the parts of...&#10;SWBAT explain the relationship..."></textarea></div><div class="tip"><span class="tt">If left blank, objectives are auto-generated from the selected learning competencies using Bloom's taxonomy verbs.</span></div></div>

    <div class="tc on" data-s="materials_technology"><span class="tc-n">Materials / Technology</span><span class="tc-ck">&#10003;</span><button class="tc-x" data-s="materials_technology">&#9660;</button></div>
    <div class="to" id="o-materials_technology"><label style="font-size:12px;display:flex;gap:6px;margin-bottom:4px;cursor:pointer"><input type="checkbox" id="f-digi" checked> Include digital tools</label><label style="font-size:12px;display:flex;gap:6px;margin-bottom:8px;cursor:pointer"><input type="checkbox" id="f-trad" checked> Include traditional materials</label><div class="fg"><label>Custom Materials (one per line)</label><textarea id="f-mats" rows="2" placeholder="Science kit&#10;Magnifying glass"></textarea></div></div>

    <div class="tc on" data-s="prior_knowledge"><span class="tc-n">Prior Knowledge / Prerequisites</span><span class="tc-ck">&#10003;</span><button class="tc-x" data-s="prior_knowledge">&#9660;</button></div>
    <div class="to" id="o-prior_knowledge"><div class="fg"><label>Custom Prerequisites (one per line)</label><textarea id="f-prereq" rows="2" placeholder="Students can count to 100"></textarea></div><div class="tip"><span class="tt">Listing prerequisites helps teachers identify if students need review before the lesson begins.</span></div></div>

    <div class="tc on" data-s="lesson_procedure"><span class="tc-n">Lesson Procedure</span><span class="tc-ck">&#10003;</span><button class="tc-x" data-s="lesson_procedure">&#9660;</button></div>
    <div class="to" id="o-lesson_procedure"><div class="fg"><label>Instructional Design Model</label></div><div class="mg"><div class="mc sel" data-m="5e"><div class="mc-n">5E Model</div><div class="mc-d">Engage, Explore, Explain, Elaborate, Evaluate</div></div><div class="mc" data-m="4as"><div class="mc-n">4A's Model</div><div class="mc-d">Activity, Analysis, Abstraction, Application</div></div><div class="mc" data-m="deped_dlp"><div class="mc-n">DepEd DLP</div><div class="mc-d">Review, Motivation, Activity, Analysis, Application, Assessment</div></div><div class="mc" data-m="design_thinking"><div class="mc-n">Design Thinking</div><div class="mc-d">Empathize, Define, Ideate, Prototype, Test</div></div></div><label style="font-size:12px;display:flex;gap:6px;margin-top:10px;cursor:pointer"><input type="checkbox" id="f-timing" checked> Include time allocation per phase</label><div class="tip"><span class="tt">The <strong>DepEd DLP</strong> format follows the official Daily Lesson Plan structure. The <strong>5E</strong> model is great for inquiry-based science and math lessons.</span></div></div>

    <div class="tc on" data-s="differentiation"><span class="tc-n">Differentiation / Scaffolding</span><span class="tc-ck">&#10003;</span><button class="tc-x" data-s="differentiation">&#9660;</button></div>
    <div class="to" id="o-differentiation"><label style="font-size:12px;display:flex;gap:6px;margin-bottom:4px;cursor:pointer"><input type="checkbox" id="f-ds" checked> Struggling Learners</label><label style="font-size:12px;display:flex;gap:6px;margin-bottom:4px;cursor:pointer"><input type="checkbox" id="f-da" checked> Advanced Learners</label><label style="font-size:12px;display:flex;gap:6px;margin-bottom:8px;cursor:pointer"><input type="checkbox" id="f-de" checked> English Language Learners</label><div class="fg"><label>Additional Strategies</label><textarea id="f-diff" rows="2" placeholder="Use manipulatives for kinesthetic learners"></textarea></div><div class="tip"><span class="tt">Differentiation ensures every student can access the lesson regardless of their current skill level.</span></div></div>

    <div class="tc on" data-s="assessment"><span class="tc-n">Assessment</span><span class="tc-ck">&#10003;</span><button class="tc-x" data-s="assessment">&#9660;</button></div>
    <div class="to" id="o-assessment"><label style="font-size:12px;display:flex;gap:6px;margin-bottom:4px;cursor:pointer"><input type="checkbox" id="f-af" checked> Formative Assessment</label><label style="font-size:12px;display:flex;gap:6px;margin-bottom:8px;cursor:pointer"><input type="checkbox" id="f-as" checked> Summative Assessment</label><div class="fg"><label>Custom Assessments</label><textarea id="f-cass" rows="2" placeholder="Group presentation rubric"></textarea></div></div>

    <div class="tc on" data-s="reflection"><span class="tc-n">Teacher Reflection</span><span class="tc-ck">&#10003;</span><button class="tc-x" data-s="reflection">&#9660;</button></div>
    <div class="to" id="o-reflection"><div class="fg"><label>Number of Prompts</label><select id="f-nref"><option>2</option><option selected>3</option><option>4</option><option>5</option></select></div><div class="fg"><label>Custom Prompts</label><textarea id="f-cref" rows="2" placeholder="Did students engage with the activity?"></textarea></div><div class="tip"><span class="tt">Reflection prompts help teachers continuously improve their practice through self-evaluation after each lesson.</span></div></div>
    </div>

    <!-- Assessment Package -->
    <div id="assess-wrap" style="margin-top:20px;padding-top:16px;border-top:2px solid var(--glass-b);">
        <div class="crd-t">Authentic Assessment Package</div>
        <div class="crd-s">Generate professional assessment tools aligned to the selected competencies.</div>
        <div class="fg"><label>Assessment Output Mode</label><select id="a-mode"><option value="none">No assessment (Lesson Plan only)</option><option value="incorporate">Include IN the lesson plan</option><option value="separate">Generate as SEPARATE document</option><option value="both">Generate BOTH (combined + separate download)</option></select></div>
        <div id="a-sec" style="display:none;">
            <div class="tip"><span class="tt"><strong>Tip:</strong> Performance Task + Rubric is the most common combination. Add Portfolio for long-term tracking, or Self & Peer Assessment for collaborative learning.</span></div>
            <div class="at-grid">
                <div class="at on" data-a="performance_task"><div><div class="at-n">Performance Task</div><div class="at-d">Real-world GRASPS scenario</div></div></div>
                <div class="at on" data-a="rubric"><div><div class="at-n">Scoring Rubric</div><div class="at-d">4-point criteria-based scale</div></div></div>
                <div class="at" data-a="portfolio"><div><div class="at-n">Portfolio</div><div class="at-d">Student work collection</div></div></div>
                <div class="at" data-a="project_based"><div><div class="at-n">Project-Based</div><div class="at-d">Multi-day real-world project</div></div></div>
                <div class="at" data-a="product_based"><div><div class="at-n">Product-Based</div><div class="at-d">Poster, model, presentation</div></div></div>
                <div class="at" data-a="self_peer"><div><div class="at-n">Self & Peer Assessment</div><div class="at-d">Evaluation forms & reflection</div></div></div>
            </div>
            <div class="fg" style="margin-top:10px;"><label>Assessment Context (optional)</label><textarea id="a-ctx" rows="2" placeholder="e.g., Students apply learning to a community garden project..."></textarea></div>
        </div>
    </div>

    <!-- Quiz Generation -->
    <div id="quiz-wrap" style="margin-top:20px;padding-top:16px;border-top:2px solid var(--glass-b);">
        <div class="crd-t">Quiz Generation</div>
        <div class="crd-s">Generate a downloadable quiz based on the selected competencies.</div>
        <div style="display:flex;align-items:center;gap:12px;padding:14px;border:1.5px solid var(--glass-b);border-radius:14px;margin-bottom:10px;background:rgba(255,255,255,0.5);" id="quiz-box">
            <label class="sw"><input type="checkbox" id="f-quiz"><span class="sl"></span></label>
            <div><div style="font-size:13px;font-weight:700;font-family:'Space Grotesk',sans-serif;">Enable Quiz Generation</div><div style="font-size:11px;color:var(--text-s);">Creates a standalone quiz with answer key. Download separately for LMS upload (not in SCORM).</div></div>
        </div>
        <div id="quiz-opts" style="display:none;">
            <div class="fr">
                <div class="fg"><label>Number of Questions (per type)</label><select id="f-qnum"><option value="5" selected>5 questions</option><option value="10">10 questions</option><option value="15">15 questions</option><option value="20">20 questions</option></select></div>
            </div>
            <label style="font-size:12px;font-weight:600;display:block;margin-bottom:6px;font-family:'Space Grotesk',sans-serif;color:var(--c2);">Question Types</label>
            <div class="qt-grid">
                <div class="qt on" data-qt="multiple_choice"><span style="font-size:18px;">&#9898;</span><div><div class="qt-n">Multiple Choice</div><div class="qt-d">4-option questions (A-D)</div></div></div>
                <div class="qt on" data-qt="true_false"><span style="font-size:18px;">&#9989;</span><div><div class="qt-n">True or False</div><div class="qt-d">Statement-based questions</div></div></div>
                <div class="qt" data-qt="identification"><span style="font-size:18px;">&#9999;&#65039;</span><div><div class="qt-n">Identification</div><div class="qt-d">Fill-in-the-blank</div></div></div>
                <div class="qt" data-qt="matching"><span style="font-size:18px;"></span><div><div class="qt-n">Matching Type</div><div class="qt-d">Two-column matching</div></div></div>
            </div>
            <div class="tip" style="margin-top:10px;"><span class="tt"><strong>Tip:</strong> The quiz is a SEPARATE downloadable activity — not included in the SCORM package. Use the "Download Quiz (LMS)" button to save it, then upload to Moodle, Canvas, or Brightspace as a Quiz activity.</span></div>
        </div>
    </div>

    <!-- AI Status (always on) -->
    <div style="margin-top:20px;padding-top:16px;border-top:2px solid var(--glass-b);">
        <div style="display:flex;align-items:center;gap:12px;padding:14px;border:1.5px solid rgba(0,187,214,0.35);border-radius:14px;background:rgba(0,187,214,0.07);" id="ai-box">
            <div style="width:36px;height:36px;border-radius:50%;background:var(--c1);display:flex;align-items:center;justify-content:center;flex-shrink:0;"><span style="color:#fff;font-size:18px;"></span></div>
            <div style="flex:1;"><div style="font-size:13px;font-weight:700;font-family:'Space Grotesk',sans-serif;">AI-Powered Generation (Claude)</div><div style="font-size:11px;color:var(--text-s);">All content is generated by AI for detailed, classroom-ready lesson plans, assessments, and quizzes.</div></div>
            <span style="background:var(--success);color:#fff;padding:3px 12px;border-radius:16px;font-size:11px;font-weight:700;font-family:'Space Grotesk',sans-serif;flex-shrink:0;">ACTIVE</span>
        </div>
        <input type="hidden" id="f-ai" value="on">
        <input type="hidden" id="f-aip" value="anthropic">
        <input type="hidden" id="f-aik" value="">
    </div>

    <!-- Activities Preview Banner -->
    <div class="act-banner" style="margin-top:18px;">
        
        <div class="act-banner-txt">
            <div class="abt">&#10024; After generating, you'll get 16 interactive games &amp; a PowerPoint!</div>
            <div class="abs">Wheel of Names · Crossword · Word Search · Flashcards · Jeopardy · Kahoot-Style Quiz · Hangman · Bingo · and more — all auto-filled from your lesson content.</div>
        </div>
    </div>

    <div class="br"><button class="btn" id="bb3">&#8592; Back</button><button class="btn btn-g" id="bgen">&#9889; Generate Lesson Plan</button></div>
</div>
</div>

<!-- STEP 4 -->
<div class="sp" id="step4">
<div class="crd">
    <div class="crd-t" id="out-t">Your Generated Lesson Plan</div>
    <div class="crd-s" id="out-s"></div>
    <div class="tabs" id="out-tabs"><button class="tab a" id="t-lp">Lesson Plan</button><button class="tab" id="t-as">Assessment</button><button class="tab" id="t-qz" style="display:none">Quiz</button><button class="tab" id="t-ppst" style="display:none">RPMS-PPST</button></div>

    <!--  ACTIVITIES & PPTX QUICK ACTIONS  -->
    <div class="qa-strip">
        <button class="qa-btn qa-btn-act" id="b-activities">
            
            <div class="qt-wrap">
                <div class="ql">Open Activities</div>
                <div class="qs">16 interactive games · auto-populated from your lesson</div>
            </div>
        </button>
        <button class="qa-btn qa-btn-pptx" id="b-pptx">
            
            <div class="qt-wrap">
                <div class="ql">Download PPTX</div>
                <div class="qs">Branded PowerPoint · ready for classroom presentation</div>
            </div>
        </button>
    </div>

    <div class="ob" id="out-b"></div>
    <div class="oa">
        <button class="btn btn-save-lp" id="b-save-lp">Save Lesson Plan</button>
        <button class="btn" id="b-copy">Copy</button>
        <button class="btn" id="b-dl">Download .md</button>
        <button class="btn" id="b-gdoc">Google Doc</button>
        <button class="btn" id="b-ppst">RPMS-PPST</button>
        <button class="btn" id="b-dlp" style="display:none">PPST .md</button>
        <button class="btn btn-s2" id="b-scorm">Download SCORM</button>
        <button class="btn" id="b-dla" style="display:none">Assessment .md</button>
        <span id="quiz-dl-grp" style="display:none;gap:4px;align-items:center;flex-wrap:wrap;">
            <span style="font-size:11px;font-weight:600;color:var(--text-s);padding:2px 2px;font-family:'Space Grotesk',sans-serif;">Quiz&#x25BE;</span>
            <button class="btn btn-sm" id="b-dlq-md" title="Human-readable reference">.md</button>
            <button class="btn btn-sm" id="b-dlq-gift" title="Import into Moodle">Moodle GIFT</button>
            <button class="btn btn-sm" id="b-dlq-qti" title="Import into Canvas or Brightspace">QTI (Canvas/D2L)</button>
        </span>
        <button class="btn" id="b-pr">Print</button>
        <button class="btn btn-p" id="b-new">&#43; Create Another</button>
    </div>
    <div id="lp-save-msg" style="display:none;margin:8px 0 0;font-size:12px;color:var(--c1);font-weight:600;font-family:'Space Grotesk',sans-serif;"></div>
    <div class="tip"><span class="tt"><strong>SCORM Package:</strong> The .zip contains the lesson plan and assessment (if generated). Upload via Add Activity &gt; SCORM Package in Moodle, Canvas, or Brightspace. <strong>Note:</strong> The quiz is a separate LMS activity — use "Download Quiz (LMS)" to save it independently.</span></div>

    <!-- Section Regen Panel -->
    <div id="regen-panel" style="display:none;position:fixed;bottom:0;left:50%;transform:translateX(-50%);right:auto;z-index:200;background:rgba(240,249,251,0.96);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-top:2px solid rgba(0,187,214,0.3);box-shadow:0 -4px 32px rgba(0,187,214,0.12);padding:20px 24px;width:100%;max-width:700px;border-radius:18px 18px 0 0;">
      <div style="font-size:12px;font-weight:700;color:var(--c2);margin-bottom:10px;">&#8635; Regenerate: <span id="regen-sec-name" style="color:var(--c1)"></span></div>
      <div id="regen-presets" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px;">
        <button class="rp-chip" data-v="Make it shorter">Shorter</button>
        <button class="rp-chip" data-v="Make activities more collaborative">More collaborative</button>
        <button class="rp-chip" data-v="Add a kinesthetic or hands-on activity">Kinesthetic activity</button>
        <button class="rp-chip" data-v="Add more detail and examples">More detailed</button>
        <button class="rp-chip" data-v="Simplify the language for lower reading levels">Simplify language</button>
      </div>
      <input id="regen-instr" type="text" placeholder="Or describe what to change..." style="width:100%;padding:9px 12px;border:1.5px solid var(--border);border-radius:8px;font-size:13px;margin-bottom:12px;">
      <div style="display:flex;gap:8px;">
        <button class="btn btn-p" id="regen-go">&#8635; Regenerate</button>
        <button class="btn" id="regen-cancel">Cancel</button>
      </div>
    </div>

    <!-- Rating Widget -->
    <div id="rating-section" style="margin-top:20px;padding-top:16px;border-top:2px solid var(--glass-b);">
        <div class="crd-t">&#11088; Rate This Lesson Plan</div>
        <div class="crd-s">Help us improve by sharing your feedback.</div>
        <div id="star-row" style="display:flex;gap:6px;margin:10px 0;">
            <span class="star" data-v="1">&#9733;</span>
            <span class="star" data-v="2">&#9733;</span>
            <span class="star" data-v="3">&#9733;</span>
            <span class="star" data-v="4">&#9733;</span>
            <span class="star" data-v="5">&#9733;</span>
        </div>
        <div class="fg"><label>Comment (optional)</label><textarea id="r-comment" rows="2" placeholder="What did you like? What could be improved?"></textarea></div>
        <button class="btn btn-p" id="r-submit" disabled>Submit Feedback</button>
        <div id="r-msg" style="display:none;color:var(--success);font-size:13px;margin-top:8px;font-weight:600;">&#10003; Thank you for your feedback!</div>
    </div>
</div>
</div>

</div>

<!-- Progress -->
<div class="po" id="po"><div class="pb"><div class="pb-t">&#9889; Generating Lesson Plan</div><div class="pb-s" id="ps">Please wait...</div><div class="pb-p" id="pp">0%</div><div class="pb-bg"><div class="pb-fl" id="pf"></div></div><div class="pb-st" id="pt">Preparing curriculum data...</div></div></div>

<div class="ft">SKOOLED-AI &bull; AI-Generated Lesson Plans</div>

<script>
document.addEventListener("DOMContentLoaded",function(){
const $=s=>document.querySelector(s),$$=s=>document.querySelectorAll(s);
const _T=document.querySelector('meta[name="auth-token"]')?.content||'';
function aurl(u){if(!_T)return u;return u+(u.includes('?')?'&':'?')+'_t='+encodeURIComponent(_T);}
let step=1,selC=new Set(),cData=[],skData=[],rawLP="",rawAS="",rawQZ="",rawPPST="",activeTab="lp",genMode="curriculum";

// ── Local Storage Keys ──────────────────────────────────────────────────
const GEN_DRAFT_KEY   = 'skooled_gen_draft';
const GEN_CONTENT_KEY = 'skooled_gen_content';

// ── Form Draft ─────────────────────────────────────────────────────────
let _genDraftTimer = null;
function saveGenDraft(){
  const state={
    mode:    genMode,
    subject: $("#sel-s")?.value||"",
    grade:   $("#sel-g")?.value||"",
    quarter: $("#sel-q")?.value||"",
    topic:   $("#t-topic")?.value||"",
    topicGrade:   $("#t-grade")?.value||"",
    topicSubject: $("#sel-ts")?.value||"",
    competencies: $("#t-comps")?.value||"",
    savedAt: new Date().toISOString(),
  };
  localStorage.setItem(GEN_DRAFT_KEY, JSON.stringify(state));
}
function scheduleGenDraft(){ clearTimeout(_genDraftTimer); _genDraftTimer=setTimeout(saveGenDraft,1500); }

function restoreFormInputs(state){
  if(!state) return;
  if(state.mode==="topic"){
    switchMode("topic");
    if($("#t-topic")) $("#t-topic").value=state.topic||"";
    if($("#t-grade")) $("#t-grade").value=state.topicGrade||"";
    if($("#sel-ts")){ $("#sel-ts").value=state.topicSubject||""; }
    if($("#t-comps")) $("#t-comps").value=state.competencies||"";
    updateTopicNextBtn();
    return;
  }
  if(!state.subject) return;
  switchMode("curriculum");
  const S2=$("#sel-s"),G2=$("#sel-g"),Q2=$("#sel-q");
  S2.value=state.subject;
  S2.dispatchEvent(new Event("change")); // triggers grade fetch
  setTimeout(()=>{
    if(state.grade){ G2.value=state.grade; G2.dispatchEvent(new Event("change")); }
    setTimeout(()=>{
      if(state.quarter) Q2.value=state.quarter;
      const hasQ=Q2.options.length>1;
      $("#bn1").disabled=!(S2.value&&G2.value&&(Q2.value||!hasQ));
    },700);
  },700);
}

// ── Content Save / Restore ──────────────────────────────────────────────
function saveGenContent(label){
  localStorage.setItem(GEN_CONTENT_KEY, JSON.stringify({rawLP,rawAS,rawQZ,label,savedAt:new Date().toISOString()}));
}

function _autoGenActivities(){
  if(!rawLP) return;
  const apiKey  = document.getElementById("f-aik")?.value || "";
  const provider = document.getElementById("f-aip")?.value || "anthropic";
  localStorage.removeItem("skooled_activity_data");
  localStorage.removeItem("skooled_activity_lesson_md");
  fetch(aurl("/api/generate-activity-content"),{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({lesson_md:rawLP, quiz_md:rawQZ||"", api_key:apiKey, ai_provider:provider})
  }).then(r=>r.json()).then(d=>{
    if(!d.error){
      localStorage.setItem("skooled_activity_data",      JSON.stringify(d));
      localStorage.setItem("skooled_activity_lesson_md", rawLP);
    }
  }).catch(()=>{});
}

function timeAgo(iso){
  const s=Math.floor((Date.now()-new Date(iso).getTime())/1000);
  if(s<60) return s+"s ago";
  if(s<3600) return Math.floor(s/60)+"m ago";
  return Math.floor(s/3600)+"h ago";
}

function go(n){$$(".sp").forEach(p=>p.classList.remove("a"));$(`#step${n}`).classList.add("a");$$(".stp").forEach((s,i)=>{s.classList.remove("a","d");if(i+1<n)s.classList.add("d");if(i+1===n)s.classList.add("a");});step=n;window.scrollTo({top:0,behavior:"smooth"});}

function switchMode(m){
    genMode=m;
    $("#mode-curriculum").style.display=m==="curriculum"?"block":"none";
    $("#mode-topic").style.display=m==="topic"?"block":"none";
    $$(".mode-tab").forEach(t=>t.classList.toggle("a",t.dataset.mode===m));
    if(m==="curriculum"){
        const hasQ=Q.options.length>1;
        $("#bn1").disabled=!(S.value&&G.value&&(Q.value||!hasQ));
        $("#bn1").textContent="Next: Choose Competencies \u2192";
    }else{
        $("#bn1").textContent="Next: Customize \u2192";
        updateTopicNextBtn();
    }
}
function updateTopicNextBtn(){
    const t=($("#t-topic")?.value||"").trim();
    const ts=($("#sel-ts")?.value||"");
    const tg=($("#t-grade")?.value||"").trim();
    $("#bn1").disabled=!(t&&ts&&tg);
}
function updateStep3ForMode(){}

$$(".mode-tab").forEach(t=>{t.addEventListener("click",function(){switchMode(this.dataset.mode); scheduleGenDraft();});});
["t-topic","t-grade"].forEach(id=>{const el=$("#"+id);if(el)el.addEventListener("input",()=>{if(genMode==="topic")updateTopicNextBtn(); scheduleGenDraft();});});
const TS=$("#sel-ts");if(TS)TS.addEventListener("change",()=>{if(genMode==="topic")updateTopicNextBtn(); scheduleGenDraft();});

const S=$("#sel-s"),G=$("#sel-g"),Q=$("#sel-q");

S.addEventListener("change",function(){G.innerHTML='<option value="">-- Choose Grade --</option>';G.disabled=true;Q.innerHTML='<option value="">-- Choose Quarter --</option>';Q.disabled=true;$("#bn1").disabled=true;if(!this.value)return;fetch(aurl(`/api/grades/${this.value}`)).then(r=>r.json()).then(g=>{g.forEach(v=>{const o=document.createElement("option");o.value=v;o.textContent=v.match(/^[0-9]/)?`Grade ${v}`:v;G.appendChild(o);});G.disabled=false;});fetch(aurl(`/api/curriculum-context/${this.value}`)).then(r=>r.json()).then(c=>{skData=c.skills||[];const b=$("#sk-cb");b.innerHTML="";skData.forEach(s=>{const l=document.createElement("label");l.style.cssText="font-size:12px;display:flex;gap:6px;margin-bottom:3px;cursor:pointer;";l.innerHTML=`<input type="checkbox" class="skc" value="${s.skill_name}"> ${s.skill_name}`;b.appendChild(l);});});});

G.addEventListener("change",function(){Q.innerHTML='<option value="">-- Choose Quarter --</option>';Q.disabled=true;$("#bn1").disabled=true;if(!this.value)return;fetch(aurl(`/api/quarters/${S.value}/${this.value}`)).then(r=>r.json()).then(q=>{if(!q.length){$("#bn1").disabled=false;return;}q.forEach(v=>{const o=document.createElement("option");o.value=v;o.textContent=`Quarter ${v}`;Q.appendChild(o);});Q.disabled=false;});});

Q.addEventListener("change",function(){$("#bn1").disabled=!this.value; scheduleGenDraft();});
if($("#t-comps")) $("#t-comps").addEventListener("input", scheduleGenDraft);

$("#bn1").addEventListener("click",function(){
    if(genMode==="topic"){
        const topic=($("#t-topic")?.value||"").trim();
        const tsubj=($("#sel-ts")?.value||"");
        const tgrade=($("#t-grade")?.value||"").trim();
        const tcomps=($("#t-comps")?.value||"").trim();
        if(!topic||!tsubj)return;
        window._topicCtx={topic,subject_name:tsubj,grade:tgrade,competencies_text:tcomps};
        updateStep3ForMode();
        go(3);
        return;
    }
    const s=S.value,g=G.value,q=Q.value;if(!s||!g)return;let u=`/api/competencies/${s}?grade=${encodeURIComponent(g)}`;if(q)u+=`&quarter=${encodeURIComponent(q)}`;this.disabled=true;this.textContent="Loading...";fetch(aurl(u)).then(r=>r.json()).then(c=>{cData=c;selC.clear();renderC();const sn=S.options[S.selectedIndex].text,gn=G.options[G.selectedIndex].text,qn=q?` - Quarter ${q}`:"";$("#s2sub").textContent=`${sn} - ${gn}${qn} (${c.length} competencies)`;go(2);this.disabled=false;this.textContent="Next: Choose Competencies \u2192";});
});

function renderC(){const l=$("#cl");l.innerHTML="";if(!cData.length){l.innerHTML='<div style="padding:20px;text-align:center;color:var(--text-s)">No competencies found.</div>';return;}cData.forEach(c=>{const d=document.createElement("div");d.className="cc";d.dataset.id=c.id;const cb=document.createElement("input");cb.type="checkbox";const info=document.createElement("div");info.innerHTML=`<div class="cc-c">${c.lc_id||"LC-"+c.id}</div><div class="cc-d">${c.learning_competency}</div><div class="cc-m">${[c.domain,c.blooms_level?"Bloom's: "+c.blooms_level:""].filter(Boolean).join(" | ")}</div>`;d.appendChild(cb);d.appendChild(info);d.addEventListener("click",e=>{if(e.target!==cb)cb.checked=!cb.checked;if(cb.checked){selC.add(c.id);d.classList.add("sel");}else{selC.delete(c.id);d.classList.remove("sel");}upC();});l.appendChild(d);});upC();}
function upC(){$("#scnt").textContent=`${selC.size} of ${cData.length} selected`;$("#bn2").disabled=selC.size===0;}

$("#bsa").addEventListener("click",()=>{$$(".cc").forEach(d=>{d.querySelector("input").checked=true;d.classList.add("sel");selC.add(parseInt(d.dataset.id));});upC();});
$("#bda").addEventListener("click",()=>{$$(".cc").forEach(d=>{d.querySelector("input").checked=false;d.classList.remove("sel");});selC.clear();upC();});
$("#bb2").addEventListener("click",()=>go(1));
$("#bn2").addEventListener("click",()=>go(3));
$("#bb3").addEventListener("click",()=>go(genMode==="topic"?1:2));

// Toggle sections
$$("#ttoggles .tc").forEach(c=>{c.addEventListener("click",function(e){if(e.target.closest(".tc-x"))return;this.classList.toggle("on");});});
$$(".tc-x").forEach(b=>{b.addEventListener("click",function(e){e.stopPropagation();const o=$(`#o-${this.dataset.s}`);o.classList.toggle("op");this.classList.toggle("op");});});

// Model cards
$$(".mc").forEach(c=>{c.addEventListener("click",function(){$$(".mc").forEach(x=>x.classList.remove("sel"));this.classList.add("sel");});});

// Assessment types
$$(".at").forEach(c=>{c.addEventListener("click",function(){this.classList.toggle("on");});});
$("#a-mode").addEventListener("change",function(){$("#a-sec").style.display=this.value!=="none"?"block":"none";});

// Quiz toggle & types
$("#f-quiz").addEventListener("change",function(){$("#quiz-opts").style.display=this.checked?"block":"none";$("#quiz-box").style.borderColor=this.checked?"var(--c1)":"var(--border)";});
$$(".qt").forEach(c=>{c.addEventListener("click",function(){this.classList.toggle("on");});});

// AI is always on (server key pre-configured)

// Progress - adapts speed based on AI vs template mode
const pStepsFast=[{p:20,t:"Loading curriculum data..."},{p:50,t:"Building lesson plan..."},{p:80,t:"Formatting output..."},{p:95,t:"Almost done..."}];
const pStepsAI=[{p:3,t:"Loading curriculum data..."},{p:8,t:"Reading learning competencies..."},{p:12,t:"Gathering content standards..."},{p:16,t:"Building AI prompt..."},{p:20,t:"Sending to AI (Claude)..."},{p:25,t:"AI is writing your lesson plan..."},{p:30,t:"Generating lesson header..."},{p:38,t:"Writing learning objectives..."},{p:46,t:"Creating lesson procedure..."},{p:54,t:"Detailing teacher & student activities..."},{p:62,t:"Adding differentiation strategies..."},{p:70,t:"Building assessment section..."},{p:78,t:"Writing teacher reflection..."},{p:85,t:"AI is finalizing content..."},{p:90,t:"Formatting output..."},{p:93,t:"Almost done..."}];
function showP(isAI){
    const steps=isAI?pStepsAI:pStepsFast;
    const interval=isAI?1800:200;
    const est=isAI?"Estimated time: 15-30 seconds":"Estimated time: under 2 seconds";
    $("#po").classList.add("a");
    $("#pp").textContent="0%";$("#pf").style.width="0%";
    $("#ps").textContent=est;
    let i=0,curP=0;
    const waitMsgs=["AI is still writing...","Almost there, please wait...","Finalizing your content...","Reviewing and polishing..."];
    let wm=0;
    const iv=setInterval(()=>{if(i<steps.length){curP=steps[i].p;$("#pp").textContent=curP+"%";$("#pf").style.width=curP+"%";$("#pt").textContent=steps[i].t;i++;}else if(curP<99){curP=Math.min(99,parseFloat((curP+0.3).toFixed(1)));$("#pp").textContent=Math.floor(curP)+"%";$("#pf").style.width=curP+"%";$("#pt").textContent=waitMsgs[wm++%waitMsgs.length];}},interval);
    return function(){clearInterval(iv);$("#pp").textContent="100%";$("#pf").style.width="100%";$("#pt").textContent="Done! Loading your lesson plan...";setTimeout(()=>$("#po").classList.remove("a"),500);};
}

// Render tabbed sections within output box
function renderTabbed(html,container){
    const parts=html.split(/<h2>/i);
    if(parts.length<3){container.innerHTML=html;return;}
    const intro=parts[0];
    const sections=[];
    for(let i=1;i<parts.length;i++){
        const closeIdx=parts[i].indexOf('</h2>');
        if(closeIdx===-1){sections.push({title:'Section '+i,content:'<h2>'+parts[i]});}
        else{
            const title=parts[i].substring(0,closeIdx).replace(/<[^>]*>/g,'').trim();
            const content=parts[i].substring(closeIdx+5);
            sections.push({title:title,content:content});
        }
    }
    let tabBar='<div class="section-tabs">';
    tabBar+='<div class="section-tab active" data-idx="all">View All</div>';
    for(let i=0;i<sections.length;i++){tabBar+='<div class="section-tab" data-idx="'+i+'">'+sections[i].title+'</div>';}
    tabBar+='</div>';
    let panes='<div class="section-pane active" data-pane="all">'+intro;
    for(let i=0;i<sections.length;i++){panes+='<h2>'+sections[i].title+'</h2>'+sections[i].content;}
    panes+='</div>';
    for(let i=0;i<sections.length;i++){
        const regenBtn=activeTab==="lp"?`<button class="sec-regen-btn" data-title="${sections[i].title.replace(/"/g,'&quot;')}">&#8635; Regenerate</button>`:'';
        panes+='<div class="section-pane" data-pane="'+i+'"><div class="sec-hdr"><h2>'+sections[i].title+'</h2>'+regenBtn+'</div>'+sections[i].content+'</div>';
    }
    container.innerHTML=tabBar+panes;
    const tabs=container.querySelectorAll('.section-tab');
    tabs.forEach(function(tab){
        tab.addEventListener('click',function(){
            tabs.forEach(function(t){t.classList.remove('active');});
            tab.classList.add('active');
            const idx=tab.getAttribute('data-idx');
            container.querySelectorAll('.section-pane').forEach(function(p){
                p.classList.remove('active');
                if(p.getAttribute('data-pane')===idx)p.classList.add('active');
            });
        });
    });
}

// GENERATE
$("#bgen").addEventListener("click",function(){
if(genMode==="curriculum"&&!selC.size)return;
const gm=()=>{const s=$(".mc.sel");return s?s.dataset.m:"5e";};
const ln=id=>($(id)?.value||"").split("\n").map(s=>s.trim()).filter(Boolean);
const on=s=>$(`#ttoggles .tc[data-s="${s}"]`)?.classList.contains("on");
const am=$("#a-mode").value;
const at=Array.from($$(".at.on")).map(c=>c.dataset.a);
const wantQuiz=$("#f-quiz").checked;
const quizTypes=Array.from($$(".qt.on")).map(c=>c.dataset.qt);

const cfg={
title_info:{enabled:on("title_info"),customizable_fields:{custom_title:$("#f-title")?.value||"",time_allotment:$("#f-time")?.value||"60 minutes"}},
twenty_first_century_skills:{enabled:on("twenty_first_century_skills"),customizable_fields:{focus_skills:Array.from($$(".skc:checked")).map(c=>c.value)}},
learning_objectives:{enabled:on("learning_objectives"),customizable_fields:{num_objectives:parseInt($("#f-nobj")?.value||"3"),custom_objectives:ln("#f-cobj")}},
materials_technology:{enabled:on("materials_technology"),customizable_fields:{include_digital_tools:$("#f-digi")?.checked!==false,include_traditional:$("#f-trad")?.checked!==false,custom_materials:ln("#f-mats")}},
prior_knowledge:{enabled:on("prior_knowledge"),customizable_fields:{custom_prerequisites:ln("#f-prereq")}},
lesson_procedure:{enabled:on("lesson_procedure"),customizable_fields:{model:gm(),include_timing:$("#f-timing")?.checked!==false,custom_activities:{}}},
differentiation:{enabled:on("differentiation"),customizable_fields:{include_struggling:$("#f-ds")?.checked!==false,include_advanced:$("#f-da")?.checked!==false,include_ell:$("#f-de")?.checked!==false,custom_strategies:ln("#f-diff")}},
assessment:{enabled:on("assessment"),customizable_fields:{include_formative:$("#f-af")?.checked!==false,include_summative:$("#f-as")?.checked!==false,custom_assessments:ln("#f-cass")}},
reflection:{enabled:on("reflection"),customizable_fields:{num_prompts:parseInt($("#f-nref")?.value||"3"),custom_prompts:ln("#f-cref")}},
};

const ai=true,ak=$("#f-aik")?.value||"",ap=$("#f-aip")?.value||"anthropic";

// ── Topic Mode ───────────────────────────────────────────────
if(genMode==="topic"){
    const ctx=window._topicCtx||{};
    if(!ctx.topic||!ctx.subject_name)return;
    const done=showP(true);
    const tps=[fetch(aurl("/api/generate-topic"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({topic:ctx.topic,subject_name:ctx.subject_name,grade:ctx.grade||"",competencies_text:ctx.competencies_text||"",template_config:cfg,use_ai:ai,api_key:ak,ai_provider:ap})}).then(r=>r.json())];
    const tNeedA=am!=="none"&&at.length>0;
    if(tNeedA)tps.push(fetch(aurl("/api/generate-assessment-topic"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({topic:ctx.topic,subject_name:ctx.subject_name,grade:ctx.grade||"",competencies_text:ctx.competencies_text||"",assessment_config:{types:at,custom_context:$("#a-ctx")?.value||""},use_ai:ai,api_key:ak,ai_provider:ap})}).then(r=>r.json()));
    if(wantQuiz&&quizTypes.length>0)tps.push(fetch(aurl("/api/generate-quiz-topic"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({topic:ctx.topic,subject_name:ctx.subject_name,grade:ctx.grade||"",competencies_text:ctx.competencies_text||"",quiz_config:{types:quizTypes,num_questions:parseInt($("#f-qnum")?.value||"5")},use_ai:ai,api_key:ak,ai_provider:ap})}).then(r=>r.json()));
    Promise.all(tps).then(trs=>{done();
    const tlp=trs[0];const tas=tNeedA?trs[1]:null;const tqzIdx=tNeedA?2:1;const tqz=(wantQuiz&&quizTypes.length>0)?trs[tqzIdx]:null;
    setTimeout(()=>{rawLP=tlp.content||"";rawAS=tas?.content||"";rawQZ=tqz?.content||"";
    const _outLabel=`Topic: ${ctx.topic} | ${ctx.subject_name}${ctx.grade?" Grade "+ctx.grade:""}`;
    $("#out-s").textContent=_outLabel+" | "+new Date().toLocaleString();
    if(tlp.error){$("#out-b").innerHTML=`<div style="color:var(--danger);padding:20px"><strong>Error:</strong> ${tlp.error}</div>`;go(4);return;}
    const tHasAS=!!rawAS;const tHasQZ=!!rawQZ;
    if(am==="incorporate"&&tHasAS){rawLP+="\n\n---\n\n# AUTHENTIC ASSESSMENT PACKAGE\n\n"+rawAS;rawAS="";}
    if(tHasAS||tHasQZ){$("#out-tabs").classList.add("on");$("#t-as").style.display=tHasAS?"inline-flex":"none";$("#t-qz").style.display=tHasQZ?"inline-flex":"none";}else{$("#out-tabs").classList.remove("on");}
    $("#b-dla").style.display=(tHasAS&&am!=="incorporate")?"inline-flex":"none";$("#quiz-dl-grp").style.display=tHasQZ?"inline-flex":"none";
    if(am==="both"&&tHasAS){rawLP=rawLP+"\n\n---\n\n# AUTHENTIC ASSESSMENT PACKAGE\n\n"+rawAS;rawAS="";}
    let tParts=["Lesson Plan"];if(rawAS)tParts.push("Assessment");if(tHasQZ)tParts.push("Quiz");
    $("#out-t").textContent=tParts.join(" + ");
    saveGenContent(_outLabel);
    _autoGenActivities();
    setTab("lp");go(4);},700);
    }).catch(e=>{done();setTimeout(()=>{$("#out-b").innerHTML=`<div style="color:var(--danger);padding:20px"><strong>Error:</strong> ${e.message}</div>`;go(4);},700);});
    return;
}

// ── Curriculum Mode ──────────────────────────────────────────
const ids=Array.from(selC);
const done=showP(true);
const ps=[fetch(aurl("/api/generate"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({subject_id:S.value,competency_ids:ids,template_config:cfg,use_ai:ai,api_key:ak,ai_provider:ap})}).then(r=>r.json())];
const needA=am!=="none"&&at.length>0;
if(needA)ps.push(fetch(aurl("/api/generate-assessment"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({subject_id:S.value,competency_ids:ids,assessment_config:{types:at,custom_context:$("#a-ctx")?.value||""},use_ai:ai,api_key:ak,ai_provider:ap})}).then(r=>r.json()));
if(wantQuiz&&quizTypes.length>0)ps.push(fetch(aurl("/api/generate-quiz"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({subject_id:S.value,competency_ids:ids,quiz_config:{types:quizTypes,num_questions:parseInt($("#f-qnum")?.value||"5")},use_ai:ai,api_key:ak,ai_provider:ap})}).then(r=>r.json()));

Promise.all(ps).then(rs=>{done();
const lp=rs[0];
const as=needA?rs[1]:null;
const qzIdx=needA?2:1;
const qz=(wantQuiz&&quizTypes.length>0)?rs[qzIdx]:null;

setTimeout(()=>{rawLP=lp.content||"";rawAS=as?.content||"";rawQZ=qz?.content||"";
const sn=S.options[S.selectedIndex].text,gn=G.options[G.selectedIndex].text;
const _outLabel=`${sn} - ${gn} | ${selC.size} competencies`;
$("#out-s").textContent=_outLabel+" | "+new Date().toLocaleString();
if(lp.error){$("#out-b").innerHTML=`<div style="color:var(--danger);padding:20px"><strong>Error:</strong> ${lp.error}</div>`;go(4);return;}

// Determine tabs visibility
const hasAS=!!rawAS;
const hasQZ=!!rawQZ;
const showTabs=hasAS||hasQZ;

if(am==="incorporate"&&hasAS){rawLP+="\n\n---\n\n# AUTHENTIC ASSESSMENT PACKAGE\n\n"+rawAS;rawAS="";}

// Show/hide tabs
if(showTabs||(am==="separate"&&hasAS)){
    $("#out-tabs").classList.add("on");
    $("#t-as").style.display=hasAS?"inline-flex":"none";
    $("#t-qz").style.display=hasQZ?"inline-flex":"none";
}else{
    $("#out-tabs").classList.remove("on");
}

// Show/hide download buttons
$("#b-dla").style.display=(hasAS&&am!=="incorporate")?"inline-flex":"none";
$("#quiz-dl-grp").style.display=hasQZ?"inline-flex":"none";

if(am==="both"&&hasAS){
    const c=rawLP+"\n\n---\n\n# AUTHENTIC ASSESSMENT PACKAGE\n\n"+rawAS;
    rawLP=c;
}

// Set title
let titleParts=["Lesson Plan"];
if(rawAS)titleParts.push("Assessment");
if(hasQZ)titleParts.push("Quiz");
$("#out-t").textContent=titleParts.join(" + ");

saveGenContent(_outLabel);
_autoGenActivities();

// Render with section tabs
setTab("lp");
go(4);},700);
}).catch(e=>{done();setTimeout(()=>{$("#out-b").innerHTML=`<div style="color:var(--danger);padding:20px"><strong>Error:</strong> ${e.message}</div>`;go(4);},700);});
});

function setTab(t){
    activeTab=t;
    $$(".tabs .tab").forEach(b=>b.classList.remove("a"));
    if(t==="lp"){
        $("#t-lp").classList.add("a");
        renderTabbed(md2h(rawLP),$("#out-b"));
    }else if(t==="assess"){
        $("#t-as").classList.add("a");
        renderTabbed(md2h(rawAS),$("#out-b"));
    }else if(t==="quiz"){
        $("#t-qz").classList.add("a");
        renderTabbed(md2h(rawQZ),$("#out-b"));
    }else if(t==="ppst"){
        $("#t-ppst").classList.add("a");
        renderTabbed(md2h(rawPPST),$("#out-b"));
    }
}
$("#t-lp").addEventListener("click",()=>setTab("lp"));
$("#t-as").addEventListener("click",()=>setTab("assess"));
$("#t-qz").addEventListener("click",()=>setTab("quiz"));
$("#t-ppst").addEventListener("click",()=>setTab("ppst"));

function md2h(m){if(!m)return"";let h=m.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
h=h.replace(/^&gt; (.+)$/gm,"<blockquote>$1</blockquote>");h=h.replace(/<\/blockquote>\n<blockquote>/g,"<br>");
h=h.replace(/^---$/gm,"<hr>");
h=h.replace(/- \[ \]/g,"\u2610");h=h.replace(/- \[x\]/g,"\u2611");
h=h.replace(/^#### (.+)$/gm,"<h4>$1</h4>");
h=h.replace(/^### (.+)$/gm,"<h3>$1</h3>");h=h.replace(/^## (.+)$/gm,"<h2>$1</h2>");h=h.replace(/^# (.+)$/gm,"<h1>$1</h1>");
h=h.replace(/\*\*\*(.+?)\*\*\*/g,"<strong><em>$1</em></strong>");h=h.replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>");h=h.replace(/\*(.+?)\*/g,"<em>$1</em>");
// Convert **N.** bold-numbered items → list items (AI often formats these with bold numbers)
h=h.replace(/^<strong>(\d+)\.<\/strong>\s*(.+)$/gm,"<li>$2</li>");
h=h.replace(/^\|(.+)\|$/gm,function(m){const c=m.split("|").filter(c=>c.trim());if(c.every(c=>/^[\s\-:]+$/.test(c)))return"<!--s-->";return"<tr>"+c.map(c=>`<td>${c.trim()}</td>`).join("")+"</tr>";});
h=h.replace(/((<tr>.*?<\/tr>\n?)+)/g,"<table>$1</table>");h=h.replace(/<!--s-->\n?/g,"");
h=h.replace(/^\s*[-*] (.+)$/gm,"<li>$1</li>");h=h.replace(/^\d+\.\s+(.+)$/gm,"<li>$1</li>");
// Group consecutive list items — allow up to one blank line between items (AI often adds blank lines)
h=h.replace(/((<li>.*?<\/li>\n?\n?)+)/g,"<ul>$1</ul>");
// Wrap lines starting with inline elements (<strong>, <em>) that weren't caught as list items
h=h.replace(/^(<(?:strong|em|code|a)\b[^>]*>.+)$/gm,"<p>$1</p>");
h=h.replace(/^(?!<[a-z\/])((?!<).+)$/gm,"<p>$1</p>");h=h.replace(/<p>\s*<\/p>/g,"");return h;}

// Actions
$("#b-copy").addEventListener("click",function(){
    const txt=activeTab==="assess"?rawAS:activeTab==="quiz"?rawQZ:rawLP;
    navigator.clipboard.writeText(txt).then(()=>{this.textContent="\u2705 Copied!";setTimeout(()=>this.textContent="\u{1F4CB} Copy",2000);});
});
$("#b-pr").addEventListener("click",()=>window.print());
$("#b-dl").addEventListener("click",()=>{
    if(genMode==="topic"){const t=(window._topicCtx?.topic||"Topic").replace(/\s+/g,"_");dl(rawLP,`Lesson_Plan_${t}.md`);}
    else dl(rawLP,`Lesson_Plan_${S.value}_G${G.value}_Q${Q.value}.md`);
});
$("#b-dla").addEventListener("click",()=>{if(genMode==="topic"){const t=(window._topicCtx?.topic||"Topic").replace(/\s+/g,"_");dl(rawAS,`Assessment_${t}.md`);}else dl(rawAS,`Assessment_${S.value}_G${G.value}_Q${Q.value}.md`);});

function quizTitle(){if(genMode==="topic")return(window._topicCtx?.topic||"Quiz");return`${S.options[S.selectedIndex]?.text||"Quiz"}_G${G.value}_Q${Q.value}`;}
function quizFn(){return quizTitle().replace(/\s+/g,"_");}

// .md download (reference copy)
$("#b-dlq-md").addEventListener("click",()=>{dl(rawQZ,`Quiz_${quizFn()}.md`);});

// Moodle GIFT download
function exportQuizFormat(fmt){
    const url=fmt==="gift"?"/api/export-quiz-gift":"/api/export-quiz-qti";
    const btnId=fmt==="gift"?"#b-dlq-gift":"#b-dlq-qti";
    const btn=$(btnId),orig=btn.textContent;
    btn.textContent="Converting...";btn.disabled=true;
    const ak=$("#f-aik")?.value||"",ap=$("#f-aip")?.value||"anthropic";
    fetch(aurl(url),{method:"POST",headers:{"Content-Type":"application/json"},
        body:JSON.stringify({quiz_md:rawQZ,title:quizTitle(),api_key:ak,ai_provider:ap})
    }).then(r=>{if(!r.ok)return r.json().then(e=>{throw new Error(e.error||"Failed");});return r.blob();})
    .then(b=>{const a=document.createElement("a");a.href=URL.createObjectURL(b);a.download=`Quiz_${quizFn()}${fmt==="gift"?"_GIFT.txt":"_QTI.zip"}`;a.click();btn.textContent=orig;btn.disabled=false;})
    .catch(e=>{btn.textContent=orig;btn.disabled=false;alert("Export failed: "+e.message);});
}
$("#b-dlq-gift").addEventListener("click",()=>exportQuizFormat("gift"));
$("#b-dlq-qti").addEventListener("click",()=>exportQuizFormat("qti"));

function dl(txt,fn){const b=new Blob([txt],{type:"text/markdown"});const a=document.createElement("a");a.href=URL.createObjectURL(b);a.download=fn.replace(/\s+/g,"_");a.click();}

// SCORM Download
$("#b-scorm").addEventListener("click",function(){
    let title;
    if(genMode==="topic"){const ctx=window._topicCtx||{};title=`${ctx.topic||"Lesson"} ${ctx.grade||""}`.trim();}
    else{const sn=S.options[S.selectedIndex]?.text||"Lesson";const gn=G.value||"";title=`${sn} Grade ${gn} Q${Q.value||""}`;}
    this.textContent="Building SCORM...";this.disabled=true;
    fetch(aurl("/api/download-scorm"),{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({title:title,lesson_plan:rawLP,assessment:rawAS||""})
    }).then(r=>{if(!r.ok)throw new Error("Failed");return r.blob();}).then(b=>{
        const a=document.createElement("a");
        a.href=URL.createObjectURL(b);
        a.download=`SCORM_${title.replace(/\s+/g,"_")}.zip`;
        a.click();
        this.textContent="\u{1F4E6} Download SCORM";this.disabled=false;
    }).catch(e=>{this.textContent="\u{1F4E6} Download SCORM";this.disabled=false;alert("SCORM build failed: "+e.message);});
});

$("#b-new").addEventListener("click",()=>{rawLP="";rawAS="";rawQZ="";rawPPST="";ratingVal=0;$$(".star").forEach(s=>s.style.color=starEmpty);$("#r-submit").disabled=true;if($("#r-comment"))$("#r-comment").value="";$("#r-msg").style.display="none";$("#quiz-dl-grp").style.display="none";$("#b-dla").style.display="none";$("#t-ppst").style.display="none";$("#b-dlp").style.display="none";$("#regen-panel").style.display="none";localStorage.removeItem(GEN_CONTENT_KEY);go(1);});

// ── Google Doc Export ────────────────────────────────────────
function mdToDocHtml(md){
    let h=md.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
    h=h.replace(/^&gt; (.+)$/gm,"<blockquote>$1</blockquote>");
    h=h.replace(/<\/blockquote>\n<blockquote>/g,"<br>");
    h=h.replace(/^---$/gm,"<hr>");
    h=h.replace(/- \[ \]/g,"\u2610");h=h.replace(/- \[x\]/g,"\u2611");
    h=h.replace(/^#### (.+)$/gm,"<h4>$1</h4>");
    h=h.replace(/^### (.+)$/gm,"<h3>$1</h3>");
    h=h.replace(/^## (.+)$/gm,"<h2>$1</h2>");
    h=h.replace(/^# (.+)$/gm,"<h1>$1</h1>");
    h=h.replace(/\*\*\*(.+?)\*\*\*/g,"<strong><em>$1</em></strong>");
    h=h.replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>");
    h=h.replace(/\*(.+?)\*/g,"<em>$1</em>");
    h=h.replace(/^<strong>(\d+)\.<\/strong>\s*(.+)$/gm,"<li>$2</li>");
    h=h.replace(/^\|(.+)\|$/gm,function(m){const c=m.split("|").filter(c=>c.trim());if(c.every(c=>/^[\s\-:]+$/.test(c)))return"<!--s-->";return"<tr>"+c.map(c=>`<td style="border:1px solid #ccc;padding:6px 10px;">${c.trim()}</td>`).join("")+"</tr>";});
    h=h.replace(/((<tr>.*?<\/tr>\n?)+)/g,"<table style=\"border-collapse:collapse;width:100%;margin:10px 0;\">$1</table>");
    h=h.replace(/<!--s-->\n?/g,"");
    h=h.replace(/^\s*[-*] (.+)$/gm,"<li>$1</li>");
    h=h.replace(/^\d+\.\s+(.+)$/gm,"<li>$1</li>");
    h=h.replace(/((<li>.*?<\/li>\n?\n?)+)/g,"<ul>$1</ul>");
    h=h.replace(/^(<(?:strong|em|code|a)\b[^>]*>.+)$/gm,"<p>$1</p>");
    h=h.replace(/^(?!<[a-z\/])((?!<).+)$/gm,"<p>$1</p>");
    h=h.replace(/<p>\s*<\/p>/g,"");
    const css=`body{font-family:'Plus Jakarta Sans',Arial,sans-serif;font-size:11pt;line-height:1.6;max-width:800px;margin:0 auto;padding:40px}h1,h2,h3{font-family:'Space Grotesk',Arial,sans-serif}h1{font-size:18pt;color:#0d1f2d;border-bottom:2px solid #00bbd6;padding-bottom:6pt}h2{font-size:14pt;color:#0d1f2d;margin-top:24pt}h3{font-size:12pt;color:#1b4a6e}blockquote{border-left:3px solid #00bbd6;padding-left:12px;color:#556;font-style:italic}table,td,th{border-collapse:collapse;border:1px solid #c8e8ee;padding:6px 10px}`;
    return`<!DOCTYPE html><html><head><meta charset="UTF-8"><style>${css}</style></head><body>${h}</body></html>`;
}

$("#b-gdoc").addEventListener("click",function(){
    const content=activeTab==="assess"?rawAS:activeTab==="quiz"?rawQZ:activeTab==="ppst"?rawPPST:rawLP;
    if(!content){alert("No content to export. Generate a lesson plan first.");return;}
    let fn;
    if(genMode==="topic"){fn=`Lesson_Plan_${(window._topicCtx?.topic||"Topic").replace(/\s+/g,"_")}.html`;}
    else{fn=`Lesson_Plan_${S.value}_G${G.value}_Q${Q.value}.html`;}
    const html=mdToDocHtml(content);
    const b=new Blob([html],{type:"text/html"});
    const a=document.createElement("a");a.href=URL.createObjectURL(b);a.download=fn;a.click();
});

// ── RPMS-PPST Alignment ──────────────────────────────────────
$("#b-ppst").addEventListener("click",function(){
    if(!rawLP){alert("Generate a lesson plan first.");return;}
    const orig=this.textContent;
    this.textContent="Analyzing...";this.disabled=true;
    const ak=$("#f-aik")?.value||"",ap=$("#f-aip")?.value||"anthropic";
    let subject="",grade="",comps="";
    if(genMode==="topic"){const ctx=window._topicCtx||{};subject=ctx.subject_name||"";grade=ctx.grade||"";comps=ctx.competencies_text||"";}
    else{subject=S.options[S.selectedIndex]?.text||"";grade=G.value||"";comps=Array.from(selC).map(id=>{const c=cData.find(x=>x.id===id);return c?c.learning_competency:"";}).filter(Boolean).join("; ");}
    fetch(aurl("/api/generate-rpms-ppst"),{method:"POST",headers:{"Content-Type":"application/json"},
        body:JSON.stringify({lesson_plan:rawLP,subject,grade,competencies_summary:comps,api_key:ak,ai_provider:ap})
    }).then(r=>r.json()).then(d=>{
        this.textContent=orig;this.disabled=false;
        if(d.error){alert("RPMS-PPST error: "+d.error);return;}
        rawPPST=d.content||"";
        $("#t-ppst").style.display="inline-flex";
        $("#out-tabs").classList.add("on");
        $("#b-dlp").style.display="inline-flex";
        setTab("ppst");
    }).catch(e=>{this.textContent=orig;this.disabled=false;alert("Error: "+e.message);});
});

$("#b-dlp").addEventListener("click",()=>{dl(rawPPST,"RPMS_PPST_Alignment.md");});

// ── Section Regen ────────────────────────────────────────────
function getSectionFromMarkdown(md,title){
    const lines=md.split('\n');let inside=false,result=[];
    for(let i=0;i<lines.length;i++){
        const l=lines[i];
        if(l.startsWith('## ')&&l.slice(3).trim()===title){inside=true;result.push(l);continue;}
        if(inside&&l.startsWith('## ')&&l.slice(3).trim()!==title)break;
        if(inside)result.push(l);
    }
    return result.join('\n');
}

function replaceSectionInMarkdown(md,title,newSection){
    const lines=md.split('\n');let result=[],inside=false,replaced=false;
    for(let i=0;i<lines.length;i++){
        const l=lines[i];
        if(l.startsWith('## ')&&l.slice(3).trim()===title){
            if(!replaced){const ns=newSection.trimEnd();ns.split('\n').forEach(nl=>result.push(nl));replaced=true;}
            inside=true;continue;
        }
        if(inside&&l.startsWith('## ')&&l.slice(3).trim()!==title){inside=false;}
        if(!inside)result.push(l);
    }
    return result.join('\n');
}

let currentRegenTitle="",selectedPreset="";

$("#out-b").addEventListener("click",function(e){
    const btn=e.target.closest(".sec-regen-btn");
    if(!btn)return;
    currentRegenTitle=btn.dataset.title||"";
    selectedPreset="";
    $("#regen-sec-name").textContent=currentRegenTitle;
    $("#regen-instr").value="";
    $$(".rp-chip").forEach(c=>c.classList.remove("sel"));
    $("#regen-panel").style.display="block";
});

$$(".rp-chip").forEach(c=>{c.addEventListener("click",function(){
    $$(".rp-chip").forEach(x=>x.classList.remove("sel"));
    this.classList.add("sel");
    selectedPreset=this.dataset.v;
    $("#regen-instr").value=selectedPreset;
});});

$("#regen-instr").addEventListener("input",function(){
    if(this.value!==selectedPreset){$$(".rp-chip").forEach(c=>c.classList.remove("sel"));selectedPreset="";}
});

$("#regen-cancel").addEventListener("click",()=>{$("#regen-panel").style.display="none";});

$("#regen-go").addEventListener("click",function(){
    const instr=($("#regen-instr").value||"").trim()||"Improve this section";
    const sectionMd=getSectionFromMarkdown(rawLP,currentRegenTitle);
    if(!sectionMd){alert("Could not find section: "+currentRegenTitle);return;}
    const orig=this.textContent;this.textContent="Regenerating...";this.disabled=true;
    const ak=$("#f-aik")?.value||"",ap=$("#f-aip")?.value||"anthropic";
    let subject="",grade="",comps="";
    if(genMode==="topic"){const ctx=window._topicCtx||{};subject=ctx.subject_name||"";grade=ctx.grade||"";comps=ctx.competencies_text||"";}
    else{subject=S.options[S.selectedIndex]?.text||"";grade=G.value||"";comps=Array.from(selC).map(id=>{const c=cData.find(x=>x.id===id);return c?c.learning_competency:"";}).filter(Boolean).join("; ");}
    fetch(aurl("/api/regenerate-section"),{method:"POST",headers:{"Content-Type":"application/json"},
        body:JSON.stringify({section_title:currentRegenTitle,section_content:sectionMd,lesson_context:{subject,grade,competencies_summary:comps},instruction:instr,api_key:ak,ai_provider:ap})
    }).then(r=>r.json()).then(d=>{
        this.textContent=orig;this.disabled=false;
        if(d.error){alert("Regen error: "+d.error);return;}
        rawLP=replaceSectionInMarkdown(rawLP,currentRegenTitle,d.content||sectionMd);
        $("#regen-panel").style.display="none";
        setTab("lp");
    }).catch(e=>{this.textContent=orig;this.disabled=false;alert("Error: "+e.message);});
});

// ── Download PPTX ────────────────────────────────────────────
$("#b-pptx").addEventListener("click",function(){
    if(!rawLP){alert("Generate a lesson plan first.");return;}
    let title;
    if(genMode==="topic"){const ctx=window._topicCtx||{};title=`${ctx.topic||"Lesson"} ${ctx.grade||""}`.trim();}
    else{const sn=S.options[S.selectedIndex]?.text||"Lesson";const gn=G.value||"";title=`${sn} Grade ${gn} Q${Q.value||""}`;}
    const orig=this.textContent;this.textContent="Building PPTX...";this.disabled=true;
    fetch(aurl("/api/download-pptx"),{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({lesson_md:rawLP,title:title})
    }).then(r=>{if(!r.ok)throw new Error("Failed");return r.blob();}).then(b=>{
        const a=document.createElement("a");
        a.href=URL.createObjectURL(b);
        a.download=`LessonPlan_${title.replace(/\s+/g,"_")}.pptx`;
        a.click();
        this.textContent=orig;this.disabled=false;
    }).catch(e=>{this.textContent=orig;this.disabled=false;alert("PPTX build failed: "+e.message);});
});

// ── Open Activities ───────────────────────────────────────────
$("#b-activities").addEventListener("click",function(){
    if(!rawLP){alert("Generate a lesson plan first.");return;}
    localStorage.setItem("skooled_lesson_md",rawLP);
    localStorage.setItem("skooled_quiz_md",rawQZ||"");
    localStorage.setItem("skooled_use_ai","true");
    localStorage.setItem("skooled_api_key",$("#f-aik")?.value||"");
    localStorage.setItem("skooled_ai_provider",$("#f-aip")?.value||"anthropic");
    window.open(aurl("/activities"),"_blank");
});

// Rating widget
let ratingVal=0;
const stars=$$(".star");
const starEmpty="rgba(13,31,45,0.12)";
stars.forEach(s=>{s.style.color=starEmpty;});
stars.forEach(s=>{
    s.addEventListener("mouseenter",function(){const v=parseInt(this.dataset.v);stars.forEach((x,i)=>x.style.color=i<v?"var(--accent)":starEmpty);});
    s.addEventListener("mouseleave",()=>{stars.forEach((x,i)=>x.style.color=i<ratingVal?"var(--accent)":starEmpty);});
    s.addEventListener("click",function(){ratingVal=parseInt(this.dataset.v);stars.forEach((x,i)=>x.style.color=i<ratingVal?"var(--accent)":starEmpty);$("#r-submit").disabled=false;});
});
$("#r-submit").addEventListener("click",function(){
    if(!ratingVal)return;
    this.disabled=true;
    const sn=genMode==="topic"?(window._topicCtx?.subject_name||""):(S.options[S.selectedIndex]?.text||"");
    const gn=genMode==="topic"?(window._topicCtx?.grade||""):(G.value||"");
    const qn=genMode==="topic"?"":(Q.value||"");
    const lt=genMode==="topic"?(window._topicCtx?.topic||""):"";
    fetch(aurl("/api/rate-lesson"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({rating:ratingVal,comment:$("#r-comment")?.value||"",subject:sn,grade:gn,quarter:qn,lesson_title:lt,gen_mode:genMode})}).then(()=>{$("#r-msg").style.display="block";}).catch(()=>{$("#r-msg").style.display="block";});
});

// ── Resume Banner ────────────────────────────────────────────
(function(){
  const raw = localStorage.getItem(GEN_CONTENT_KEY);
  if(!raw) return;
  try{
    const saved = JSON.parse(raw);
    const age = Date.now() - new Date(saved.savedAt).getTime();
    if(age > 86400000){ localStorage.removeItem(GEN_CONTENT_KEY); return; } // > 24h
    const banner = $("#resume-banner");
    if(!banner) return;
    $("#rb-label").textContent = saved.label || "Previous session";
    $("#rb-time").textContent = timeAgo(saved.savedAt);
    banner.style.display = "flex";
    $("#rb-continue").addEventListener("click",()=>{
      rawLP = saved.rawLP || ""; rawAS = saved.rawAS || ""; rawQZ = saved.rawQZ || "";
      banner.style.display = "none";
      go(4);
      setTab("lp");
    });
    $("#rb-dismiss").addEventListener("click",()=>{
      localStorage.removeItem(GEN_CONTENT_KEY);
      banner.style.display = "none";
    });
  }catch(e){ localStorage.removeItem(GEN_CONTENT_KEY); }
})();

// ── Restore Form Draft on Load ────────────────────────────────
(function(){
  const raw = localStorage.getItem(GEN_DRAFT_KEY);
  if(!raw) return;
  try{ restoreFormInputs(JSON.parse(raw)); }catch(e){ localStorage.removeItem(GEN_DRAFT_KEY); }
})();

// ── Save Lesson Plan ──────────────────────────────────────────
$("#b-save-lp").addEventListener("click", async function(){
  if(!rawLP){ alert("Generate a lesson plan first."); return; }
  const btn = this;
  const msg = $("#lp-save-msg");
  btn.disabled = true;
  btn.textContent = "Saving…";
  msg.style.display = "none";

  // Build a readable title from the current form state
  let subject = "", grade = "", quarter = "";
  if(genMode === "topic"){
    const ctx = window._topicCtx || {};
    const topicLabel = ctx.topic || "";
    const subLabel   = ctx.subject_name || $("#sel-ts")?.value || "";
    subject = topicLabel ? (topicLabel + (subLabel ? " — " + subLabel : "")) : subLabel;
    grade   = ctx.grade || $("#t-grade")?.value || "";
  } else {
    const S2 = $("#sel-s"), G2 = $("#sel-g"), Q2 = $("#sel-q");
    subject = S2?.options[S2.selectedIndex]?.text || "";
    grade   = G2?.value || "";
    quarter = Q2?.value || "";
  }
  const title = [subject, grade ? "Grade "+grade : "", quarter ? "Q"+quarter : ""].filter(Boolean).join(" · ") || "Lesson Plan";

  try {
    const resp = await fetch(aurl("/api/save-lesson-plan"), {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({
        title,
        subject,
        grade,
        quarter,
        gen_mode: genMode,
        lesson_md:     rawLP,
        quiz_md:       rawQZ || "",
        assessment_md: rawAS || "",
      })
    });
    if(resp.status === 401){
      msg.style.cssText = "display:block;color:#e74c3c;font-size:12px;margin-top:8px;";
      msg.innerHTML = 'Session expired. <a href="/login" style="color:#00bbd6;">Log in again</a>.';
      return;
    }
    const data = await resp.json();
    if(data.token){
      msg.style.cssText = "display:block;color:#00bbd6;font-size:12px;margin-top:8px;font-weight:600;";
      msg.textContent = "Saved! You can reload it anytime from \"My Lesson Plans\".";
      btn.textContent = "Saved";
      setTimeout(()=>{ btn.textContent = "Save Lesson Plan"; btn.disabled = false; }, 3000);
    } else {
      throw new Error(data.error || "Save failed");
    }
  } catch(e) {
    msg.style.cssText = "display:block;color:#e74c3c;font-size:12px;margin-top:8px;";
    msg.textContent = "Error: " + e.message;
    btn.textContent = "Save Lesson Plan";
    btn.disabled = false;
  }
});

// ── My Lesson Plans Modal ─────────────────────────────────────
function esc(s){ const d=document.createElement("div");d.textContent=s;return d.innerHTML; }

async function openMyLPs(){
  const overlay = $("#my-lps-overlay");
  const body    = $("#my-lps-body");
  overlay.style.display = "flex";
  body.innerHTML = '<div style="color:#6b8fa3;font-size:13px;text-align:center;padding:24px 0;">Loading…</div>';

  try {
    const resp = await fetch(aurl("/api/my-lesson-plans"));
    if(resp.status === 401){
      body.innerHTML = '<p style="color:#e74c3c;font-size:13px">Session expired. <a href="/login" style="color:#00bbd6;">Log in</a> and return.</p>';
      return;
    }
    const list = await resp.json();
    if(!list.length){
      body.innerHTML = '<p style="color:#6b8fa3;font-size:13px;padding:8px 0;">No saved lesson plans yet. Generate one and click "Save Lesson Plan".</p>';
      return;
    }
    body.innerHTML = list.map(lp => {
      const dt   = lp.updated_at || lp.created_at || "";
      const dtFmt = dt ? new Date(dt).toLocaleDateString("en-PH",{month:"short",day:"numeric",year:"numeric"}) : "—";
      const meta = [lp.subject, lp.grade?"Gr. "+lp.grade:"", lp.quarter?"Q"+lp.quarter:""].filter(Boolean).join(" · ");
      return `<div class="lp-list-item" id="lp-row-${esc(lp.token)}">
        <div>
          <div class="lp-list-title">${esc(lp.title)}</div>
          <div class="lp-list-sub">${meta ? esc(meta)+" &nbsp;·&nbsp; " : ""}${dtFmt}</div>
        </div>
        <div class="lp-list-actions">
          <button class="btn-lp-load" onclick="loadLP('${esc(lp.token)}')">Load</button>
          <button class="btn-lp-del"  onclick="deleteLP('${esc(lp.token)}')">&times;</button>
        </div>
      </div>`;
    }).join("");
  } catch(e) {
    body.innerHTML = '<p style="color:#e74c3c;font-size:13px">Error loading plans.</p>';
  }
}

window.loadLP = async function loadLP(token){
  const body = $("#my-lps-body");
  body.innerHTML = '<div style="color:#6b8fa3;font-size:13px;text-align:center;padding:24px 0;">Loading lesson plan…</div>';
  try {
    const resp = await fetch(aurl("/api/load-lesson-plan/"+token));
    if(!resp.ok){ body.innerHTML='<p style="color:#e74c3c;font-size:13px">Could not load plan.</p>'; return; }
    const data = await resp.json();
    // Restore into JS globals and localStorage
    rawLP = data.lesson_md || "";
    rawQZ = data.quiz_md  || "";
    rawAS = data.assessment_md || "";
    localStorage.setItem("skooled_lesson_md", rawLP);
    localStorage.setItem("skooled_quiz_md",   rawQZ);
    localStorage.setItem(GEN_CONTENT_KEY, JSON.stringify({
      rawLP, rawAS, rawQZ,
      label: data.title || "Lesson Plan",
      savedAt: new Date().toISOString()
    }));
    // Close modal and show step 4
    $("#my-lps-overlay").style.display = "none";
    // Update tabs visibility
    const hasAS = !!rawAS;
    const hasQZ = !!rawQZ;
    $("#t-as").style.display = hasAS ? "" : "none";
    $("#t-qz").style.display = hasQZ ? "" : "none";
    $("#t-ppst").style.display = "none";
    // Set subtitle
    const parts = [data.subject, data.grade?"Grade "+data.grade:"", data.quarter?"Q"+data.quarter:""].filter(Boolean);
    const outSub = $("#out-s");
    if(outSub) outSub.textContent = parts.join(" · ");
    // Render and navigate
    setTab("lp");
    go(4);
    $("#out-t").textContent = (data.title || "Lesson Plan");
    // Enable activities button
    localStorage.setItem("skooled_use_ai", "true");
  } catch(e) {
    body.innerHTML = '<p style="color:#e74c3c;font-size:13px">Error: '+e.message+'</p>';
  }
}

window.deleteLP = async function deleteLP(token){
  if(!confirm("Delete this lesson plan? This cannot be undone.")) return;
  try {
    const resp = await fetch(aurl("/api/delete-lesson-plan/"+token), {method:"DELETE"});
    if(resp.ok){
      const row = $("#lp-row-"+token);
      if(row) row.remove();
      if(!$("#my-lps-body").querySelector(".lp-list-item")){
        $("#my-lps-body").innerHTML = '<p style="color:#6b8fa3;font-size:13px;padding:8px 0;">No saved lesson plans yet.</p>';
      }
    }
  } catch(e) { alert("Delete failed: "+e.message); }
}

document.getElementById("nav-my-lps").addEventListener("click", function(e){
  e.preventDefault();
  openMyLPs();
});
document.getElementById("my-lps-close").addEventListener("click", function(){
  $("#my-lps-overlay").style.display = "none";
});
document.getElementById("my-lps-overlay").addEventListener("click", function(e){
  if(e.target === this) this.style.display = "none";
});

});
</script>

<!-- ═══════════════════════════════════════════════
     MY LESSON PLANS MODAL
═══════════════════════════════════════════════ -->
<div id="my-lps-overlay" style="display:none;position:fixed;inset:0;background:rgba(5,14,22,0.7);z-index:9999;align-items:center;justify-content:center;">
  <div style="background:#0d1f2d;border:1.5px solid rgba(0,187,214,0.3);border-radius:18px;width:90%;max-width:580px;max-height:80vh;display:flex;flex-direction:column;overflow:hidden;">
    <div style="display:flex;align-items:center;justify-content:space-between;padding:18px 22px;border-bottom:1px solid rgba(0,187,214,0.15);">
      <h3 style="margin:0;font-size:16px;font-weight:700;color:#e8f4f8;font-family:'Space Grotesk',sans-serif;">My Lesson Plans</h3>
      <button id="my-lps-close" style="background:none;border:none;color:#6b8fa3;font-size:22px;cursor:pointer;line-height:1;">&times;</button>
    </div>
    <div id="my-lps-body" style="overflow-y:auto;padding:16px 22px;flex:1;font-family:'Plus Jakarta Sans',sans-serif;">
      <div style="color:#6b8fa3;font-size:13px;text-align:center;padding:24px 0;">Loading…</div>
    </div>
  </div>
</div>
</body>
</html>
