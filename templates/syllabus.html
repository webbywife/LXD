<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="auth-token" content="{{ auth_token }}">
<link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
<title>SKOOLED-AI · Syllabus Builder</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0a1929;--nav:#0d1f2d;--card:rgba(255,255,255,0.05);
  --cyan:#00bbd6;--cyan-d:#009bb3;--orange:#faa32b;--green:#00b894;
  --red:#e74c3c;--white:#ffffff;--grey:rgba(255,255,255,0.6);
  --border:rgba(0,187,214,0.2);--rad:14px;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--white);min-height:100vh;display:flex;flex-direction:column;}
h1,h2,h3,h4{font-family:'Space Grotesk',sans-serif;}

/* ── Nav ── */
.nav{background:var(--nav);padding:0 24px;height:52px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:200;flex-shrink:0;}
.nav-brand{font-family:'Space Grotesk',sans-serif;font-size:17px;font-weight:800;color:var(--white);letter-spacing:-0.03em;text-decoration:none;}
.nav-brand span{color:var(--cyan);}
.nav-links{display:flex;gap:6px;align-items:center;}
.nav-links a{color:var(--grey);text-decoration:none;font-size:12px;font-weight:500;padding:5px 12px;border-radius:8px;transition:.2s;}
.nav-links a:hover{color:var(--white);background:rgba(255,255,255,0.06);}
.nav-links a.active{color:var(--cyan);background:rgba(0,187,214,0.1);}
.nav-links .sep{color:rgba(255,255,255,0.15);font-size:16px;margin:0 2px;}
.nav-user{font-size:12px;color:var(--grey);padding:5px 12px;border-left:1px solid var(--border);margin-left:6px;}

/* ── Page ── */
.page{max-width:900px;margin:0 auto;padding:28px 20px 60px;width:100%;}
.page-hdr{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:28px;gap:16px;flex-wrap:wrap;}
.page-title{font-size:24px;font-weight:800;letter-spacing:-0.04em;color:var(--white);}
.page-sub{font-size:13px;color:var(--grey);margin-top:3px;font-weight:400;}
.btn-preview{padding:11px 28px;border-radius:11px;border:none;background:var(--cyan);color:#000;font-size:13px;font-weight:800;font-family:'Space Grotesk',sans-serif;cursor:pointer;transition:.2s;letter-spacing:-0.02em;white-space:nowrap;}
.btn-preview:hover{background:#00d4f0;box-shadow:0 6px 24px rgba(0,187,214,.35);}

/* ── Form Cards ── */
.card{background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:var(--rad);padding:22px 24px;margin-bottom:16px;}
.card-hdr{font-family:'Space Grotesk',sans-serif;font-size:13px;font-weight:700;color:var(--cyan);text-transform:uppercase;letter-spacing:.06em;margin-bottom:16px;display:flex;align-items:center;gap:8px;}
.card-hdr::before{content:'';width:3px;height:13px;background:var(--cyan);border-radius:2px;flex-shrink:0;}

/* ── Grid Layouts ── */
.fr2{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.fr3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;}
@media(max-width:600px){.fr2,.fr3{grid-template-columns:1fr;}}

/* ── Fields ── */
.fg{margin-bottom:12px;}
.fg:last-child{margin-bottom:0;}
.fg label{display:block;font-size:11px;font-weight:600;color:rgba(255,255,255,0.65);margin-bottom:4px;letter-spacing:.01em;}
.fg input,.fg select,.fg textarea{
  width:100%;padding:9px 12px;font-size:13px;font-family:inherit;
  border:1.5px solid rgba(0,187,214,0.22);border-radius:9px;
  background:rgba(255,255,255,0.06);color:var(--white);transition:.2s;
}
.fg input::placeholder,.fg textarea::placeholder{color:rgba(255,255,255,0.28);}
.fg input:focus,.fg select:focus,.fg textarea:focus{outline:none;border-color:var(--cyan);background:rgba(0,187,214,0.07);}
.fg select option{background:#0d1f2d;color:#fff;}
.fg textarea{resize:vertical;min-height:80px;line-height:1.65;}
.fg .hint{font-size:10px;color:var(--grey);margin-top:3px;line-height:1.4;}

/* ── Type Tabs ── */
.type-tabs{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px;}
.type-tab{padding:10px 14px;border-radius:10px;border:1.5px solid var(--border);background:transparent;color:var(--grey);font-size:13px;font-weight:600;cursor:pointer;transition:.2s;text-align:center;font-family:'Space Grotesk',sans-serif;}
.type-tab:hover{border-color:var(--cyan);color:var(--white);}
.type-tab.on{border-color:var(--cyan);background:rgba(0,187,214,0.1);color:var(--white);}

/* ── Grading ── */
.grading-row{display:grid;grid-template-columns:1fr 70px 28px;gap:8px;align-items:center;margin-bottom:8px;}
.grading-row input{padding:8px 10px;font-size:12px;}
.gr-del{background:none;border:none;cursor:pointer;color:rgba(255,255,255,0.35);font-size:16px;padding:4px;transition:.2s;border-radius:4px;}
.gr-del:hover{color:var(--red);background:rgba(231,76,60,0.1);}
.grading-total{font-size:12px;font-weight:700;color:var(--grey);text-align:right;margin-top:4px;}
.grading-total.ok{color:var(--green);}
.grading-total.err{color:var(--red);}
.btn-add-row{background:none;border:1.5px dashed var(--border);color:var(--grey);font-size:12px;padding:7px 14px;border-radius:8px;cursor:pointer;transition:.2s;width:100%;margin-top:6px;font-family:inherit;}
.btn-add-row:hover{border-color:var(--cyan);color:var(--white);}

/* ── Week Accordion ── */
.week-row{border:1px solid var(--border);border-radius:10px;margin-bottom:8px;overflow:hidden;transition:.2s;}
.week-row:hover{border-color:rgba(0,187,214,0.35);}
.week-hdr{display:flex;align-items:center;gap:12px;padding:11px 16px;cursor:pointer;background:rgba(255,255,255,0.03);user-select:none;}
.week-hdr:hover{background:rgba(0,187,214,0.06);}
.week-num{font-family:'Space Grotesk',sans-serif;font-size:13px;font-weight:800;color:var(--cyan);white-space:nowrap;min-width:56px;}
.week-preview{flex:1;font-size:12px;color:var(--grey);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.week-chevron{font-size:11px;color:var(--grey);transition:transform .2s;flex-shrink:0;}
.week-row.open .week-chevron{transform:rotate(180deg);}
.week-body{display:none;padding:14px 16px;border-top:1px solid var(--border);background:rgba(0,0,0,0.15);}
.week-row.open .week-body{display:block;}
.week-body .fg label{font-size:10.5px;}
.week-body .fg input,.week-body .fg textarea{font-size:12px;}
.week-body .fg textarea{min-height:56px;}

.weeks-toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;flex-wrap:wrap;gap:8px;}
.weeks-toolbar span{font-size:12px;color:var(--grey);}
.btn-expand-all{background:none;border:1px solid var(--border);color:var(--grey);font-size:11px;padding:4px 12px;border-radius:6px;cursor:pointer;font-family:inherit;transition:.2s;}
.btn-expand-all:hover{border-color:var(--cyan);color:var(--white);}

/* ── Toast ── */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(80px);background:#e74c3c;color:#fff;padding:10px 20px;border-radius:10px;font-size:13px;font-weight:600;z-index:9999;transition:transform .3s;box-shadow:0 6px 24px rgba(0,0,0,.25);}
.toast.show{transform:translateX(-50%) translateY(0);}

/* ════════════════════════════════════════════
   PREVIEW OVERLAY
════════════════════════════════════════════ */
.preview-overlay{
  position:fixed;top:0;left:0;right:0;bottom:0;
  background:#dce6ec;z-index:500;
  display:flex;flex-direction:column;
  transform:translateY(100%);transition:transform .35s cubic-bezier(.4,0,.2,1);
}
.preview-overlay.show{transform:translateY(0);}
.preview-toolbar{
  background:#fff;border-bottom:1px solid #d0dee6;
  padding:10px 24px;display:flex;align-items:center;
  gap:10px;flex-shrink:0;flex-wrap:wrap;
}
.preview-toolbar h3{font-size:13px;font-weight:700;color:#0d1f2d;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.btn-back{padding:7px 16px;border-radius:8px;border:1.5px solid #c8d8e0;background:#fff;font-size:12px;font-weight:600;cursor:pointer;color:#0d1f2d;font-family:'Space Grotesk',sans-serif;transition:.2s;}
.btn-back:hover{border-color:#00bbd6;color:#00bbd6;}
.btn-print-doc{padding:7px 16px;border-radius:8px;border:1.5px solid #c8d8e0;background:#fff;font-size:12px;font-weight:600;cursor:pointer;color:#0d1f2d;font-family:'Space Grotesk',sans-serif;transition:.2s;}
.btn-print-doc:hover{border-color:#00bbd6;color:#00bbd6;}
.btn-share{padding:7px 16px;border-radius:8px;border:none;background:#00bbd6;font-size:12px;font-weight:700;cursor:pointer;color:#fff;font-family:'Space Grotesk',sans-serif;transition:.2s;}
.btn-share:hover{background:#009bb3;}
.preview-body{flex:1;overflow-y:auto;padding:30px;display:flex;justify-content:center;}

/* ════════════════════════════════════════════
   SHARE MODAL
════════════════════════════════════════════ */
.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:600;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .2s;}
.modal-overlay.show{opacity:1;pointer-events:all;}
.modal{background:#fff;border-radius:16px;padding:28px;max-width:480px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,.3);}
.modal-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;}
.modal-hdr h3{font-size:16px;font-weight:800;color:#0d1f2d;font-family:'Space Grotesk',sans-serif;}
.modal-close{background:none;border:none;font-size:20px;cursor:pointer;color:#6b8fa3;padding:2px 6px;border-radius:4px;transition:.2s;}
.modal-close:hover{color:#0d1f2d;background:#f0f5f7;}
.modal-section{margin-bottom:16px;}
.modal-section label{display:block;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.05em;color:#6b8fa3;margin-bottom:6px;}
.modal-url-row{display:flex;gap:8px;align-items:center;}
.modal-url-row input{flex:1;padding:9px 12px;font-size:12px;border:1.5px solid #c8d8e0;border-radius:8px;color:#0d1f2d;font-family:'Space Grotesk',sans-serif;}
.modal-btn{padding:8px 16px;border-radius:8px;font-size:12px;font-weight:700;border:none;cursor:pointer;font-family:'Space Grotesk',sans-serif;transition:.2s;white-space:nowrap;}
.modal-btn.cyan{background:#00bbd6;color:#fff;}
.modal-btn.cyan:hover{background:#009bb3;}
.modal-btn.dark{background:#0d1f2d;color:#fff;}
.modal-btn.dark:hover{background:#081520;}
.modal-divider{text-align:center;color:#aab8c2;font-size:12px;margin:14px 0;position:relative;}
.modal-divider::before,.modal-divider::after{content:'';position:absolute;top:50%;width:38%;height:1px;background:#e0eaef;}
.modal-divider::before{left:0;}
.modal-divider::after{right:0;}
.modal-email-row{display:flex;gap:8px;}
.modal-email-row input{flex:1;padding:9px 12px;font-size:12px;border:1.5px solid #c8d8e0;border-radius:8px;color:#0d1f2d;}
.modal-note{font-size:11px;color:#6b8fa3;margin-top:10px;line-height:1.5;}
.saving-indicator{text-align:center;color:#6b8fa3;font-size:13px;padding:12px 0;}

/* ════════════════════════════════════════════
   SYLLABUS DOCUMENT — Plain Academic Style
════════════════════════════════════════════ */
.syldoc{background:#fff;width:100%;max-width:850px;box-shadow:0 4px 40px rgba(0,0,0,.12);font-family:Calibri,'Trebuchet MS','Segoe UI',Arial,sans-serif;font-size:11pt;color:#000;line-height:1.5;padding:30px 36px;}
.syl-doc-hdr{display:grid;grid-template-columns:80px 1fr 80px;gap:12px;align-items:center;border-bottom:2px solid #000;padding-bottom:12px;margin-bottom:14px;}
.syl-logo-box{width:72px;height:72px;border:1px solid #ccc;display:flex;align-items:center;justify-content:center;font-size:9px;color:#999;text-align:center;line-height:1.3;}
.syl-school-center{text-align:center;}
.syl-school-name{font-size:13pt;font-weight:bold;text-transform:uppercase;line-height:1.3;}
.syl-school-college{font-size:11pt;font-weight:bold;margin-top:3px;}
.syl-school-program{font-size:10pt;margin-top:3px;}
.syl-course-block{text-align:center;border:1px solid #000;padding:8px 12px;margin:10px 0 14px;}
.syl-course-code-title{font-size:13pt;font-weight:bold;}
.syl-course-subtitle{font-size:10pt;margin-top:3px;}
.syl-sec-hdr{font-size:11pt;font-weight:bold;text-decoration:underline;margin:18px 0 8px;color:#000;display:block;}
.syl-sec-body{font-size:11pt;line-height:1.65;color:#000;}
.syl-sec-body p{margin-bottom:6px;}
.syl-ci-table{width:100%;border-collapse:collapse;font-size:11pt;margin-bottom:8px;}
.syl-ci-table td{padding:3px 5px;vertical-align:top;}
.syl-ci-label{font-weight:bold;text-transform:uppercase;width:200px;white-space:nowrap;}
.syl-ci-colon{width:14px;text-align:center;}
.syl-ci-value{border-bottom:1px solid #000;min-width:200px;}
.syl-table{width:100%;border-collapse:collapse;font-size:10.5pt;margin:6px 0 12px;}
.syl-table th{border:1px solid #000;padding:6px 8px;text-align:left;font-weight:bold;background:#fff;color:#000;}
.syl-table td{border:1px solid #000;padding:5px 8px;vertical-align:top;color:#000;background:#fff;}
.syl-plan-wrap{overflow-x:auto;margin:6px 0 12px;}
.syl-plan-table{width:100%;border-collapse:collapse;font-size:9pt;min-width:800px;}
.syl-plan-table th{border:1px solid #000;padding:5px 6px;text-align:center;font-weight:bold;background:#fff;color:#000;white-space:nowrap;}
.syl-plan-table td{border:1px solid #000;padding:5px 6px;vertical-align:top;color:#000;background:#fff;line-height:1.4;}
.wk-num{text-align:center;font-weight:bold;}
.syl-grade-table{border-collapse:collapse;font-size:10.5pt;margin:6px 0 12px;min-width:320px;}
.syl-grade-table th{border:1px solid #000;padding:5px 10px;font-weight:bold;background:#fff;color:#000;text-align:left;}
.syl-grade-table td{border:1px solid #000;padding:5px 10px;color:#000;background:#fff;}
.wt{font-weight:bold;text-align:right;}
.syl-grade-total td{font-weight:bold;border-top:2px solid #000;}
.syl-refs{padding-left:20px;margin:4px 0 10px;}
.syl-refs li{font-size:10.5pt;line-height:1.6;margin-bottom:2px;}
.syl-refs-sub{font-weight:bold;font-size:10.5pt;margin:10px 0 4px;}
.syl-sig{display:grid;grid-template-columns:1fr 1fr;gap:40px;margin-top:30px;padding-top:14px;border-top:1px solid #000;}
.syl-sig-box{text-align:center;}
.syl-sig-line{border-bottom:1px solid #000;margin:0 10px 5px;height:40px;}
.syl-sig-name{font-size:10.5pt;font-weight:bold;color:#000;}
.syl-sig-role{font-size:9.5pt;color:#000;}

/* ── Draft Bar & Edit Banner ── */
.draft-bar{font-size:11px;color:var(--grey);background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;padding:7px 14px;margin-bottom:12px;display:flex;align-items:center;justify-content:space-between;gap:10px;}
.draft-bar a{color:var(--cyan);text-decoration:underline;cursor:pointer;background:none;border:none;font-size:11px;font-family:inherit;padding:0;}
.edit-banner{font-size:12px;color:#0d1f2d;background:rgba(0,187,214,0.15);border:1px solid rgba(0,187,214,0.4);border-radius:8px;padding:9px 14px;margin-bottom:12px;display:flex;align-items:center;gap:8px;}
.edit-banner strong{color:var(--cyan);}

/* ── My Syllabi Button ── */
.btn-my-syllabi{padding:9px 18px;border-radius:11px;border:1.5px solid var(--border);background:transparent;color:var(--grey);font-size:12px;font-weight:700;font-family:'Space Grotesk',sans-serif;cursor:pointer;transition:.2s;white-space:nowrap;}
.btn-my-syllabi:hover{border-color:var(--cyan);color:var(--white);}

/* ── Update Syllabus Controls (preview toolbar) ── */
.rev-comment-wrap{display:flex;align-items:center;gap:8px;flex:1;}
.rev-comment-input{flex:1;padding:6px 10px;font-size:12px;font-family:inherit;border:1.5px solid #c8d8e0;border-radius:8px;color:#0d1f2d;min-width:160px;}
.btn-update{padding:7px 16px;border-radius:8px;border:none;background:#00b894;font-size:12px;font-weight:700;cursor:pointer;color:#fff;font-family:'Space Grotesk',sans-serif;transition:.2s;white-space:nowrap;}
.btn-update:hover{background:#00a07e;}
.btn-save-copy{padding:7px 14px;border-radius:8px;border:1.5px solid #c8d8e0;background:transparent;font-size:12px;font-weight:600;cursor:pointer;color:#6b8fa3;font-family:'Space Grotesk',sans-serif;transition:.2s;white-space:nowrap;}
.btn-save-copy:hover{border-color:#00bbd6;color:#00bbd6;}

/* ── My Syllabi List ── */
.syl-list-item{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 0;border-bottom:1px solid #e8f2f5;}
.syl-list-item:last-child{border-bottom:none;}
.syl-list-meta{flex:1;min-width:0;}
.syl-list-title{font-size:13px;font-weight:700;color:#0d1f2d;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.syl-list-sub{font-size:11px;color:#6b8fa3;margin-top:2px;}
.btn-load-edit{padding:6px 14px;border-radius:8px;border:none;background:#00bbd6;color:#fff;font-size:11px;font-weight:700;cursor:pointer;font-family:'Space Grotesk',sans-serif;transition:.2s;white-space:nowrap;}
.btn-load-edit:hover{background:#009bb3;}

/* ── Print handled by printSyllabus() clean-window function ── */

/* ── Assessment Rubrics (builder card) ── */
.rubric-attached-list{margin-bottom:12px;}
.rubric-item{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:9px 12px;background:rgba(255,255,255,0.04);border:1px solid var(--border);border-radius:8px;margin-bottom:8px;}
.rubric-item-info{flex:1;min-width:0;}
.rubric-item-name{font-size:13px;font-weight:700;color:var(--white);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.rubric-item-meta{font-size:11px;color:var(--grey);margin-top:2px;}
.rubric-item-btns{display:flex;gap:6px;flex-shrink:0;}
.btn-rub-edit{padding:4px 10px;border-radius:6px;border:1.5px solid var(--border);background:transparent;color:var(--grey);font-size:11px;font-weight:700;cursor:pointer;font-family:inherit;transition:.2s;}
.btn-rub-edit:hover{border-color:var(--cyan);color:var(--white);}
.btn-rub-remove{padding:4px 10px;border-radius:6px;border:1.5px solid rgba(231,76,60,0.3);background:transparent;color:rgba(231,76,60,0.7);font-size:11px;font-weight:700;cursor:pointer;font-family:inherit;transition:.2s;}
.btn-rub-remove:hover{border-color:#e74c3c;color:#e74c3c;background:rgba(231,76,60,0.1);}
.rubric-actions{display:flex;gap:8px;flex-wrap:wrap;}
.btn-rub-action{padding:7px 14px;border-radius:8px;border:1.5px dashed var(--border);background:transparent;color:var(--grey);font-size:12px;font-weight:700;cursor:pointer;font-family:inherit;transition:.2s;}
.btn-rub-action:hover{border-color:var(--cyan);color:var(--white);}

/* ── Rubric overlays (library + builder) ── */
.rub-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:700;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .2s;}
.rub-overlay.show{opacity:1;pointer-events:all;}
.rub-modal{background:#101c28;border:1px solid var(--border);border-radius:16px;padding:28px;max-width:820px;width:94%;max-height:88vh;display:flex;flex-direction:column;box-shadow:0 24px 80px rgba(0,0,0,.6);}
.rub-modal-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-shrink:0;}
.rub-modal-hdr h3{font-size:15px;font-weight:800;color:var(--white);font-family:'Space Grotesk',sans-serif;}
.rub-modal-close{background:none;border:none;font-size:22px;cursor:pointer;color:var(--grey);padding:2px 7px;border-radius:4px;transition:.2s;}
.rub-modal-close:hover{color:var(--white);background:rgba(255,255,255,0.08);}
.rub-modal-body{flex:1;overflow-y:auto;padding-right:4px;}
.rub-modal-footer{display:flex;align-items:center;gap:10px;margin-top:20px;flex-shrink:0;border-top:1px solid var(--border);padding-top:16px;flex-wrap:wrap;}
.btn-rub-primary{padding:9px 20px;border-radius:10px;border:none;background:var(--cyan);color:#0d1f2d;font-size:13px;font-weight:800;cursor:pointer;font-family:inherit;transition:.2s;}
.btn-rub-primary:hover{background:#00a0bb;}
.btn-rub-cancel{padding:9px 18px;border-radius:10px;border:1.5px solid var(--border);background:transparent;color:var(--grey);font-size:13px;font-weight:700;cursor:pointer;font-family:inherit;transition:.2s;}
.btn-rub-cancel:hover{border-color:var(--white);color:var(--white);}

/* Rubric builder field group */
.rub-fg{margin-bottom:14px;}
.rub-fg label{display:block;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.05em;color:var(--grey);margin-bottom:5px;}
.rub-fg input,.rub-fg textarea{width:100%;padding:9px 12px;background:rgba(255,255,255,0.06);border:1.5px solid var(--border);border-radius:8px;color:var(--white);font-family:inherit;font-size:13px;}
.rub-fg textarea{resize:vertical;min-height:52px;}
.rub-sec-hdr{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.05em;color:var(--cyan);margin:18px 0 10px;}

/* Level chips */
.rub-levels-row{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px;}
.rub-level-chip{display:flex;align-items:center;gap:4px;background:rgba(0,187,214,0.1);border:1.5px solid rgba(0,187,214,0.3);border-radius:10px;padding:5px 8px;}
.rub-level-chip input{background:transparent;border:none;color:var(--white);font-family:inherit;font-size:12px;font-weight:700;width:80px;outline:none;}
.rub-level-chip input.score-inp{width:32px;color:var(--cyan);text-align:center;}
.rub-level-chip .sep{color:var(--grey);font-size:11px;}
.rub-chip-del{background:none;border:none;color:var(--grey);cursor:pointer;font-size:13px;padding:0 2px;line-height:1;transition:.2s;}
.rub-chip-del:hover{color:#e74c3c;}

/* Criterion accordion */
.rub-criterion{border:1px solid var(--border);border-radius:10px;margin-bottom:10px;overflow:hidden;}
.rub-crit-hdr{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;cursor:pointer;background:rgba(255,255,255,0.04);transition:.2s;}
.rub-crit-hdr:hover{background:rgba(255,255,255,0.07);}
.rub-crit-hdr-info{display:flex;align-items:center;gap:10px;flex:1;min-width:0;}
.rub-crit-title{font-size:13px;font-weight:700;color:var(--white);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.rub-crit-wt{font-size:11px;color:var(--cyan);flex-shrink:0;}
.rub-crit-chevron{color:var(--grey);font-size:11px;transition:.3s;flex-shrink:0;}
.rub-criterion.open .rub-crit-chevron{transform:rotate(180deg);}
.rub-crit-body{display:none;padding:14px;}
.rub-criterion.open .rub-crit-body{display:block;}
.rub-crit-fields{display:grid;grid-template-columns:1fr 90px;gap:10px;margin-bottom:12px;align-items:end;}
.rub-crit-fields input{padding:8px 10px;background:rgba(255,255,255,0.06);border:1.5px solid var(--border);border-radius:8px;color:var(--white);font-family:inherit;font-size:13px;width:100%;}
.rub-desc-label{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.05em;color:var(--grey);margin-bottom:6px;}
.rub-desc-grid{display:grid;gap:8px;}
.rub-desc-cell label{display:block;font-size:10px;font-weight:700;color:var(--cyan);margin-bottom:3px;}
.rub-desc-cell textarea{width:100%;padding:7px 9px;background:rgba(255,255,255,0.05);border:1.5px solid var(--border);border-radius:7px;color:var(--white);font-family:inherit;font-size:11px;resize:vertical;min-height:56px;}
.btn-rub-del-crit{padding:4px 9px;border-radius:6px;border:1.5px solid rgba(231,76,60,0.3);background:transparent;color:rgba(231,76,60,0.7);font-size:11px;font-weight:700;cursor:pointer;font-family:inherit;transition:.2s;flex-shrink:0;}
.btn-rub-del-crit:hover{border-color:#e74c3c;color:#e74c3c;background:rgba(231,76,60,0.1);}

/* Library list */
.rub-lib-item{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 0;border-bottom:1px solid var(--border);}
.rub-lib-item:last-child{border-bottom:none;}
.rub-lib-info{flex:1;min-width:0;}
.rub-lib-name{font-size:13px;font-weight:700;color:var(--white);}
.rub-lib-meta{font-size:11px;color:var(--grey);margin-top:2px;}
.btn-use-rubric{padding:6px 14px;border-radius:8px;border:none;background:var(--cyan);color:#0d1f2d;font-size:11px;font-weight:800;cursor:pointer;font-family:inherit;transition:.2s;flex-shrink:0;}
.btn-use-rubric:hover{background:#00a0bb;}

/* Rubric save-to-lib checkbox */
.rub-save-lib-row{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--grey);}
.rub-save-lib-row input[type=checkbox]{width:15px;height:15px;accent-color:var(--cyan);}

/* ── Rubric preview (inside syldoc) ── */
.syl-rubric-wrap{margin:8px 0 18px;}
.syl-rubric-name{font-size:11pt;font-weight:bold;color:#0d1f2d;margin-bottom:3px;}
.syl-rubric-desc{font-size:10pt;color:#444;margin-bottom:6px;}
.syl-rubric-table{width:100%;border-collapse:collapse;font-size:9.5pt;margin-bottom:14px;}
.syl-rubric-table th{border:1px solid #888;padding:5px 8px;background:#f0f0f0;color:#000;font-weight:bold;text-align:center;}
.syl-rubric-table td{border:1px solid #aaa;padding:5px 8px;vertical-align:top;color:#111;}
.syl-rubric-table .crit-name{font-weight:bold;}
.syl-rubric-table .crit-wt{text-align:center;white-space:nowrap;}
</style>
</head>
<body>

<!-- ── Navigation ── -->
<div class="nav">
  <a href="{{ url_for('landing') }}" class="nav-brand">SKOOLED<span>-AI</span></a>
  <div class="nav-links">
    <a href="{{ turl('generator') }}">Lesson Generator</a>
    <span class="sep">|</span>
    <a href="{{ turl('activities') }}">Activities</a>
    <span class="sep">|</span>
    <a href="{{ turl('syllabus') }}" class="active">Syllabus</a>
    <span class="sep">|</span>
    <a href="{{ turl('syllabi_dashboard') }}">My Syllabi</a>
    <span class="sep">|</span>
    {% if session.get('user_role') == 'admin' %}
    <a href="{{ turl('auth.admin_panel') }}">Admin</a>
    <span class="sep">|</span>
    {% endif %}
    <a href="{{ url_for('auth.logout') }}">Logout</a>
    <span class="nav-user">{{ session.get('user_name','') }}</span>
  </div>
</div>

<!-- ════════════════════════════════════════════
     MAIN FORM
════════════════════════════════════════════ -->
<div class="page" id="main-form">

  <div class="page-hdr">
    <div>
      <div class="page-title">Syllabus Builder</div>
      <div class="page-sub">Fill in all sections below, then preview and share your syllabus.</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
      <button class="btn-my-syllabi" id="btn-my-syllabi">My Syllabi</button>
      <button class="btn-preview" id="btn-preview">Preview Syllabus &rarr;</button>
    </div>
  </div>

  <div class="draft-bar" id="draft-bar" style="display:none;">
    <span id="draft-bar-text">Draft saved</span>
    <button style="background:none;border:none;color:var(--cyan);text-decoration:underline;cursor:pointer;font-size:11px;font-family:inherit;padding:0;" id="btn-clear-draft">Clear draft</button>
  </div>
  <div class="edit-banner" id="edit-banner" style="display:none;">
    Editing saved syllabus &nbsp;·&nbsp; <strong id="edit-rev-label">Rev 1</strong> &nbsp;·&nbsp; <span id="edit-updated-label"></span>
  </div>

  <!-- Institution Type -->
  <div class="card">
    <div class="card-hdr">Institution Type</div>
    <div class="type-tabs">
      <div class="type-tab on" data-type="college">College / University</div>
      <div class="type-tab" data-type="shs">Senior High School</div>
    </div>
    <input type="hidden" id="institution-type" value="college">
    <div class="fr2">
      <div class="fg">
        <label>School / University Name</label>
        <input type="text" id="school-name" placeholder="e.g. De La Salle-College of Saint Benilde">
      </div>
      <div class="fg">
        <label>College / Department</label>
        <input type="text" id="college-dept" placeholder="e.g. School of New Media Arts">
      </div>
    </div>
    <div class="fg">
      <label>Program</label>
      <input type="text" id="program" placeholder="e.g. Bachelor of Arts in Multimedia Arts">
    </div>
  </div>

  <!-- Course Details -->
  <div class="card">
    <div class="card-hdr">Course Details</div>
    <div class="fr3">
      <div class="fg">
        <label>Course Code</label>
        <input type="text" id="course-code" placeholder="e.g. MELPRIN">
      </div>
      <div class="fg">
        <label>Credit Units</label>
        <input type="text" id="credits" placeholder="e.g. 3 units">
      </div>
      <div class="fg">
        <label>Prerequisites</label>
        <input type="text" id="prerequisites" placeholder="None">
      </div>
    </div>
    <div class="fg">
      <label>Course Title *</label>
      <input type="text" id="course-title" placeholder="e.g. Elements and Principles of Design">
    </div>
    <div class="fr3">
      <div class="fg">
        <label>Course Type</label>
        <select id="course-type">
          <option value="Core">Core</option>
          <option value="Major">Major</option>
          <option value="Elective">Elective</option>
          <option value="Service">Service / GE</option>
          <option value="Applied Subject">Applied Subject (SHS)</option>
          <option value="Core Subject">Core Subject (SHS)</option>
          <option value="Specialized">Specialized (SHS)</option>
        </select>
      </div>
      <div class="fg">
        <label>Number of Weeks</label>
        <select id="num-weeks">
          <option value="12">12 weeks</option>
          <option value="13">13 weeks</option>
          <option value="14" selected>14 weeks</option>
          <option value="15">15 weeks</option>
          <option value="16">16 weeks</option>
          <option value="18">18 weeks</option>
        </select>
      </div>
      <div class="fg">
        <label>Semester / Term</label>
        <input type="text" id="semester" placeholder="e.g. 2nd Semester, AY 2025-2026">
      </div>
    </div>
  </div>

  <!-- Course Description -->
  <div class="card">
    <div class="card-hdr">Course Description</div>
    <div class="fg">
      <textarea id="course-description" rows="4" placeholder="Describe the course — what it covers, the approach used, and who it is for (2–4 sentences)."></textarea>
    </div>
  </div>

  <!-- Program Outcomes -->
  <div class="card">
    <div class="card-hdr">Program Outcomes</div>
    <div class="fg">
      <textarea id="program-outcomes" rows="5" placeholder="Enter one Program Outcome per line, e.g.:&#10;Apply knowledge of design principles in professional contexts&#10;Communicate design concepts effectively across different media&#10;Demonstrate ethical and socially responsible creative practice"></textarea>
      <div class="hint">One outcome per line &nbsp;•&nbsp; Will be numbered PO1, PO2, PO3…</div>
    </div>
  </div>

  <!-- Course Outcomes -->
  <div class="card">
    <div class="card-hdr">Course Outcomes</div>
    <div class="fg">
      <textarea id="course-outcomes" rows="5" placeholder="Enter one Course Outcome per line, e.g.:&#10;Identify the fundamental elements and principles of design&#10;Analyze design compositions using formal critique frameworks&#10;Create original design outputs applying learned principles&#10;Evaluate peer work constructively using design rubric criteria"></textarea>
      <div class="hint">One outcome per line (4–8 recommended) &nbsp;•&nbsp; Will be numbered CO1, CO2…</div>
    </div>
  </div>

  <!-- Course Plan -->
  <div class="card">
    <div class="card-hdr">Weekly Course Plan</div>
    <div class="weeks-toolbar">
      <span id="week-count-label">14 weeks</span>
      <button class="btn-expand-all" id="btn-expand-all">Expand All</button>
    </div>
    <div id="week-rows"></div>
  </div>

  <!-- Grading -->
  <div class="card">
    <div class="card-hdr">Grading Breakdown</div>
    <div id="grading-rows">
      <div class="grading-row">
        <input type="text" class="g-comp" placeholder="Component name" value="Activities">
        <input type="number" class="g-wt" min="0" max="100" value="30" placeholder="%">
        <button class="gr-del" onclick="removeGradingRow(this)" title="Remove">✕</button>
      </div>
      <div class="grading-row">
        <input type="text" class="g-comp" placeholder="Component name" value="Projects">
        <input type="number" class="g-wt" min="0" max="100" value="30" placeholder="%">
        <button class="gr-del" onclick="removeGradingRow(this)" title="Remove">✕</button>
      </div>
      <div class="grading-row">
        <input type="text" class="g-comp" placeholder="Component name" value="Final Project">
        <input type="number" class="g-wt" min="0" max="100" value="40" placeholder="%">
        <button class="gr-del" onclick="removeGradingRow(this)" title="Remove">✕</button>
      </div>
    </div>
    <div class="grading-total ok" id="grading-total">Total: 100% ✓</div>
    <button class="btn-add-row" onclick="addGradingRow()">+ Add Component</button>
  </div>

  <!-- Assessment Rubrics -->
  <div class="card">
    <div class="card-hdr">Assessment Rubrics</div>
    <div id="rubric-attached-list" class="rubric-attached-list">
      <p style="font-size:12px;color:var(--grey);margin-bottom:10px;">No rubrics attached yet.</p>
    </div>
    <div class="rubric-actions">
      <button class="btn-rub-action" id="btn-rub-library">&#128218; Pick from Library</button>
      <button class="btn-rub-action" id="btn-rub-create">+ Create New Rubric</button>
    </div>
  </div>

  <!-- References -->
  <div class="card">
    <div class="card-hdr">References</div>
    <div class="fg">
      <label>Books &amp; Journals (one per line, APA format)</label>
      <textarea id="ref-books" rows="4" placeholder="Author, A. A. (Year). Title of book. Publisher.&#10;Author, B. B. (Year). Title of journal article. Journal Name, vol(no), pp–pp."></textarea>
    </div>
    <div class="fg">
      <label>Online Resources (one per line)</label>
      <textarea id="ref-websites" rows="3" placeholder="https://example.com — Description of resource"></textarea>
    </div>
  </div>

  <div style="text-align:center;padding:10px 0;">
    <button class="btn-preview" id="btn-preview2">Preview Syllabus &rarr;</button>
  </div>

</div><!-- /page -->


<!-- ════════════════════════════════════════════
     PREVIEW OVERLAY
════════════════════════════════════════════ -->
<div class="preview-overlay" id="preview-overlay">
  <div class="preview-toolbar">
    <button class="btn-back" id="btn-back">&larr; Back to Edit</button>
    <h3 id="preview-title">Syllabus Preview</h3>
    <button class="btn-print-doc" onclick="printSyllabus()">Print / Save PDF</button>
    <div class="rev-comment-wrap" id="rev-comment-wrap" style="display:none;">
      <input type="text" class="rev-comment-input" id="rev-comment" placeholder="Revision comment (optional)…">
      <button class="btn-update" id="btn-update">Update Syllabus</button>
      <button class="btn-save-copy" id="btn-save-copy">Save as New Copy</button>
    </div>
    <button class="btn-share" id="btn-share">Save &amp; Share</button>
  </div>
  <div class="preview-body" id="preview-body"></div>
</div>


<!-- ════════════════════════════════════════════
     SHARE MODAL
════════════════════════════════════════════ -->
<div class="modal-overlay" id="modal-overlay">
  <div class="modal">
    <div class="modal-hdr">
      <h3>Share Syllabus</h3>
      <button class="modal-close" id="modal-close">&times;</button>
    </div>
    <div id="modal-content">
      <div class="saving-indicator">Saving syllabus…</div>
    </div>
  </div>
</div>

<!-- ════════════════════════════════════════════
     MY SYLLABI MODAL
════════════════════════════════════════════ -->
<div class="modal-overlay" id="my-syllabi-overlay">
  <div class="modal" style="max-width:560px;width:90%;">
    <div class="modal-hdr">
      <h3>My Syllabi</h3>
      <button class="modal-close" id="my-syllabi-close">&times;</button>
    </div>
    <div id="my-syllabi-content">
      <div class="saving-indicator">Loading…</div>
    </div>
  </div>
</div>

<!-- ════════════════════════════════════════════
     RUBRIC LIBRARY OVERLAY
════════════════════════════════════════════ -->
<div class="rub-overlay" id="rub-library-overlay">
  <div class="rub-modal" style="max-width:600px;">
    <div class="rub-modal-hdr">
      <h3>Rubric Library</h3>
      <button class="rub-modal-close" id="rub-lib-close">&times;</button>
    </div>
    <div class="rub-modal-body" id="rub-lib-content">
      <div class="saving-indicator">Loading…</div>
    </div>
  </div>
</div>

<!-- ════════════════════════════════════════════
     RUBRIC BUILDER OVERLAY
════════════════════════════════════════════ -->
<div class="rub-overlay" id="rub-builder-overlay">
  <div class="rub-modal">
    <div class="rub-modal-hdr">
      <h3 id="rub-builder-title">Create New Rubric</h3>
      <button class="rub-modal-close" id="rub-builder-close">&times;</button>
    </div>
    <div class="rub-modal-body">
      <div class="rub-fg">
        <label>Rubric Name *</label>
        <input type="text" id="rub-name" placeholder="e.g. Group Project Rubric">
      </div>
      <div class="rub-fg">
        <label>Description (optional)</label>
        <textarea id="rub-desc" rows="2" placeholder="Brief description of what this rubric evaluates"></textarea>
      </div>

      <div class="rub-sec-hdr">Performance Levels</div>
      <div id="rub-levels-row" class="rub-levels-row"></div>
      <button class="btn-rub-action" id="btn-add-level" style="margin-bottom:6px;">+ Add Level</button>

      <div class="rub-sec-hdr">Criteria</div>
      <div id="rub-criteria-list"></div>
      <button class="btn-rub-action" id="btn-add-criterion">+ Add Criterion</button>
    </div>
    <div class="rub-modal-footer">
      <label class="rub-save-lib-row">
        <input type="checkbox" id="rub-save-lib" checked>
        Save to Library (share with all users)
      </label>
      <div style="flex:1;"></div>
      <button class="btn-rub-cancel" id="btn-rub-builder-cancel">Cancel</button>
      <button class="btn-rub-primary" id="btn-rub-builder-save">Add Rubric to Syllabus</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>


<!-- ════════════════════════════════════════════
     JAVASCRIPT
════════════════════════════════════════════ -->
<script>
const AUTH_TOKEN = document.querySelector('meta[name="auth-token"]').content;
function apiUrl(p){ return AUTH_TOKEN ? p+'?_t='+encodeURIComponent(AUTH_TOKEN) : p; }

// ── Week Rows ─────────────────────────────────────────────────────────────
function generateWeekRows(n){
  const container = document.getElementById('week-rows');
  container.innerHTML = '';
  document.getElementById('week-count-label').textContent = n + ' week' + (n>1?'s':'');
  for(let w=1; w<=n; w++){
    const open = w<=2 ? ' open' : '';
    container.innerHTML += `
    <div class="week-row${open}" data-week="${w}">
      <div class="week-hdr" onclick="toggleWeek(this)">
        <span class="week-num">Week ${w}</span>
        <span class="week-preview" id="wp-${w}">click to expand</span>
        <span class="week-chevron">▼</span>
      </div>
      <div class="week-body">
        <div class="fg"><label>Topics</label>
          <input type="text" id="w${w}-topics" placeholder="Main topic and subtopics for this week" oninput="updatePreview(${w})">
        </div>
        <div class="fg"><label>Intended Learning Outcomes (ILOs)</label>
          <textarea id="w${w}-ilos" rows="2" placeholder="By the end of this week, students will be able to: (1)… (2)…"></textarea>
        </div>
        <div class="fr2">
          <div class="fg"><label>Teaching &amp; Learning Activities (TLAs)</label>
            <input type="text" id="w${w}-tlas" placeholder="e.g. Lecture-Discussion, Workshop">
          </div>
          <div class="fg"><label>Assessment Tasks</label>
            <input type="text" id="w${w}-ats" placeholder="e.g. Quiz 1, Activity Sheet">
          </div>
        </div>
        <div class="fr2">
          <div class="fg"><label>Evaluation Strategies</label>
            <input type="text" id="w${w}-eval" placeholder="e.g. Rubric, Checklist, Peer Evaluation">
          </div>
          <div class="fg"><label>Resources</label>
            <input type="text" id="w${w}-res" placeholder="e.g. Textbook Ch. 1, URL">
          </div>
        </div>
        <div class="fg"><label>Due Date (optional)</label>
          <input type="text" id="w${w}-due" placeholder="">
        </div>
      </div>
    </div>`;
  }
}

function toggleWeek(hdr){
  hdr.closest('.week-row').classList.toggle('open');
}

function updatePreview(w){
  const topics = document.getElementById('w'+w+'-topics').value.trim();
  const prev = document.getElementById('wp-'+w);
  if(prev) prev.textContent = topics || 'click to expand';
}

let allExpanded = false;
document.getElementById('btn-expand-all').addEventListener('click', function(){
  allExpanded = !allExpanded;
  document.querySelectorAll('.week-row').forEach(r=>{
    r.classList.toggle('open', allExpanded);
  });
  this.textContent = allExpanded ? 'Collapse All' : 'Expand All';
});

document.getElementById('num-weeks').addEventListener('change', function(){
  generateWeekRows(parseInt(this.value));
});

// ── Grading ───────────────────────────────────────────────────────────────
function updateGradingTotal(){
  let t=0;
  document.querySelectorAll('.g-wt').forEach(el=>t+=parseInt(el.value||0));
  const el=document.getElementById('grading-total');
  el.textContent='Total: '+t+'%'+(t===100?' ✓':' ✗ (must equal 100%)');
  el.className='grading-total '+(t===100?'ok':'err');
}
document.addEventListener('input',e=>{
  if(e.target.classList.contains('g-wt')) updateGradingTotal();
});
function removeGradingRow(btn){
  btn.closest('.grading-row').remove();
  updateGradingTotal();
}
function addGradingRow(){
  const d=document.createElement('div');
  d.className='grading-row';
  d.innerHTML=`<input type="text" class="g-comp" placeholder="Component name"><input type="number" class="g-wt" min="0" max="100" value="0" placeholder="%"><button class="gr-del" onclick="removeGradingRow(this)" title="Remove">✕</button>`;
  document.getElementById('grading-rows').appendChild(d);
  updateGradingTotal();
}

// ── Type Tabs ─────────────────────────────────────────────────────────────
document.querySelectorAll('.type-tab').forEach(tab=>{
  tab.addEventListener('click',function(){
    document.querySelectorAll('.type-tab').forEach(t=>t.classList.remove('on'));
    this.classList.add('on');
    document.getElementById('institution-type').value=this.dataset.type;
  });
});

// ── Build Syllabus Object from Form ──────────────────────────────────────
function parseOutcomes(text, prefix){
  return text.split('\n').map(l=>l.trim()).filter(Boolean).map((line,i)=>{
    const clean=line.replace(/^(?:\d+[\.\):\s]+|[-•*]\s+|(?:PO|CO|LO)\s*\d+[\.\):\s]+)/,'').trim();
    return {code: prefix+(i+1), description: clean||line, po_mapping:[]};
  });
}

function collectWeekData(){
  const n=parseInt(document.getElementById('num-weeks').value);
  const plan=[];
  for(let w=1;w<=n;w++){
    plan.push({
      week: w,
      topics: (document.getElementById('w'+w+'-topics')||{value:''}).value.trim(),
      ilos: (document.getElementById('w'+w+'-ilos')||{value:''}).value.trim(),
      tlas: (document.getElementById('w'+w+'-tlas')||{value:''}).value.trim(),
      assessment_tasks: (document.getElementById('w'+w+'-ats')||{value:''}).value.trim(),
      evaluation_strategies: (document.getElementById('w'+w+'-eval')||{value:''}).value.trim(),
      resources: (document.getElementById('w'+w+'-res')||{value:''}).value.trim(),
      due_date: (document.getElementById('w'+w+'-due')||{value:''}).value.trim(),
    });
  }
  return plan;
}

function buildSyllabusFromForm(){
  const poText=document.getElementById('program-outcomes').value.trim();
  const coText=document.getElementById('course-outcomes').value.trim();
  const grading=[];
  document.querySelectorAll('#grading-rows .grading-row').forEach(row=>{
    const comp=row.querySelector('.g-comp').value.trim();
    const wt=parseInt(row.querySelector('.g-wt').value||0);
    if(comp&&wt>0) grading.push({component:comp,weight:wt});
  });
  const booksText=document.getElementById('ref-books').value.trim();
  const sitesText=document.getElementById('ref-websites').value.trim();
  return {
    institution_type: document.getElementById('institution-type').value,
    school_name: document.getElementById('school-name').value.trim(),
    college_dept: document.getElementById('college-dept').value.trim(),
    program: document.getElementById('program').value.trim(),
    course_code: document.getElementById('course-code').value.trim(),
    course_title: document.getElementById('course-title').value.trim(),
    credits: document.getElementById('credits').value.trim(),
    prerequisites: document.getElementById('prerequisites').value.trim()||'None',
    course_type: document.getElementById('course-type').value,
    semester: document.getElementById('semester').value.trim(),
    faculty:'', schedule:'',
    course_description: document.getElementById('course-description').value.trim(),
    program_outcomes: parseOutcomes(poText,'PO'),
    course_outcomes: parseOutcomes(coText,'CO'),
    course_plan: collectWeekData(),
    grading_system: grading,
    references:{
      books: booksText.split('\n').map(l=>l.trim()).filter(Boolean),
      websites: sitesText.split('\n').map(l=>l.trim()).filter(Boolean),
    },
    rubrics: JSON.parse(JSON.stringify(window._rubrics||[])),
  };
}

// ── Preview ───────────────────────────────────────────────────────────────
function showPreview(){
  const courseTitle=document.getElementById('course-title').value.trim();
  if(!courseTitle){ showToast('Please enter a Course Title first'); return; }
  const s=buildSyllabusFromForm();
  document.getElementById('preview-body').innerHTML=`<div class="syldoc">${renderSyllabusDoc(s)}</div>`;
  document.getElementById('preview-title').textContent=
    (s.course_code?s.course_code+' — ':'')+s.course_title;

  // Toggle edit vs save controls
  if(editToken){
    document.getElementById('rev-comment-wrap').style.display = 'flex';
    document.getElementById('btn-share').style.display = 'none';
  } else {
    document.getElementById('rev-comment-wrap').style.display = 'none';
    document.getElementById('btn-share').style.display = '';
  }

  document.getElementById('preview-overlay').classList.add('show');
}

document.getElementById('btn-preview').addEventListener('click', showPreview);
document.getElementById('btn-preview2').addEventListener('click', showPreview);
document.getElementById('btn-back').addEventListener('click', ()=>{
  document.getElementById('preview-overlay').classList.remove('show');
});

// ── Save & Share ──────────────────────────────────────────────────────────
document.getElementById('btn-share').addEventListener('click', async function(){
  const overlay=document.getElementById('modal-overlay');
  const content=document.getElementById('modal-content');
  content.innerHTML='<div class="saving-indicator">Saving syllabus…</div>';
  overlay.classList.add('show');

  const s=buildSyllabusFromForm();
  try{
    const resp=await fetch(apiUrl('/api/save-syllabus'),{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({syllabus:s})
    });
    const data=await resp.json();
    if(data.error){ content.innerHTML=`<p style="color:#e74c3c">${esc(data.error)}</p>`; return; }
    const url=data.url;
    const title=s.course_code?(s.course_code+' — '+s.course_title):s.course_title;
    content.innerHTML=`
      <div class="modal-section">
        <label>Shareable Link</label>
        <div class="modal-url-row">
          <input type="text" id="share-url-input" value="${esc(url)}" readonly>
          <button class="modal-btn cyan" id="copy-btn">Copy</button>
        </div>
      </div>
      <div class="modal-divider">or share via email</div>
      <div class="modal-section">
        <label>Recipient Email Address</label>
        <div class="modal-email-row">
          <input type="email" id="share-email" placeholder="colleague@school.edu.ph">
          <button class="modal-btn dark" id="send-email-btn">Open Email</button>
        </div>
      </div>
      <div class="modal-note">The recipient can view and print the syllabus without needing to log in to SKOOLED-AI.</div>`;
    document.getElementById('copy-btn').onclick=()=>{
      navigator.clipboard.writeText(url).then(()=>showToast('Link copied!'));
      document.getElementById('copy-btn').textContent='Copied!';
      setTimeout(()=>document.getElementById('copy-btn').textContent='Copy',2000);
    };
    clearDraft();
    document.getElementById('send-email-btn').onclick=()=>{
      const email=document.getElementById('share-email').value.trim();
      if(!email){showToast('Enter an email address');return;}
      const subject=encodeURIComponent('Syllabus: '+title);
      const body=encodeURIComponent('Hello,\n\nPlease find the course syllabus for '+title+' at the link below:\n\n'+url+'\n\nYou can view and download it without needing an account.\n\nBest regards');
      window.open('mailto:'+email+'?subject='+subject+'&body='+body);
    };
  }catch(e){
    content.innerHTML=`<p style="color:#e74c3c">Error: ${esc(e.message)}</p>`;
  }
});

document.getElementById('modal-close').addEventListener('click',()=>{
  document.getElementById('modal-overlay').classList.remove('show');
});
document.getElementById('modal-overlay').addEventListener('click',function(e){
  if(e.target===this) this.classList.remove('show');
});

// ── Rendering ─────────────────────────────────────────────────────────────
function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function nl2p(s){return s?s.split(/\n+/).filter(l=>l.trim()).map(l=>`<p>${esc(l.trim())}</p>`).join(''):'<p style="color:#999;font-style:italic">Not provided</p>';}

function renderSyllabusDoc(s){
  return renderDocHeader(s)+renderCourseBlock(s)+renderCourseInfo(s)+renderDescription(s)
    +renderPOs(s)+renderCOs(s)+renderCoursePlan(s)
    +renderGrading(s)+renderRubrics(s)+renderPolicies()+renderReferences(s)+renderSignatures();
}

function renderDocHeader(s){
  return `<div class="syl-doc-hdr">
    <div class="syl-logo-box">Logo</div>
    <div class="syl-school-center">
      <div class="syl-school-name">${esc(s.school_name||'[School / University Name]')}</div>
      <div class="syl-school-college">${esc(s.college_dept||'[College / Department]')}</div>
      <div class="syl-school-program">${esc(s.program||'[Program]')}</div>
    </div>
    <div class="syl-logo-box">Seal</div>
  </div>`;}

function renderCourseBlock(s){
  const code=s.course_code?(s.course_code+' \u2014 '):'';
  return `<div class="syl-course-block">
    <div class="syl-course-code-title">${esc(code+(s.course_title||'[Course Title]'))}</div>
    ${s.semester?`<div class="syl-course-subtitle">${esc(s.semester)}</div>`:''}
  </div>`;}

function renderCourseInfo(s){
  const rows=[
    ['COURSE CODE',s.course_code||''],['COURSE TITLE',s.course_title||''],
    ['CREDIT UNITS',s.credits||''],['COURSE TYPE',s.course_type||''],
    ['PREREQUISITES',s.prerequisites||'None'],['ACADEMIC PERIOD',s.semester||''],
    ['NAME OF FACULTY',''],['SCHEDULE',''],['CONSULTATION TIME',''],
  ];
  return `<div class="syl-sec-hdr">Course Information</div>
    <table class="syl-ci-table"><tbody>${rows.map(([l,v])=>`<tr><td class="syl-ci-label">${l}</td><td class="syl-ci-colon">:</td><td class="syl-ci-value">${esc(v)}</td></tr>`).join('')}</tbody></table>`;}

function renderDescription(s){
  return `<div class="syl-sec-hdr">Course Description</div><div class="syl-sec-body">${nl2p(s.course_description)}</div>`;}

function renderPOs(s){
  if(!s.program_outcomes||!s.program_outcomes.length) return '';
  return `<div class="syl-sec-hdr">Program Outcomes</div>
    <ul class="syl-refs">${s.program_outcomes.map(po=>`<li><strong>${esc(po.code)}:</strong> ${esc(po.description)}</li>`).join('')}</ul>`;}

function renderCOs(s){
  if(!s.course_outcomes||!s.course_outcomes.length) return '';
  return `<div class="syl-sec-hdr">Course Outcomes</div>
    <table class="syl-table"><thead><tr>
      <th style="width:60px;text-align:center">Code</th>
      <th>Course Outcome Statement</th>
      <th style="width:110px;text-align:center">PO Mapping</th>
    </tr></thead>
    <tbody>${s.course_outcomes.map(co=>`<tr>
      <td style="text-align:center;font-weight:bold">${esc(co.code)}</td>
      <td>${esc(co.description)}</td>
      <td style="text-align:center">\u2014</td>
    </tr>`).join('')}</tbody></table>`;}

function renderCoursePlan(s){
  if(!s.course_plan||!s.course_plan.length) return '';
  const rows=s.course_plan.map(w=>`<tr>
    <td class="wk-num">${esc(String(w.week||''))}</td>
    <td>${esc(w.topics||'')}</td>
    <td>${esc(w.ilos||'')}</td>
    <td>${esc(w.tlas||'')}</td>
    <td>${esc(w.assessment_tasks||'')}</td>
    <td>${esc(w.evaluation_strategies||'')}</td>
    <td>${esc(w.resources||'')}</td>
    <td>${esc(w.due_date||'')}</td>
  </tr>`).join('');
  return `<div class="syl-sec-hdr">Course Plan</div>
    <div class="syl-plan-wrap"><table class="syl-plan-table">
      <thead><tr>
        <th style="width:36px">Week</th><th>Topics</th><th>ILOs</th>
        <th>TLAs</th><th>Assessment Tasks</th><th>Evaluation</th>
        <th>Resources</th><th>Due Date</th>
      </tr></thead>
      <tbody>${rows}</tbody>
    </table></div>`;}

function renderGrading(s){
  if(!s.grading_system||!s.grading_system.length) return '';
  let total=0;
  const rows=s.grading_system.map(g=>{total+=parseInt(g.weight||0);return`<tr><td>${esc(g.component)}</td><td class="wt">${esc(String(g.weight))}%</td></tr>`;}).join('');
  return `<div class="syl-sec-hdr">Grading System</div>
    <table class="syl-grade-table"><thead><tr><th>Component</th><th>Weight</th></tr></thead>
    <tbody>${rows}<tr class="syl-grade-total"><td>TOTAL</td><td class="wt">${total}%</td></tr></tbody></table>
    <p style="font-size:10.5pt;margin-top:6px">Passing grade: <strong>70%</strong>. Grading is cumulative and zero-based.</p>`;}

function renderPolicies(){
  return `<div class="syl-sec-hdr">Academic Policies</div>
    <div class="syl-sec-body">
      <p><strong>Attendance:</strong> Students must maintain at least 80% attendance. Exceeding 20% absences may result in a grade of INC or DRP per institutional policy.</p>
      <p><strong>Academic Integrity:</strong> All outputs must be the student's original work. Plagiarism will result in a failing grade for the output and may lead to further disciplinary action.</p>
      <p><strong>Netiquette:</strong> Respectful behavior and appropriate language are required in all class interactions, online or face-to-face.</p>
      <p><strong>Intellectual Property:</strong> Course materials are protected by copyright and may not be reproduced or distributed without prior written consent.</p>
    </div>`;}

function renderReferences(s){
  if(!s.references) return '';
  const books=(s.references.books||[]);
  const sites=(s.references.websites||[]);
  if(!books.length&&!sites.length) return '';
  let html='<div class="syl-sec-hdr">References</div>';
  if(books.length){html+='<div class="syl-refs-sub">Books &amp; Journals</div><ul class="syl-refs">'+books.map(b=>`<li>${esc(b)}</li>`).join('')+'</ul>';}
  if(sites.length){html+='<div class="syl-refs-sub" style="margin-top:10px">Online Resources</div><ul class="syl-refs">'+sites.map(b=>`<li>${esc(b)}</li>`).join('')+'</ul>';}
  return html;}

function renderSignatures(){
  return `<div class="syl-sig">
    <div class="syl-sig-box"><div class="syl-sig-line"></div><div class="syl-sig-name">[Faculty Name]</div><div class="syl-sig-role">Prepared by \u2014 Course Instructor</div></div>
    <div class="syl-sig-box"><div class="syl-sig-line"></div><div class="syl-sig-name">[Department Head / Dean]</div><div class="syl-sig-role">Approved by \u2014 Academic Head</div></div>
  </div>`;}

// ── Print ─────────────────────────────────────────────────────────────────
function printSyllabus(){
  const bodyEl = document.getElementById('preview-body');
  if(!bodyEl || !bodyEl.innerHTML.trim()){
    showToast('Open the preview first, then print.');
    return;
  }
  const w = window.open('','_blank','width=900,height=700');
  w.document.write(`<!DOCTYPE html>
<html lang="en"><head>
<meta charset="UTF-8">
<title>Syllabus</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;700&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0;}
body{background:#fff;font-family:Calibri,'Trebuchet MS','Segoe UI',Arial,sans-serif;font-size:11pt;color:#000;}
@page{size:A4 portrait;margin:20mm;}
.syldoc{width:100%;font-family:Calibri,'Trebuchet MS','Segoe UI',Arial,sans-serif;font-size:11pt;color:#000;line-height:1.5;}
.syl-doc-hdr{display:grid;grid-template-columns:80px 1fr 80px;gap:12px;align-items:center;border-bottom:2px solid #000;padding-bottom:12px;margin-bottom:14px;}
.syl-logo-box{width:72px;height:72px;border:1px solid #ccc;display:flex;align-items:center;justify-content:center;font-size:9px;color:#999;text-align:center;line-height:1.3;}
.syl-school-center{text-align:center;}
.syl-school-name{font-size:13pt;font-weight:bold;text-transform:uppercase;line-height:1.3;}
.syl-school-college{font-size:11pt;font-weight:bold;margin-top:3px;}
.syl-school-program{font-size:10pt;margin-top:3px;}
.syl-course-block{text-align:center;border:1px solid #000;padding:8px 12px;margin:10px 0 14px;}
.syl-course-code-title{font-size:13pt;font-weight:bold;}
.syl-course-subtitle{font-size:10pt;margin-top:3px;}
.syl-sec-hdr{font-size:11pt;font-weight:bold;text-decoration:underline;margin:18px 0 8px;color:#000;display:block;page-break-after:avoid;}
.syl-sec-body{font-size:11pt;line-height:1.65;color:#000;}
.syl-sec-body p{margin-bottom:6px;}
.syl-ci-table{width:100%;border-collapse:collapse;font-size:11pt;margin-bottom:8px;}
.syl-ci-table td{padding:3px 5px;vertical-align:top;}
.syl-ci-label{font-weight:bold;text-transform:uppercase;width:200px;white-space:nowrap;}
.syl-ci-colon{width:14px;text-align:center;}
.syl-ci-value{border-bottom:1px solid #000;min-width:200px;}
.syl-table{width:100%;border-collapse:collapse;font-size:10.5pt;margin:6px 0 12px;}
.syl-table th{border:1px solid #000;padding:6px 8px;text-align:left;font-weight:bold;background:#fff;color:#000;}
.syl-table td{border:1px solid #000;padding:5px 8px;vertical-align:top;color:#000;background:#fff;}
.syl-plan-wrap{margin:6px 0 12px;}
.syl-plan-table{width:100%;border-collapse:collapse;font-size:8pt;}
.syl-plan-table th{border:1px solid #000;padding:4px 5px;text-align:center;font-weight:bold;background:#fff;color:#000;white-space:nowrap;}
.syl-plan-table td{border:1px solid #000;padding:4px 5px;vertical-align:top;color:#000;background:#fff;line-height:1.35;}
.wk-num{text-align:center;font-weight:bold;}
.syl-grade-table{border-collapse:collapse;font-size:10.5pt;margin:6px 0 12px;min-width:320px;}
.syl-grade-table th{border:1px solid #000;padding:5px 10px;font-weight:bold;background:#fff;color:#000;text-align:left;}
.syl-grade-table td{border:1px solid #000;padding:5px 10px;color:#000;background:#fff;}
.wt{font-weight:bold;text-align:right;}
.syl-grade-total td{font-weight:bold;border-top:2px solid #000;}
.syl-refs{padding-left:20px;margin:4px 0 10px;}
.syl-refs li{font-size:10.5pt;line-height:1.6;margin-bottom:2px;}
.syl-refs-sub{font-weight:bold;font-size:10.5pt;margin:10px 0 4px;}
.syl-sig{display:grid;grid-template-columns:1fr 1fr;gap:40px;margin-top:30px;padding-top:14px;border-top:1px solid #000;page-break-inside:avoid;}
.syl-sig-box{text-align:center;}
.syl-sig-line{border-bottom:1px solid #000;margin:0 10px 5px;height:40px;}
.syl-sig-name{font-size:10.5pt;font-weight:bold;color:#000;}
.syl-sig-role{font-size:9.5pt;color:#000;}
.syl-rubric-wrap{margin:8px 0 18px;}
.syl-rubric-name{font-size:11pt;font-weight:bold;color:#000;margin-bottom:3px;}
.syl-rubric-desc{font-size:10pt;color:#333;margin-bottom:6px;}
.syl-rubric-table{width:100%;border-collapse:collapse;font-size:9pt;margin-bottom:14px;}
.syl-rubric-table th{border:1px solid #000;padding:5px 7px;background:#fff;color:#000;font-weight:bold;text-align:center;}
.syl-rubric-table td{border:1px solid #000;padding:5px 7px;vertical-align:top;color:#000;}
.syl-rubric-table .crit-name{font-weight:bold;}
.syl-rubric-table .crit-wt{text-align:center;white-space:nowrap;}
</style>
</head><body>
${bodyEl.innerHTML}
</body></html>`);
  w.document.close();
  w.focus();
  setTimeout(()=>{ w.print(); }, 600);
}

// ── Toast ─────────────────────────────────────────────────────────────────
function showToast(msg,dur=3500){
  const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),dur);}

// ══════════════════════════════════════════════════════════════
// DRAFT AUTO-SAVE
// ══════════════════════════════════════════════════════════════
const DRAFT_KEY = 'skooled_syl_draft';
let _draftTimer = null;

function collectRawFormState(){
  const n = parseInt(document.getElementById('num-weeks').value);
  const weeks = [];
  for(let w=1;w<=n;w++){
    weeks.push({
      topics: (document.getElementById('w'+w+'-topics')||{value:''}).value,
      ilos:   (document.getElementById('w'+w+'-ilos')||{value:''}).value,
      tlas:   (document.getElementById('w'+w+'-tlas')||{value:''}).value,
      ats:    (document.getElementById('w'+w+'-ats')||{value:''}).value,
      eval:   (document.getElementById('w'+w+'-eval')||{value:''}).value,
      res:    (document.getElementById('w'+w+'-res')||{value:''}).value,
      due:    (document.getElementById('w'+w+'-due')||{value:''}).value,
    });
  }
  const grading = [];
  document.querySelectorAll('#grading-rows .grading-row').forEach(row=>{
    grading.push({
      comp: row.querySelector('.g-comp').value,
      wt:   row.querySelector('.g-wt').value,
    });
  });
  return {
    institutionType: document.getElementById('institution-type').value,
    schoolName:      document.getElementById('school-name').value,
    collegeDept:     document.getElementById('college-dept').value,
    program:         document.getElementById('program').value,
    courseCode:      document.getElementById('course-code').value,
    courseTitle:     document.getElementById('course-title').value,
    credits:         document.getElementById('credits').value,
    prerequisites:   document.getElementById('prerequisites').value,
    courseType:      document.getElementById('course-type').value,
    numWeeks:        String(n),
    semester:        document.getElementById('semester').value,
    courseDesc:      document.getElementById('course-description').value,
    programOutcomes: document.getElementById('program-outcomes').value,
    courseOutcomes:  document.getElementById('course-outcomes').value,
    weeks:           weeks,
    grading:         grading,
    refBooks:        document.getElementById('ref-books').value,
    refWebsites:     document.getElementById('ref-websites').value,
    rubrics:         JSON.parse(JSON.stringify(window._rubrics||[])),
    savedAt:         new Date().toISOString(),
  };
}

function restoreFormState(state){
  const setVal = (id, v) => { const el=document.getElementById(id); if(el) el.value=v||''; };
  setVal('school-name', state.schoolName);
  setVal('college-dept', state.collegeDept);
  setVal('program', state.program);
  setVal('course-code', state.courseCode);
  setVal('course-title', state.courseTitle);
  setVal('credits', state.credits);
  setVal('prerequisites', state.prerequisites);
  setVal('semester', state.semester);
  setVal('course-description', state.courseDesc);
  setVal('program-outcomes', state.programOutcomes);
  setVal('course-outcomes', state.courseOutcomes);
  setVal('ref-books', state.refBooks);
  setVal('ref-websites', state.refWebsites);

  // Institution type tab
  const itype = state.institutionType || 'college';
  document.getElementById('institution-type').value = itype;
  document.querySelectorAll('.type-tab').forEach(t=>{
    t.classList.toggle('on', t.dataset.type === itype);
  });

  // Course type
  setVal('course-type', state.courseType);

  // Num weeks + week rows
  const n = parseInt(state.numWeeks) || 14;
  const weeksSelect = document.getElementById('num-weeks');
  weeksSelect.value = String(n);
  generateWeekRows(n);
  (state.weeks||[]).forEach((wk,i)=>{
    const w=i+1;
    const sv = (id,v)=>{ const el=document.getElementById(id); if(el) el.value=v||''; };
    sv('w'+w+'-topics', wk.topics); sv('w'+w+'-ilos', wk.ilos);
    sv('w'+w+'-tlas', wk.tlas);   sv('w'+w+'-ats', wk.ats);
    sv('w'+w+'-eval', wk.eval);   sv('w'+w+'-res', wk.res);
    sv('w'+w+'-due', wk.due);
    updatePreview(w);
  });

  // Grading rows
  if(state.grading && state.grading.length){
    const container = document.getElementById('grading-rows');
    container.innerHTML = '';
    state.grading.forEach(g=>{
      const d=document.createElement('div');
      d.className='grading-row';
      d.innerHTML=`<input type="text" class="g-comp" placeholder="Component name" value="${esc(g.comp||'')}"><input type="number" class="g-wt" min="0" max="100" value="${esc(g.wt||'0')}" placeholder="%"><button class="gr-del" onclick="removeGradingRow(this)" title="Remove">✕</button>`;
      container.appendChild(d);
    });
  }
  updateGradingTotal();
  window._rubrics = state.rubrics ? JSON.parse(JSON.stringify(state.rubrics)) : [];
  renderAttachedRubrics();
}

function fmtTime(d){ return d.getHours().toString().padStart(2,'0')+':'+d.getMinutes().toString().padStart(2,'0')+':'+d.getSeconds().toString().padStart(2,'0'); }

function showDraftBar(text){
  const bar = document.getElementById('draft-bar');
  document.getElementById('draft-bar-text').textContent = text;
  bar.style.display = 'flex';
}

function scheduleDraftSave(){
  clearTimeout(_draftTimer);
  _draftTimer = setTimeout(()=>{
    const state = collectRawFormState();
    localStorage.setItem(DRAFT_KEY, JSON.stringify(state));
    showDraftBar('Draft saved ' + fmtTime(new Date()));
  }, 2000);
}

function clearDraft(){
  localStorage.removeItem(DRAFT_KEY);
  document.getElementById('draft-bar').style.display = 'none';
}

document.getElementById('btn-clear-draft').addEventListener('click', clearDraft);

// Event delegation on the main form for auto-save
document.getElementById('main-form').addEventListener('input', scheduleDraftSave);
document.getElementById('main-form').addEventListener('change', scheduleDraftSave);

// ══════════════════════════════════════════════════════════════
// MY SYLLABI PANEL
// ══════════════════════════════════════════════════════════════
document.getElementById('btn-my-syllabi').addEventListener('click', async function(){
  const overlay = document.getElementById('my-syllabi-overlay');
  const content = document.getElementById('my-syllabi-content');
  content.innerHTML = '<div class="saving-indicator">Loading…</div>';
  overlay.classList.add('show');
  try{
    const resp = await fetch(apiUrl('/api/my-syllabi'));
    if(resp.status === 401){
      content.innerHTML = '<p style="color:#e74c3c;font-size:13px">Session expired. Please <a href="/login" style="color:var(--cyan)">log in again</a> and return to this page.</p>';
      return;
    }
    const list = await resp.json();
    if(!list.length){
      content.innerHTML = '<p style="color:#6b8fa3;font-size:13px;padding:8px 0">No saved syllabi yet. Build and save one first.</p>';
      return;
    }
    content.innerHTML = list.map(s=>{
      const dt = s.updated_at || s.created_at || '';
      const dtFmt = dt ? new Date(dt).toLocaleDateString('en-PH',{month:'short',day:'numeric',year:'numeric'}) : '—';
      return `<div class="syl-list-item">
        <div class="syl-list-meta">
          <div class="syl-list-title">${esc(s.course_title)}</div>
          <div class="syl-list-sub">Rev ${s.revision} &nbsp;·&nbsp; ${dtFmt}${s.revision_comment?' &nbsp;·&nbsp; '+esc(s.revision_comment):''}</div>
        </div>
        <button class="btn-load-edit" onclick="loadSyllabusForEdit('${esc(s.token)}')">Load to Edit</button>
      </div>`;
    }).join('');
  }catch(e){
    content.innerHTML = `<p style="color:#e74c3c;font-size:13px">Error loading syllabi. Please <a href="/login" style="color:var(--cyan)">refresh your session</a>.</p>`;
  }
});

document.getElementById('my-syllabi-close').addEventListener('click',()=>{
  document.getElementById('my-syllabi-overlay').classList.remove('show');
});
document.getElementById('my-syllabi-overlay').addEventListener('click',function(e){
  if(e.target===this) this.classList.remove('show');
});

// ══════════════════════════════════════════════════════════════
// EDIT MODE
// ══════════════════════════════════════════════════════════════
let editToken = null, editRevision = 0, editUpdatedAt = '';

async function loadSyllabusForEdit(token){
  document.getElementById('my-syllabi-overlay').classList.remove('show');
  try{
    const resp = await fetch(apiUrl('/api/load-syllabus/'+token));
    if(resp.status === 401){ showToast('Session expired — please log in again.'); return; }
    if(!resp.ok){ showToast('Could not load syllabus'); return; }
    const data = await resp.json();
    const s = data.syllabus;

    // Map structured JSON back to raw form state
    const state = {
      institutionType: s.institution_type || 'college',
      schoolName:      s.school_name || '',
      collegeDept:     s.college_dept || '',
      program:         s.program || '',
      courseCode:      s.course_code || '',
      courseTitle:     s.course_title || '',
      credits:         s.credits || '',
      prerequisites:   s.prerequisites || '',
      courseType:      s.course_type || 'Core',
      numWeeks:        String((s.course_plan||[]).length || 14),
      semester:        s.semester || '',
      courseDesc:      s.course_description || '',
      programOutcomes: (s.program_outcomes||[]).map(p=>p.description||'').join('\n'),
      courseOutcomes:  (s.course_outcomes||[]).map(c=>c.description||'').join('\n'),
      weeks:           (s.course_plan||[]).map(w=>({
        topics: w.topics||'', ilos: w.ilos||'', tlas: w.tlas||'',
        ats: w.assessment_tasks||'', eval: w.evaluation_strategies||'',
        res: w.resources||'', due: w.due_date||'',
      })),
      grading:         (s.grading_system||[]).map(g=>({comp:g.component||'',wt:String(g.weight||0)})),
      refBooks:        (s.references?.books||[]).join('\n'),
      refWebsites:     (s.references?.websites||[]).join('\n'),
    };

    restoreFormState(state);
    window._rubrics = s.rubrics ? JSON.parse(JSON.stringify(s.rubrics)) : [];
    renderAttachedRubrics();
    editToken = data.token;
    editRevision = data.revision || 1;
    editUpdatedAt = data.updated_at || '';

    // Show edit banner
    const dtFmt = editUpdatedAt ? new Date(editUpdatedAt).toLocaleDateString('en-PH',{month:'short',day:'numeric',year:'numeric'}) : '';
    document.getElementById('edit-rev-label').textContent = 'Rev ' + editRevision;
    document.getElementById('edit-updated-label').textContent = dtFmt ? 'Updated ' + dtFmt : '';
    document.getElementById('edit-banner').style.display = 'flex';

    // Scroll to top
    window.scrollTo({top:0,behavior:'smooth'});
    showToast('Syllabus loaded for editing');
  }catch(e){
    showToast('Error loading syllabus: '+e.message);
  }
}

// ── Update Syllabus ────────────────────────────────────────────────────────
document.getElementById('btn-update').addEventListener('click', async function(){
  if(!editToken) return;
  const comment = document.getElementById('rev-comment').value.trim();
  const s = buildSyllabusFromForm();
  const orig = this.textContent;
  this.textContent = 'Saving…'; this.disabled = true;
  try{
    const resp = await fetch(apiUrl('/api/update-syllabus/'+editToken),{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({syllabus: s, comment: comment})
    });
    if(resp.status === 401){ showToast('Session expired — please log in again.'); this.textContent=orig; this.disabled=false; return; }
    const data = await resp.json();
    if(data.error){ showToast('Error: '+data.error); this.textContent=orig; this.disabled=false; return; }

    clearDraft();
    editRevision = data.revision;
    document.getElementById('edit-rev-label').textContent = 'Rev ' + editRevision;
    document.getElementById('edit-updated-label').textContent = 'Updated ' + new Date().toLocaleDateString('en-PH',{month:'short',day:'numeric',year:'numeric'});

    // Show share modal with revision info
    const overlay = document.getElementById('modal-overlay');
    const content = document.getElementById('modal-content');
    const url = data.url;
    content.innerHTML = `
      <div class="modal-section">
        <label>Revision ${data.revision} saved</label>
        <div class="modal-url-row">
          <input type="text" id="share-url-input" value="${esc(url)}" readonly>
          <button class="modal-btn cyan" id="copy-btn">Copy</button>
        </div>
      </div>
      <div class="modal-note">Revision ${data.revision} has been saved. The link is unchanged — share the same URL.</div>`;
    overlay.classList.add('show');
    document.getElementById('copy-btn').onclick=()=>{
      navigator.clipboard.writeText(url).then(()=>showToast('Link copied!'));
      document.getElementById('copy-btn').textContent='Copied!';
      setTimeout(()=>document.getElementById('copy-btn').textContent='Copy',2000);
    };
  }catch(e){
    showToast('Error: '+e.message);
  }
  this.textContent = orig; this.disabled = false;
});

// "Save as New Copy" resets edit mode and falls through to normal save
document.getElementById('btn-save-copy').addEventListener('click', function(){
  editToken = null; editRevision = 0; editUpdatedAt = '';
  document.getElementById('edit-banner').style.display = 'none';
  document.getElementById('rev-comment-wrap').style.display = 'none';
  document.getElementById('btn-share').style.display = '';
  document.getElementById('btn-share').click();
});

// ── Init ──────────────────────────────────────────────────────────────────
generateWeekRows(14);
updateGradingTotal();

// Restore draft on load (skip if ?load= param present — edit mode takes priority)
(function(){
  const params = new URLSearchParams(window.location.search);
  if(params.get('load')) return; // will load syllabus for edit below
  const raw = localStorage.getItem(DRAFT_KEY);
  if(!raw) return;
  try{
    const state = JSON.parse(raw);
    restoreFormState(state);
    const dtFmt = state.savedAt ? fmtTime(new Date(state.savedAt)) : '';
    showDraftBar('Draft restored · saved at ' + dtFmt);
    document.getElementById('btn-clear-draft').style.display = 'inline';
  }catch(e){ localStorage.removeItem(DRAFT_KEY); }
})();

// Auto-load syllabus for editing when navigated with ?load=TOKEN
(function(){
  const params = new URLSearchParams(window.location.search);
  const loadToken = params.get('load');
  if(loadToken && AUTH_TOKEN){ loadSyllabusForEdit(loadToken); }
})();

// ══════════════════════════════════════════════════════════════
// RUBRIC MAKER
// ══════════════════════════════════════════════════════════════
window._rubrics = [];
let _editingRubricIdx = -1;

function defaultLevels(){
  return [
    {label:'Excellent',  score:4},
    {label:'Proficient', score:3},
    {label:'Developing', score:2},
    {label:'Beginning',  score:1},
  ];
}

function renderAttachedRubrics(){
  const el = document.getElementById('rubric-attached-list');
  if(!window._rubrics.length){
    el.innerHTML = '<p style="font-size:12px;color:var(--grey);margin-bottom:10px;">No rubrics attached yet.</p>';
    return;
  }
  el.innerHTML = window._rubrics.map((r,i)=>`
    <div class="rubric-item">
      <div class="rubric-item-info">
        <div class="rubric-item-name">${esc(r.name)}</div>
        <div class="rubric-item-meta">${r.criteria?r.criteria.length:0} criteria &nbsp;·&nbsp; ${r.levels?r.levels.length:0} levels</div>
      </div>
      <div class="rubric-item-btns">
        <button class="btn-rub-edit" onclick="openRubricBuilder(${i})">Edit</button>
        <button class="btn-rub-remove" onclick="removeRubric(${i})">Remove</button>
      </div>
    </div>`).join('');
}

function removeRubric(idx){
  window._rubrics.splice(idx,1);
  renderAttachedRubrics();
  scheduleDraftSave();
}

function renderBuilderLevels(levels){
  const row = document.getElementById('rub-levels-row');
  row.innerHTML = levels.map((lv,i)=>`
    <div class="rub-level-chip" data-idx="${i}">
      <input class="level-label" type="text" value="${esc(lv.label)}" placeholder="Level name" oninput="updateCriterionHeaders()">
      <span class="sep">/</span>
      <input class="score-inp" type="number" value="${lv.score}" placeholder="pts" min="0" max="99">
      <button class="rub-chip-del" onclick="removeLevel(${i})">&#10005;</button>
    </div>`).join('');
}

function removeLevel(idx){
  const chips = document.querySelectorAll('#rub-levels-row .rub-level-chip');
  chips[idx].remove();
  // Remove descriptor textarea for that level from each criterion
  document.querySelectorAll('#rub-criteria-list .rub-criterion').forEach(crit=>{
    const cells = crit.querySelectorAll('.rub-desc-cell');
    if(cells[idx]) cells[idx].remove();
  });
  // Re-index chip delete buttons
  document.querySelectorAll('#rub-levels-row .rub-level-chip').forEach((chip,i)=>{
    chip.dataset.idx = i;
    chip.querySelector('.rub-chip-del').setAttribute('onclick','removeLevel('+i+')');
  });
  updateCriterionHeaders();
}

function updateCriterionHeaders(){
  const labels = currentLevelLabels();
  document.querySelectorAll('#rub-criteria-list .rub-criterion').forEach(crit=>{
    const cells = crit.querySelectorAll('.rub-desc-cell label');
    labels.forEach((lbl,i)=>{ if(cells[i]) cells[i].textContent = lbl; });
  });
}

function currentLevelLabels(){
  return Array.from(document.querySelectorAll('#rub-levels-row .level-label')).map(inp=>inp.value||'Level');
}

function addCriterionRow(criterion){
  const idx = document.querySelectorAll('#rub-criteria-list .rub-criterion').length;
  const labels = currentLevelLabels();
  const descs = criterion ? (criterion.descriptors||[]) : [];
  const descCells = labels.map((lbl,i)=>`
    <div class="rub-desc-cell">
      <label>${esc(lbl)}</label>
      <textarea placeholder="Describe performance at this level…">${esc(descs[i]||'')}</textarea>
    </div>`).join('');

  const div = document.createElement('div');
  div.className = 'rub-criterion open';
  div.innerHTML = `
    <div class="rub-crit-hdr" onclick="this.closest('.rub-criterion').classList.toggle('open')">
      <div class="rub-crit-hdr-info">
        <span class="rub-crit-title">${criterion?esc(criterion.name):'New Criterion'}</span>
        <span class="rub-crit-wt">${criterion&&criterion.weight?criterion.weight+'%':''}</span>
      </div>
      <span class="rub-crit-chevron">&#9660;</span>
      <button class="btn-rub-del-crit" onclick="event.stopPropagation();this.closest('.rub-criterion').remove()">&#10005;</button>
    </div>
    <div class="rub-crit-body">
      <div class="rub-crit-fields">
        <input type="text" class="crit-name-inp" placeholder="Criterion name" value="${criterion?esc(criterion.name):''}"
          oninput="this.closest('.rub-criterion').querySelector('.rub-crit-title').textContent=this.value||'New Criterion'">
        <input type="number" class="crit-wt-inp" placeholder="Weight %" min="0" max="100" value="${criterion&&criterion.weight?criterion.weight:''}"
          oninput="this.closest('.rub-criterion').querySelector('.rub-crit-wt').textContent=this.value?this.value+'%':''">
      </div>
      <div class="rub-desc-label">Performance Descriptors</div>
      <div class="rub-desc-grid" style="grid-template-columns:repeat(${labels.length},1fr);">${descCells}</div>
    </div>`;
  document.getElementById('rub-criteria-list').appendChild(div);
}

function collectRubricFromBuilder(){
  const name = (document.getElementById('rub-name').value||'').trim();
  if(!name) return null;
  const description = (document.getElementById('rub-desc').value||'').trim();
  const levels = Array.from(document.querySelectorAll('#rub-levels-row .rub-level-chip')).map(chip=>({
    label: chip.querySelector('.level-label').value.trim()||'Level',
    score: parseFloat(chip.querySelector('.score-inp').value)||0,
  }));
  const criteria = Array.from(document.querySelectorAll('#rub-criteria-list .rub-criterion')).map(crit=>({
    name: (crit.querySelector('.crit-name-inp').value||'').trim(),
    weight: parseFloat(crit.querySelector('.crit-wt-inp').value)||0,
    descriptors: Array.from(crit.querySelectorAll('.rub-desc-cell textarea')).map(ta=>ta.value.trim()),
  }));
  return {name, description, levels, criteria};
}

function openRubricBuilder(editIdx){
  _editingRubricIdx = (editIdx !== undefined) ? editIdx : -1;
  const title = document.getElementById('rub-builder-title');
  const nameInp = document.getElementById('rub-name');
  const descInp = document.getElementById('rub-desc');
  document.getElementById('rub-criteria-list').innerHTML = '';

  if(_editingRubricIdx >= 0){
    const r = window._rubrics[_editingRubricIdx];
    title.textContent = 'Edit Rubric';
    nameInp.value = r.name||'';
    descInp.value = r.description||'';
    renderBuilderLevels(r.levels||defaultLevels());
    (r.criteria||[]).forEach(c=>addCriterionRow(c));
  } else {
    title.textContent = 'Create New Rubric';
    nameInp.value = '';
    descInp.value = '';
    renderBuilderLevels(defaultLevels());
    addCriterionRow();
  }
  document.getElementById('rub-builder-overlay').classList.add('show');
}

document.getElementById('rub-builder-close').addEventListener('click',()=>{
  document.getElementById('rub-builder-overlay').classList.remove('show');
});
document.getElementById('btn-rub-builder-cancel').addEventListener('click',()=>{
  document.getElementById('rub-builder-overlay').classList.remove('show');
});
document.getElementById('rub-builder-overlay').addEventListener('click',function(e){
  if(e.target===this) this.classList.remove('show');
});

document.getElementById('btn-add-level').addEventListener('click',()=>{
  const chips = document.querySelectorAll('#rub-levels-row .rub-level-chip');
  const newIdx = chips.length;
  const chip = document.createElement('div');
  chip.className = 'rub-level-chip';
  chip.dataset.idx = newIdx;
  chip.innerHTML = `
    <input class="level-label" type="text" value="Level ${newIdx+1}" placeholder="Level name" oninput="updateCriterionHeaders()">
    <span class="sep">/</span>
    <input class="score-inp" type="number" value="${newIdx+1}" placeholder="pts" min="0" max="99">
    <button class="rub-chip-del" onclick="removeLevel(${newIdx})">&#10005;</button>`;
  document.getElementById('rub-levels-row').appendChild(chip);
  // Add a new descriptor column to each criterion
  const label = 'Level '+(newIdx+1);
  document.querySelectorAll('#rub-criteria-list .rub-criterion').forEach(crit=>{
    const grid = crit.querySelector('.rub-desc-grid');
    const colCount = grid.querySelectorAll('.rub-desc-cell').length + 1;
    grid.style.gridTemplateColumns = `repeat(${colCount},1fr)`;
    const cell = document.createElement('div');
    cell.className = 'rub-desc-cell';
    cell.innerHTML = `<label>${esc(label)}</label><textarea placeholder="Describe performance at this level…"></textarea>`;
    grid.appendChild(cell);
  });
});

document.getElementById('btn-add-criterion').addEventListener('click',()=>addCriterionRow());

document.getElementById('btn-rub-builder-save').addEventListener('click', async function(){
  const rub = collectRubricFromBuilder();
  if(!rub){ showToast('Please enter a rubric name.'); return; }

  const orig = this.textContent;
  this.textContent = 'Saving…'; this.disabled = true;

  if(document.getElementById('rub-save-lib').checked){
    try{
      const resp = await fetch(apiUrl('/api/rubrics'),{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({rubric: rub})
      });
      if(resp.ok){
        const data = await resp.json();
        rub.token = data.token;
      }
    }catch(e){ /* non-fatal — still attach locally */ }
  }

  if(_editingRubricIdx >= 0){
    window._rubrics[_editingRubricIdx] = rub;
  } else {
    window._rubrics.push(rub);
  }
  renderAttachedRubrics();
  scheduleDraftSave();
  document.getElementById('rub-builder-overlay').classList.remove('show');
  showToast(_editingRubricIdx >= 0 ? 'Rubric updated.' : 'Rubric added to syllabus.');
  this.textContent = orig; this.disabled = false;
});

document.getElementById('btn-rub-create').addEventListener('click',()=>openRubricBuilder());
document.getElementById('btn-rub-library').addEventListener('click',()=>openRubricLibrary());

async function openRubricLibrary(){
  const overlay = document.getElementById('rub-library-overlay');
  const content = document.getElementById('rub-lib-content');
  content.innerHTML = '<div class="saving-indicator">Loading library…</div>';
  overlay.classList.add('show');
  try{
    const resp = await fetch(apiUrl('/api/rubrics'));
    if(!resp.ok) throw new Error('Failed');
    const list = await resp.json();
    if(!list.length){
      content.innerHTML = '<p style="font-size:12px;color:var(--grey);padding:8px 0">No rubrics in the library yet. Create one and check "Save to Library".</p>';
      return;
    }
    content.innerHTML = list.map(r=>`
      <div class="rub-lib-item">
        <div class="rub-lib-info">
          <div class="rub-lib-name">${esc(r.name)}</div>
          <div class="rub-lib-meta">${esc(r.owner_name||'Unknown')} &nbsp;·&nbsp; ${r.criteria_count} criteria &nbsp;·&nbsp; ${r.level_count} levels${r.description?' &nbsp;·&nbsp; '+esc(r.description):''}</div>
        </div>
        <button class="btn-use-rubric" onclick="useRubricFromLib('${esc(r.token)}')">Use</button>
      </div>`).join('');
  }catch(e){
    content.innerHTML = '<p style="color:#e74c3c;font-size:12px">Error loading library.</p>';
  }
}

document.getElementById('rub-lib-close').addEventListener('click',()=>{
  document.getElementById('rub-library-overlay').classList.remove('show');
});
document.getElementById('rub-library-overlay').addEventListener('click',function(e){
  if(e.target===this) this.classList.remove('show');
});

window.useRubricFromLib = async function(token){
  // Check for duplicate
  if(window._rubrics.some(r=>r.token===token)){
    showToast('This rubric is already attached.'); return;
  }
  try{
    const resp = await fetch(apiUrl('/api/rubrics/'+token));
    if(!resp.ok) throw new Error('Not found');
    const data = await resp.json();
    const rub = data.rubric;
    rub.token = data.token;
    window._rubrics.push(rub);
    renderAttachedRubrics();
    scheduleDraftSave();
    document.getElementById('rub-library-overlay').classList.remove('show');
    showToast('Rubric "'+esc(data.name)+'" added to syllabus.');
  }catch(e){
    showToast('Error loading rubric.');
  }
};

function renderRubrics(s){
  if(!s.rubrics||!s.rubrics.length) return '';
  let html = '<div class="syl-sec-hdr">Assessment Rubrics</div>';
  s.rubrics.forEach(rub=>{
    const levels = rub.levels||[];
    const criteria = rub.criteria||[];
    const levelHeaders = levels.map(lv=>`<th>${esc(lv.label)}${lv.score!=null?' ('+lv.score+')':''}</th>`).join('');
    const rows = criteria.map(cr=>{
      const descs = (cr.descriptors||[]).map(d=>`<td>${esc(d)}</td>`).join('');
      return `<tr><td class="crit-name">${esc(cr.name)}</td><td class="crit-wt">${cr.weight?cr.weight+'%':''}</td>${descs}</tr>`;
    }).join('');
    html += `<div class="syl-rubric-wrap">
      <div class="syl-rubric-name">${esc(rub.name)}</div>
      ${rub.description?`<div class="syl-rubric-desc">${esc(rub.description)}</div>`:''}
      <table class="syl-rubric-table">
        <thead><tr><th>Criteria</th><th>Weight</th>${levelHeaders}</tr></thead>
        <tbody>${rows}</tbody>
      </table>
    </div>`;
  });
  return html;
}

// Init
renderAttachedRubrics();
</script>
</body>
</html>
